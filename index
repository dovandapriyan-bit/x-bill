<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BILL | Billing System ISP</title>
    
    <!-- CSS & JS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* ========== RESET & VARIABLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #00b894;
            --danger: #ff6b6b;
            --warning: #fdcb6e;
            --info: #54a0ff;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --radius: 15px;
            --radius-sm: 10px;
        }
        
        body {
            background: #f5f7fb;
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== TOAST ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 350px;
        }
        
        .toast {
            background: white;
            border-radius: var(--radius-sm);
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-lg);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-success .toast-icon { color: var(--success); }
        .toast-error .toast-icon { color: var(--danger); }
        .toast-warning .toast-icon { color: var(--warning); }
        .toast-info .toast-icon { color: var(--info); }
        
        .toast-body {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--gray);
        }
        
        /* ========== LOGIN PAGE ========== */
        #loginPage {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .login-header {
            background: var(--primary);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .login-header i {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .app-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .app-tagline {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .login-footer {
            padding: 20px;
            text-align: center;
            background: var(--light);
            border-top: 1px solid var(--gray-light);
            font-size: 13px;
            color: var(--gray);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #00a085;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ee5a52;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-warning:hover {
            background: #f9c74f;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background: #2e86de;
            transform: translateY(-2px);
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* ========== APP CONTAINER ========== */
        #appContainer {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f7fb;
        }
        
        /* ========== TOP NAVBAR ========== */
        .top-navbar {
            background: white;
            padding: 15px 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .navbar-brand i {
            font-size: 24px;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: var(--light);
            border: 1px solid var(--gray-light);
            padding: 8px 15px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        /* ========== BOTTOM NAVIGATION ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            color: var(--gray);
            text-decoration: none;
            border-radius: var(--radius-sm);
            transition: all 0.3s;
            min-width: 70px;
            cursor: pointer;
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-item.active {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .nav-item:hover {
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            padding: 25px;
            padding-bottom: 80px;
            overflow-y: auto;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== PAGE HEADER ========== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title i {
            color: var(--primary);
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .stat-icon.primary { background: var(--primary); }
        .stat-icon.success { background: var(--success); }
        .stat-icon.info { background: var(--info); }
        .stat-icon.danger { background: var(--danger); }
        .stat-icon.warning { background: var(--warning); }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* ========== CARDS ========== */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 18px;
            color: var(--dark);
        }
        
        .card-body {
            padding: 25px;
        }
        
        /* ========== TABLES ========== */
        .table-responsive {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: var(--light);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--gray-light);
        }
        
        .table td {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
            vertical-align: middle;
        }
        
        .table tr:hover {
            background: rgba(67, 97, 238, 0.02);
        }
        
        /* ========== BADGES ========== */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(0, 184, 148, 0.1);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger);
        }
        
        .badge-warning {
            background: rgba(253, 203, 110, 0.1);
            color: #e67e22;
        }
        
        .badge-info {
            background: rgba(84, 160, 255, 0.1);
            color: var(--info);
        }
        
        .badge-primary {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        /* ========== BUTTONS ========== */
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 5px;
        }
        
        .btn-outline {
            background: white;
            border: 2px solid var(--gray-light);
            color: var(--dark);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        /* ========== FILTERS ========== */
        .filters-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* ========== MODALS ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease;
        }
        
        .modal-lg {
            max-width: 700px;
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* ========== FORM STYLES ========== */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-check-input {
            width: 18px;
            height: 18px;
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        /* ========== CHARTS ========== */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 992px) {
            .charts-container {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        .chart-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 18px;
        }
        
        /* ========== QUICK ACTIONS ========== */
        .quick-actions {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .quick-actions h3 {
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }
        
        .page-link {
            padding: 8px 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .page-link:hover,
        .page-link.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
                padding-bottom: 80px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .top-navbar {
                padding: 12px 15px;
            }
            
            .navbar-brand span {
                display: none;
            }
            
            .bottom-nav span {
                font-size: 11px;
            }
            
            .nav-item {
                padding: 8px 10px;
                min-width: 60px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
        }
        
        /* ========== PACKAGE CARD ========== */
        .package-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .package-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .package-card h4 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .package-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .package-features {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .package-features li {
            padding: 5px 0;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .package-features i {
            color: var(--success);
        }
        
        /* ========== EMAIL TEMPLATE ========== */
        .email-template {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .email-header {
            border-bottom: 2px solid var(--gray-light);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .email-content {
            min-height: 200px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        /* ========== BACKUP STATUS ========== */
        .backup-status {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }

        /* ========== SETTING PAGE STYLES ========== */
.setting-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
    display: flex;
    gap: 15px;
    align-items: center;
}

.setting-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
}

.setting-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    flex-shrink: 0;
}

.setting-content {
    flex: 1;
}

.setting-content h3 {
    margin: 0 0 5px 0;
    color: var(--dark);
    font-size: 18px;
}

.setting-content p {
    margin: 0;
    color: var(--gray);
    font-size: 14px;
    line-height: 1.4;
}

.setting-badge {
    display: inline-block;
    background: var(--light);
    color: var(--primary);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    margin-top: 8px;
}

.quick-setting {
    background: var(--light);
    padding: 15px;
    border-radius: var(--radius-sm);
    min-width: 200px;
}

.status-item {
    background: var(--light);
    padding: 15px;
    border-radius: var(--radius-sm);
}

.status-label {
    font-size: 12px;
    color: var(--gray);
    margin-bottom: 5px;
}

.status-value {
    font-weight: 600;
    font-size: 16px;
}
    </style>
</head>
<body>
    <!-- LOADING OVERLAY -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- LOGIN PAGE -->
    <div id="loginPage">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-file-invoice-dollar"></i>
                <div class="app-name">X-BILL ISP</div>
                <div class="app-tagline">Billing Management System</div>
            </div>
            
            <div class="login-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="loginUsername" 
                               placeholder="Masukkan username" required
                               value="admin">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" 
                               placeholder="Masukkan password" required
                               value="admin123">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="login-footer">
                <p>Username: admin | Password: admin123</p>
            </div>
        </div>
    </div>

    <!-- ========== MODAL SETTING KOMPLIT ========== -->

<!-- MODAL 1: PROFIL PERUSAHAAN -->
<div class="modal-overlay hidden" id="modalCompanyProfile">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-building"></i> Profil Perusahaan</h3>
            <button class="modal-close" onclick="hideModal('modalCompanyProfile')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formCompanyProfile">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Perusahaan *</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>Tagline / Slogan</label>
                        <input type="text" class="form-control" id="companyTagline">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Alamat Lengkap *</label>
                        <textarea class="form-control" id="companyAddress" rows="2" required></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telepon Kantor *</label>
                        <input type="text" class="form-control" id="companyPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Email Perusahaan</label>
                        <input type="email" class="form-control" id="companyEmail">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" class="form-control" id="companyWebsite">
                    </div>
                    <div class="form-group">
                        <label>NPWP</label>
                        <input type="text" class="form-control" id="companyNPWP">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Direktur/Pemilik</label>
                        <input type="text" class="form-control" id="companyDirector">
                    </div>
                    <div class="form-group">
                        <label>Jenis Usaha</label>
                        <select class="form-control" id="companyType">
                            <option value="isp">ISP / Internet Provider</option>
                            <option value="wifi">Wifi Management</option>
                            <option value="it">IT Services</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-file-invoice"></i> Informasi Invoice</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prefix Invoice</label>
                                <input type="text" class="form-control" id="invoicePrefix" value="INV">
                            </div>
                            <div class="form-group">
                                <label>Footer Invoice</label>
                                <textarea class="form-control" id="invoiceFooter" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Terms & Conditions</label>
                                <textarea class="form-control" id="invoiceTerms" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalCompanyProfile')">Batal</button>
            <button class="btn btn-primary" onclick="saveCompanyProfile()">
                <i class="fas fa-save"></i> Simpan Profil
            </button>
        </div>
    </div>
</div>

<!-- MODAL 2: BRANDING & LOGO -->
<div class="modal-overlay hidden" id="modalBranding">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-palette"></i> Logo & Branding</h3>
            <button class="modal-close" onclick="hideModal('modalBranding')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formBranding">
                <!-- LOGO UPLOAD -->
                <div class="form-group text-center" style="margin-bottom: 30px;">
                    <label>Logo Perusahaan</label>
                    <div style="border: 2px dashed var(--gray-light); border-radius: 15px; padding: 30px; margin-top: 10px; cursor: pointer;" 
                         onclick="document.getElementById('logoUpload').click()" id="logoDropzone">
                        <div id="logoPreview" style="width: 150px; height: 150px; margin: 0 auto; 
                             background: var(--light); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-building" style="font-size: 48px; color: var(--gray);"></i>
                        </div>
                        <p class="mt-3" style="color: var(--gray);">Klik untuk upload logo</p>
                        <small class="text-muted">Rekomendasi: 500x500px, PNG/JPG, maks 2MB</small>
                    </div>
                    <input type="file" id="logoUpload" accept="image/*" style="display: none;" 
                           onchange="previewLogo(this)">
                </div>
                
                <!-- COLOR SCHEME -->
                <div class="form-group">
                    <label>Warna Utama</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="color" class="form-control" id="primaryColor" value="#4361ee" style="flex: 1;">
                        <input type="color" class="form-control" id="secondaryColor" value="#7209b7" style="flex: 1;">
                    </div>
                </div>
                
                <!-- FAVICON -->
                <div class="form-group">
                    <label>Favicon</label>
                    <input type="file" class="form-control" id="faviconUpload" accept=".ico,image/*">
                    <small class="text-muted">File .ico atau PNG 32x32px</small>
                </div>
                
                <!-- THEME OPTIONS -->
                <div class="form-group">
                    <label>Tema Dashboard</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="dashboardTheme" id="themeLight" value="light" checked>
                        <label class="form-check-label" for="themeLight">Light Mode</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="dashboardTheme" id="themeDark" value="dark">
                        <label class="form-check-label" for="themeDark">Dark Mode</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="dashboardTheme" id="themeAuto" value="auto">
                        <label class="form-check-label" for="themeAuto">Auto (ikuti sistem)</label>
                    </div>
                </div>
                
                <!-- FONT SETTINGS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Font Utama</label>
                        <select class="form-control" id="mainFont">
                            <option value="'Segoe UI', system-ui">Segoe UI (Default)</option>
                            <option value="'Poppins', sans-serif">Poppins</option>
                            <option value="'Inter', sans-serif">Inter</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Font Size</label>
                        <select class="form-control" id="fontSize">
                            <option value="14px">Kecil (14px)</option>
                            <option value="16px" selected>Normal (16px)</option>
                            <option value="18px">Besar (18px)</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalBranding')">Batal</button>
            <button class="btn btn-primary" onclick="saveBranding()">
                <i class="fas fa-paint-brush"></i> Terapkan Branding
            </button>
        </div>
    </div>
</div>

<!-- MODAL 3: KONTAK & NOTIFIKASI -->
<div class="modal-overlay hidden" id="modalContactSettings">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-phone-alt"></i> Kontak & Notifikasi</h3>
            <button class="modal-close" onclick="hideModal('modalContactSettings')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formContactSettings">
                <!-- WHATSAPP SETTINGS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp Business</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nomor WhatsApp Pengirim *</label>
                                <input type="text" class="form-control" id="whatsappNumber" 
                                       placeholder="6281234567890" required>
                                <small class="text-muted">Format: 6281234567890 (tanpa +)</small>
                            </div>
                            <div class="form-group">
                                <label>WhatsApp API Key</label>
                                <input type="password" class="form-control" id="whatsappApiKey" 
                                       placeholder="Masukkan API key jika ada">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableWhatsApp" checked>
                            <label class="form-check-label">Aktifkan pengiriman otomatis via WhatsApp</label>
                        </div>
                    </div>
                </div>
                
                <!-- EMAIL SETTINGS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope"></i> Email Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>SMTP Host</label>
                                <input type="text" class="form-control" id="smtpHost" 
                                       placeholder="smtp.gmail.com">
                            </div>
                            <div class="form-group">
                                <label>SMTP Port</label>
                                <input type="number" class="form-control" id="smtpPort" 
                                       placeholder="587" value="587">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email Pengirim</label>
                                <input type="email" class="form-control" id="smtpEmail" 
                                       placeholder="admin@perusahaan.com">
                            </div>
                            <div class="form-group">
                                <label>Password/App Password</label>
                                <input type="password" class="form-control" id="smtpPassword">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableSSL">
                            <label class="form-check-label">Gunakan SSL/TLS</label>
                        </div>
                    </div>
                </div>
                
                <!-- SMS GATEWAY -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-sms"></i> SMS Gateway</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Provider SMS</label>
                            <select class="form-control" id="smsProvider">
                                <option value="">-- Pilih Provider --</option>
                                <option value="zenziva">Zenziva</option>
                                <option value="nexmo">Nexmo (Vonage)</option>
                                <option value="twilio">Twilio</option>
                                <option value="custom">Custom API</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" class="form-control" id="smsApiKey">
                            </div>
                            <div class="form-group">
                                <label>Secret Key</label>
                                <input type="password" class="form-control" id="smsSecret">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableSMS">
                            <label class="form-check-label">Aktifkan pengiriman SMS</label>
                        </div>
                    </div>
                </div>
                
                <!-- NOTIFICATION SETTINGS -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bell"></i> Pengaturan Notifikasi</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Notifikasi untuk Admin</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifNewCustomer" checked>
                                <label class="form-check-label">Pelanggan baru mendaftar</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifPayment" checked>
                                <label class="form-check-label">Pembayaran diterima</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifOverdue" checked>
                                <label class="form-check-label">Tagihan overdue</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Jadwal Reminder Otomatis</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminder3Days">
                                <label class="form-check-label">3 hari sebelum jatuh tempo</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminder1Day">
                                <label class="form-check-label">1 hari sebelum jatuh tempo</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminderOverdue">
                                <label class="form-check-label">Setelah jatuh tempo</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalContactSettings')">Batal</button>
            <button class="btn btn-success" onclick="testNotification()">
                <i class="fas fa-paper-plane"></i> Test Notifikasi
            </button>
            <button class="btn btn-primary" onclick="saveContactSettings()">
                <i class="fas fa-save"></i> Simpan Settings
            </button>
        </div>
    </div>
</div>

<!-- MODAL 4: GANTI PASSWORD -->
<div class="modal-overlay hidden" id="modalChangePassword">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-key"></i> Ganti Password</h3>
            <button class="modal-close" onclick="hideModal('modalChangePassword')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formChangePassword">
                <div class="form-group">
                    <label>Password Saat Ini *</label>
                    <input type="password" class="form-control" id="currentPassword" required>
                </div>
                
                <div class="form-group">
                    <label>Password Baru *</label>
                    <input type="password" class="form-control" id="newPassword" required>
                    <div class="password-strength" style="margin-top: 5px;">
                        <div class="strength-bar">
                            <div class="strength-fill" id="passwordStrength"></div>
                        </div>
                        <small id="passwordTips" class="text-muted"></small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Konfirmasi Password Baru *</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                    <div id="passwordMatch" style="display: none; color: var(--success); margin-top: 5px;">
                        <i class="fas fa-check-circle"></i> Password cocok
                    </div>
                    <div id="passwordMismatch" style="display: none; color: var(--danger); margin-top: 5px;">
                        <i class="fas fa-times-circle"></i> Password tidak cocok
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Tips Password Aman:</h6>
                    <ul style="margin-bottom: 0; font-size: 13px;">
                        <li>Minimal 8 karakter</li>
                        <li>Kombinasi huruf besar & kecil</li>
                        <li>Minimal 1 angka dan 1 simbol</li>
                        <li>Jangan gunakan password yang mudah ditebak</li>
                    </ul>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalChangePassword')">Batal</button>
            <button class="btn btn-primary" onclick="changePassword()">
                <i class="fas fa-key"></i> Ganti Password
            </button>
        </div>
    </div>
</div>

<!-- MODAL 5: PROFIL USER -->
<div class="modal-overlay hidden" id="modalUserProfile">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user"></i> Profil Saya</h3>
            <button class="modal-close" onclick="hideModal('modalUserProfile')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formUserProfile">
                <div class="text-center mb-4">
                    <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--gradient); 
                          margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; 
                          color: white; font-size: 36px; cursor: pointer;" 
                          onclick="document.getElementById('userPhotoUpload').click()" id="userPhotoPreview">
                        <span id="userInitials">A</span>
                        <img id="userPhotoImg" src="" style="width: 100%; height: 100%; border-radius: 50%; display: none;">
                    </div>
                    <input type="file" id="userPhotoUpload" accept="image/*" style="display: none;" 
                           onchange="uploadUserPhoto(this)">
                    <small class="text-muted">Klik untuk ganti foto profil</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" class="form-control" id="userFullName" required>
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" class="form-control" id="userUsername" required readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="userEmail">
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="text" class="form-control" id="userPhone">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Alamat</label>
                    <textarea class="form-control" id="userAddress" rows="2"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" class="form-control" id="userRoleInput" readonly>
                    </div>
                    <div class="form-group">
                        <label>Bergabung Sejak</label>
                        <input type="text" class="form-control" id="userJoinDate" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Bio/Signature</label>
                    <textarea class="form-control" id="userBio" rows="2" 
                              placeholder="Tulis bio atau signature untuk invoice..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalUserProfile')">Batal</button>
            <button class="btn btn-primary" onclick="saveUserProfile()">
                <i class="fas fa-save"></i> Simpan Profil
            </button>
        </div>
    </div>
</div>

<!-- MODAL 6: TEMPLATE PESAN -->
<div class="modal-overlay hidden" id="modalMessageTemplates">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-comment-alt"></i> Template Pesan</h3>
            <button class="modal-close" onclick="hideModal('modalMessageTemplates')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-variables"></i> Variabel yang Tersedia</h5>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <span class="badge badge-info">[nama_pelanggan]</span>
                        <span class="badge badge-info">[nama_perusahaan]</span>
                        <span class="badge badge-info">[bulan_tagihan]</span>
                        <span class="badge badge-info">[jumlah_tagihan]</span>
                        <span class="badge badge-info">[jatuh_tempo]</span>
                        <span class="badge badge-info">[invoice_number]</span>
                        <span class="badge badge-info">[link_pembayaran]</span>
                        <span class="badge badge-info">[no_telepon_admin]</span>
                        <span class="badge badge-info">[alamat_perusahaan]</span>
                        <span class="badge badge-info">[website_perusahaan]</span>
                    </div>
                </div>
            </div>
            
            <!-- TEMPLATE REMINDER -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-bell"></i> Template Reminder Tagihan</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Reminder 3 Hari Sebelum Jatuh Tempo</label>
                        <textarea class="form-control" id="templateReminder3Days" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] akan jatuh tempo pada [jatuh_tempo].
Silakan lakukan pembayaran sebelum jatuh tempo.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Reminder 1 Hari Sebelum Jatuh Tempo</label>
                        <textarea class="form-control" id="templateReminder1Day" rows="3">
Yth. [nama_pelanggan],
Besok adalah jatuh tempo tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan].
Segera lakukan pembayaran untuk menghindari denda.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Peringatan Telat Bayar</label>
                        <textarea class="form-control" id="templateOverdue" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] TELAT BAYAR.
Silakan segera lakukan pembayaran untuk menghindari pemutusan layanan.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                </div>
            </div>

            
            <!-- TEMPLATE KONFIRMASI -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-check-circle"></i> Template Konfirmasi</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Konfirmasi Pembayaran Diterima</label>
                        <textarea class="form-control" id="templatePaymentConfirmed" rows="3">
Yth. [nama_pelanggan],
Pembayaran tagihan [invoice_number] sebesar [jumlah_tagihan] telah kami terima.
Terima kasih telah melakukan pembayaran tepat waktu.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Notifikasi Tagihan Baru</label>
                        <textarea class="form-control" id="templateNewInvoice" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] telah tersedia.
Jatuh tempo: [jatuh_tempo]
Link pembayaran: [link_pembayaran]
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalMessageTemplates')">Batal</button>
            <button class="btn btn-primary" onclick="saveMessageTemplates()">
                <i class="fas fa-save"></i> Simpan Template
            </button>
        </div>
    </div>
</div>

<!-- ========== MODAL SETTING KOMPLIT ========== -->

<!-- MODAL 7: KEUANGAN & PAJAK -->
<div class="modal-overlay hidden" id="modalFinancialSettings">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-coins"></i> Keuangan & Pajak</h3>
            <button class="modal-close" onclick="hideModal('modalFinancialSettings')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formFinancialSettings">
                <!-- PAJAK -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-percentage"></i> Pajak</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>PPN (%)</label>
                                <input type="number" class="form-control" id="ppnPercentage" 
                                       min="0" max="100" step="0.01" value="11">
                            </div>
                            <div class="form-group">
                                <label>PPh (%)</label>
                                <input type="number" class="form-control" id="pphPercentage" 
                                       min="0" max="100" step="0.01" value="0.5">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableTax" checked>
                            <label class="form-check-label">Aktifkan perhitungan pajak otomatis</label>
                        </div>
                    </div>
                </div>

                <!-- DENDA -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Denda Keterlambatan</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Denda per Hari (%)</label>
                                <input type="number" class="form-control" id="dendaPerHari" 
                                       min="0" max="10" step="0.01" value="0.5">
                            </div>
                            <div class="form-group">
                                <label>Maksimal Denda (%)</label>
                                <input type="number" class="form-control" id="maxDenda" 
                                       min="0" max="100" step="0.01" value="10">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Grace Period (hari)</label>
                                <input type="number" class="form-control" id="gracePeriod" 
                                       min="0" max="30" value="3">
                            </div>
                            <div class="form-group">
                                <label>Mulai Denda Setelah (hari)</label>
                                <input type="number" class="form-control" id="startDendaAfter" 
                                       min="1" max="30" value="7">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MATA UANG & PEMBULATAN -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-money-bill-wave"></i> Mata Uang & Pembulatan</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Mata Uang</label>
                                <select class="form-control" id="currency">
                                    <option value="IDR" selected>Rupiah (IDR)</option>
                                    <option value="USD">Dollar (USD)</option>
                                    <option value="EUR">Euro (EUR)</option>
                                    <option value="SGD">Dollar Singapura (SGD)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Simbol Mata Uang</label>
                                <input type="text" class="form-control" id="currencySymbol" 
                                       value="Rp" maxlength="5">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pembulatan ke</label>
                                <select class="form-control" id="rounding">
                                    <option value="1">1 (Tidak dibulatkan)</option>
                                    <option value="100" selected>100 (Ratusan)</option>
                                    <option value="500">500 (Lima ratusan)</option>
                                    <option value="1000">1000 (Ribuan)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Format Desimal</label>
                                <select class="form-control" id="decimalFormat">
                                    <option value="0" selected>0 desimal (1.234)</option>
                                    <option value="2">2 desimal (1.234,56)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PELAPORAN -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-invoice"></i> Pelaporan</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tahun Fiskal Dimulai</label>
                                <select class="form-control" id="fiscalYearStart">
                                    <option value="1">Januari</option>
                                    <option value="4">April</option>
                                    <option value="7">Juli</option>
                                    <option value="10" selected>Oktober</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Batas Laporan Bulanan (tgl)</label>
                                <input type="number" class="form-control" id="reportDeadline" 
                                       min="1" max="31" value="5">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="autoGenerateReport" checked>
                            <label class="form-check-label">Generate laporan bulanan otomatis</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalFinancialSettings')">Batal</button>
            <button class="btn btn-primary" onclick="saveFinancialSettings()">
                <i class="fas fa-save"></i> Simpan Pengaturan
            </button>
        </div>
    </div>
</div>

<!-- MODAL 8: KEAMANAN & AKSES -->
<div class="modal-overlay hidden" id="modalSecuritySettings">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-shield-alt"></i> Keamanan & Akses</h3>
            <button class="modal-close" onclick="hideModal('modalSecuritySettings')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formSecuritySettings">
                <!-- PENGATURAN LOGIN -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-sign-in-alt"></i> Keamanan Login</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Maksimal Attempt Login</label>
                                <input type="number" class="form-control" id="maxLoginAttempts" 
                                       min="1" max="10" value="3">
                            </div>
                            <div class="form-group">
                                <label>Lockout Duration (menit)</label>
                                <input type="number" class="form-control" id="lockoutDuration" 
                                       min="1" max="1440" value="15">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Session Timeout (menit)</label>
                                <input type="number" class="form-control" id="sessionTimeout" 
                                       min="5" max="480" value="30">
                            </div>
                            <div class="form-group">
                                <label>Force Logout After (jam)</label>
                                <input type="number" class="form-control" id="forceLogoutHours" 
                                       min="1" max="24" value="8">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="requireStrongPassword" checked>
                            <label class="form-check-label">Wajib password kuat (minimal 8 karakter, huruf besar, angka)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enable2FA">
                            <label class="form-check-label">Aktifkan Two-Factor Authentication (2FA)</label>
                        </div>
                    </div>
                </div>

                <!-- IP SECURITY -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-network-wired"></i> IP Security</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>IP Whitelist</label>
                            <textarea class="form-control" id="ipWhitelist" rows="3" 
                                      placeholder="Masukkan IP yang diizinkan, pisahkan dengan koma
Contoh: 192.168.1.1, 10.0.0.1, 127.0.0.1"></textarea>
                            <small class="text-muted">Kosongkan untuk mengizinkan semua IP</small>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableIPRestriction">
                            <label class="form-check-label">Aktifkan pembatasan IP</label>
                        </div>
                    </div>
                </div>

                <!-- AUDIT LOG -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-list"></i> Audit Log</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Simpan Log Selama (hari)</label>
                                <input type="number" class="form-control" id="logRetentionDays" 
                                       min="1" max="365" value="90">
                            </div>
                            <div class="form-group">
                                <label>Backup Log Otomatis</label>
                                <select class="form-control" id="logBackupFrequency">
                                    <option value="daily">Harian</option>
                                    <option value="weekly" selected>Mingguan</option>
                                    <option value="monthly">Bulanan</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="logLoginAttempts" checked>
                            <label class="form-check-label">Log semua attempt login</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="logDataChanges" checked>
                            <label class="form-check-label">Log semua perubahan data</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="logExports" checked>
                            <label class="form-check-label">Log aktivitas export data</label>
                        </div>
                    </div>
                </div>

                <!-- USER ROLES & PERMISSIONS -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user-tag"></i> Roles & Permissions</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Default Role untuk User Baru</label>
                            <select class="form-control" id="defaultUserRole">
                                <option value="viewer">Viewer (Hanya lihat)</option>
                                <option value="operator" selected>Operator (Tambah/Edit data)</option>
                                <option value="admin">Admin (Full access)</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="allowMultipleSessions">
                            <label class="form-check-label">Izinkan multiple session untuk user yang sama</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="notifyNewLogin" checked>
                            <label class="form-check-label">Notifikasi saat ada login dari device baru</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalSecuritySettings')">Batal</button>
            <button class="btn btn-primary" onclick="saveSecuritySettings()">
                <i class="fas fa-save"></i> Simpan Pengaturan
            </button>
        </div>
    </div>
</div>

<!-- MODAL 9: SYSTEM SETTINGS -->
<div class="modal-overlay hidden" id="modalSystemSettings">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-cogs"></i> System Settings</h3>
            <button class="modal-close" onclick="hideModal('modalSystemSettings')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formSystemSettings">
                <!-- TIMEZONE & WAKTU -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Timezone & Waktu</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Timezone</label>
                                <select class="form-control" id="systemTimezone">
                                    <option value="Asia/Jakarta" selected>Asia/Jakarta (WIB)</option>
                                    <option value="Asia/Makassar">Asia/Makassar (WITA)</option>
                                    <option value="Asia/Jayapura">Asia/Jayapura (WIT)</option>
                                    <option value="UTC">UTC</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Format Waktu</label>
                                <select class="form-control" id="timeFormat">
                                    <option value="24" selected>24 jam (14:30)</option>
                                    <option value="12">12 jam (2:30 PM)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Format Tanggal</label>
                                <select class="form-control" id="dateFormat">
                                    <option value="DD/MM/YYYY" selected>DD/MM/YYYY (31/12/2024)</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY (12/31/2024)</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD (2024-12-31)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Bahasa</label>
                                <select class="form-control" id="systemLanguage">
                                    <option value="id" selected>Bahasa Indonesia</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PERFORMANCE -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-tachometer-alt"></i> Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Auto-refresh Dashboard (detik)</label>
                                <input type="number" class="form-control" id="autoRefreshInterval" 
                                       min="10" max="3600" value="60">
                                <small class="text-muted">0 untuk nonaktif</small>
                            </div>
                            <div class="form-group">
                                <label>Items per Page</label>
                                <input type="number" class="form-control" id="itemsPerPage" 
                                       min="5" max="100" value="10">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cache Duration (menit)</label>
                                <input type="number" class="form-control" id="cacheDuration" 
                                       min="0" max="1440" value="5">
                            </div>
                            <div class="form-group">
                                <label>Max Upload Size (MB)</label>
                                <input type="number" class="form-control" id="maxUploadSize" 
                                       min="1" max="100" value="10">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableLazyLoading" checked>
                            <label class="form-check-label">Aktifkan lazy loading untuk tabel besar</label>
                        </div>
                    </div>
                </div>

                <!-- NOTIFICATIONS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-bell"></i> Notifikasi Sistem</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Tipe Notifikasi yang Ditampilkan</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifSuccess" checked>
                                <label class="form-check-label">Success</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifError" checked>
                                <label class="form-check-label">Error</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifWarning" checked>
                                <label class="form-check-label">Warning</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifInfo">
                                <label class="form-check-label">Info</label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Durasi Toast (detik)</label>
                                <input type="number" class="form-control" id="toastDuration" 
                                       min="1" max="10" value="4">
                            </div>
                            <div class="form-group">
                                <label>Posisi Toast</label>
                                <select class="form-control" id="toastPosition">
                                    <option value="top-right" selected>Atas Kanan</option>
                                    <option value="top-left">Atas Kiri</option>
                                    <option value="bottom-right">Bawah Kanan</option>
                                    <option value="bottom-left">Bawah Kiri</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MAINTENANCE -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tools"></i> Maintenance</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Jadwal Auto-Backup</label>
                            <select class="form-control" id="autoBackupSchedule">
                                <option value="disabled">Nonaktif</option>
                                <option value="daily" selected>Harian (00:00)</option>
                                <option value="weekly">Mingguan (Minggu 00:00)</option>
                                <option value="monthly">Bulanan (Tanggal 1, 00:00)</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Retensi Backup (hari)</label>
                                <input type="number" class="form-control" id="backupRetentionDays" 
                                       min="1" max="365" value="30">
                            </div>
                            <div class="form-group">
                                <label>Cleanup Logs Setelah (hari)</label>
                                <input type="number" class="form-control" id="logCleanupDays" 
                                       min="1" max="365" value="90">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableMaintenanceMode">
                            <label class="form-check-label">Aktifkan mode maintenance</label>
                        </div>
                        <div class="alert alert-warning" style="margin-top: 15px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Peringatan:</strong> Mode maintenance akan menonaktifkan akses user biasa
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalSystemSettings')">Batal</button>
            <button class="btn btn-warning" onclick="clearSystemCache()">
                <i class="fas fa-broom"></i> Clear Cache
            </button>
            <button class="btn btn-primary" onclick="saveSystemSettings()">
                <i class="fas fa-save"></i> Simpan Pengaturan
            </button>
        </div>
    </div>
</div>

<!-- MODAL 10: BACKUP & RESTORE -->
<div class="modal-overlay hidden" id="modalBackupSettings">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-database"></i> Backup & Restore</h3>
            <button class="modal-close" onclick="hideModal('modalBackupSettings')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formBackupSettings">
                <!-- BACKUP SCHEDULE -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-alt"></i> Jadwal Backup Otomatis</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Frekuensi Backup</label>
                                <select class="form-control" id="backupFrequency">
                                    <option value="disabled">Tidak Aktif</option>
                                    <option value="daily" selected>Harian</option>
                                    <option value="weekly">Mingguan</option>
                                    <option value="monthly">Bulanan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Waktu Backup</label>
                                <input type="time" class="form-control" id="backupTime" value="02:00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Hari Backup (untuk mingguan)</label>
                                <select class="form-control" id="backupDay" disabled>
                                    <option value="0">Minggu</option>
                                    <option value="1">Senin</option>
                                    <option value="2" selected>Selasa</option>
                                    <option value="3">Rabu</option>
                                    <option value="4">Kamis</option>
                                    <option value="5">Jumat</option>
                                    <option value="6">Sabtu</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tanggal Backup (untuk bulanan)</label>
                                <input type="number" class="form-control" id="backupDate" min="1" max="28" value="1" disabled>
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableAutoBackup" checked>
                            <label class="form-check-label">Aktifkan backup otomatis</label>
                        </div>
                    </div>
                </div>

                <!-- BACKUP CONTENT -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-archive"></i> Konten Backup</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Data yang di-backup:</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backupPelanggan" checked>
                                <label class="form-check-label">Data Pelanggan</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backupPaket" checked>
                                <label class="form-check-label">Data Paket</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backupTagihan" checked>
                                <label class="form-check-label">Data Tagihan</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backupTunggakan" checked>
                                <label class="form-check-label">Data Tunggakan</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backupSettings" checked>
                                <label class="form-check-label">Pengaturan Sistem</label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Format Backup</label>
                                <select class="form-control" id="backupFormat">
                                    <option value="json" selected>JSON</option>
                                    <option value="csv">CSV</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Enkripsi Backup</label>
                                <select class="form-control" id="backupEncryption">
                                    <option value="none">Tidak dienkripsi</option>
                                    <option value="aes128">AES-128</option>
                                    <option value="aes256">AES-256</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BACKUP HISTORY -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Riwayat Backup</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" style="font-size: 13px;">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Tipe</th>
                                        <th>Ukuran</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="backupHistoryTable">
                                    <!-- Data backup history akan diisi -->
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info" style="margin-top: 15px;">
                            <i class="fas fa-info-circle"></i>
                            Backup terakhir: <span id="lastBackupTime">Tidak ada</span> | 
                            Total backup: <span id="totalBackupCount">0</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalBackupSettings')">Batal</button>
            <button class="btn btn-warning" onclick="createBackupNow()">
                <i class="fas fa-plus"></i> Backup Sekarang
            </button>
            <button class="btn btn-primary" onclick="saveBackupSettings()">
                <i class="fas fa-save"></i> Simpan Pengaturan
            </button>
        </div>
    </div>
</div>
        
        <!-- MAIN CONTENT -->
        <div class="main-content" id="mainContent">
            <!-- Pages will be dynamically loaded here -->
        </div>
        
        <!-- BOTTOM NAVIGATION -->
        <div class="bottom-nav">
            <a href="#dashboard" class="nav-item active" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#pelanggan" class="nav-item" data-page="pelanggan">
                <i class="fas fa-users"></i>
                <span>Pelanggan</span>
            </a>
            <a href="#paket" class="nav-item" data-page="paket">
                <i class="fas fa-wifi"></i>
                <span>Paket</span>
            </a>
            <a href="#tagihan" class="nav-item" data-page="tagihan">
                <i class="fas fa-receipt"></i>
                <span>Tagihan</span>
            </a>
            <a href="#tunggakan" class="nav-item" data-page="tunggakan">
                <i class="fas fa-clock"></i>
                <span>Tunggakan</span>
            </a>
            <a href="#setting" class="nav-item" data-page="setting">
                 <i class="fas fa-cog"></i>
                <span>Setting</span>
            </a>
            </a>
            <a href="#laporan" class="nav-item" data-page="laporan">
                <i class="fas fa-chart-bar"></i>
                <span>Laporan</span>
            </a>
        </div>
    </div>
    
    <!-- ========== MODALS ========== -->
    
   <!-- MODAL: TAMBAH/EDIT PELANGGAN (REVISED) -->
<div class="modal-overlay hidden" id="modalPelanggan">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Data Pelanggan</h3>
            <button class="modal-close" onclick="forceCloseModal('modalPelanggan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPelanggan">
                <!-- BARIS 1: NAMA & TELEPON -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="pelangganNama" placeholder="Nama Pelanggan" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telepon *</label>
                        <input type="text" class="form-control" id="pelangganTelepon" placeholder="08xxxxxxxxxx" required>
                    </div>
                </div>
                
                <!-- BARIS 2: PAKET & HARGA -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Paket *</label>
                        <select class="form-control" id="pelangganPaket" required>
                            <option value="">-- Pilih Paket --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Harga *</label>
                        <input type="number" class="form-control" id="pelangganHarga" placeholder="0" required>
                    </div>
                </div>

                <!-- BARIS 3: TANGGAL PASANG & STATUS -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tanggal Pasang *</label>
                        <input type="date" class="form-control" id="pelangganTanggalPasang" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-control" id="pelangganStatus" required>
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                            <option value="tunggak">Tunggak</option>
                        </select>
                    </div>
                </div>

                <!-- BARIS 4: ALAMAT (FULL WIDTH) -->
                <div class="form-group">
                    <label class="form-label">Alamat *</label>
                    <textarea class="form-control" id="pelangganAlamat" rows="2" placeholder="Alamat Lengkap" required></textarea>
                </div>

                <!-- BARIS 5: KOORDINAT (FULL WIDTH + TOMBOL RAPI) -->
                <div class="form-group">
                    <label class="form-label">Koordinat GPS</label>
                    <div style="display: flex; gap: 10px; align-items: stretch;">
                        <input type="text" class="form-control" id="pelangganKoordinat" 
                               placeholder="Contoh: -6.2088, 106.8456" readonly 
                               style="background: #f8f9fa; color: #495057;">
                        
                        <button type="button" class="btn btn-info" onclick="getLocation()" 
                                style="display: flex; align-items: center; justify-content: center; min-width: 120px;">
                            <i class="fas fa-crosshairs" style="margin-right: 5px;"></i> Set Lokasi
                        </button>
                    </div>
                </div>
                
                <!-- BARIS 6: CATATAN (FULL WIDTH) -->
                <div class="form-group">
                    <label class="form-label">Catatan</label>
                    <textarea class="form-control" id="pelangganCatatan" rows="2"></textarea>
                </div>
                
                <input type="hidden" id="pelangganId">
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="forceCloseModal('modalPelanggan')">Batal</button>
            <button type="button" class="btn btn-primary" onclick="savePelanggan()">
                <i class="fas fa-save"></i> Simpan Data
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: TAMBAH/EDIT PAKET -->
    <div class="modal-overlay hidden" id="modalPaket">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Paket</h3>
                <button class="modal-close" onclick="hideModal('modalPaket')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formPaket">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Paket *</label>
                            <input type="text" class="form-control" id="paketNama" placeholder="Contoh: 10 Mbps" required>
                        </div>
                        <div class="form-group">
                            <label>Kecepatan *</label>
                            <input type="text" class="form-control" id="paketKecepatan" placeholder="Contoh: 10 Mbps" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Harga Bulanan *</label>
                            <input type="number" class="form-control" id="paketHarga" required>
                        </div>
                        <div class="form-group">
                            <label>Kuota</label>
                            <input type="text" class="form-control" id="paketKuota" placeholder="Contoh: Unlimited">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <textarea class="form-control" id="paketDeskripsi" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Fitur</label>
                        <textarea class="form-control" id="paketFitur" rows="3" placeholder="Pisahkan dengan koma"></textarea>
                        <small class="text-muted">Contoh: Unlimited Bandwidth, 24/7 Support, Free Router</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Warna</label>
                            <input type="color" class="form-control" id="paketWarna" value="#4361ee">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="paketStatus">
                                <option value="aktif">Aktif</option>
                                <option value="nonaktif">Nonaktif</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="paketId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalPaket')">Batal</button>
                <button class="btn btn-primary" onclick="savePaket()">Simpan Paket</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: KALKULATOR PRORATA -->
    <div class="modal-overlay hidden" id="modalProrata">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-calculator"></i> Kalkulator Prorata</h3>
                <button class="modal-close" onclick="hideModal('modalProrata')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formProrata">
                    <div class="form-group">
                        <label>Biaya Bulanan (Rp)</label>
                        <input type="number" class="form-control" id="prorataBiaya" value="150000">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tanggal Mulai</label>
                            <input type="date" class="form-control" id="prorataMulai">
                        </div>
                        <div class="form-group">
                            <label>Tanggal Akhir</label>
                            <input type="date" class="form-control" id="prorataAkhir">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah Hari</label>
                        <input type="number" class="form-control" id="prorataHari" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Hasil Perhitungan:</label>
                        <div class="form-control" style="background: #f8f9fa; font-weight: bold; font-size: 18px;" id="prorataHasil">
                            Rp 0
                        </div>
                    </div>
                    
                    <div class="alert" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>Rumus:</strong> (Biaya Bulanan  30)  Jumlah Hari
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalProrata')">Tutup</button>
                <button class="btn btn-primary" onclick="hitungProrata()">
                    <i class="fas fa-calculator"></i> Hitung Prorata
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: GENERATE TAGIHAN ARREARS (YANG BENAR) -->
<div class="modal-overlay hidden" id="modalGenerateTagihan">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-bolt"></i> Generate Tagihan ARREARS</h3>
            <button class="modal-close" onclick="forceCloseModal('modalGenerateTagihan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formGenerateTagihan">
                <!-- TIMELINE ARREARS EXPLANATION -->
                <div class="alert alert-info" style="background: #e7f3ff; border-left: 4px solid #4361ee; padding: 15px; margin-bottom: 20px;">
                    <h5 style="color: #4361ee; margin-top: 0;">
                        <i class="fas fa-calendar-alt"></i> Timeline Sistem ARREARS
                    </h5>
                    <p style="margin-bottom: 5px;">
                        <strong>Pilih bulan untuk GENERATE tagihan:</strong>
                    </p>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 14px;">
                        <div style="color: var(--primary); font-weight: bold;">Jan 2025</div>
                        <div> Generate tagihan untuk <strong>Desember 2024</strong> (pemakaian bulan sebelumnya)</div>
                        <div style="color: var(--success); font-weight: bold;">Jatuh Tempo</div>
                        <div> 10 Februari 2025 (bulan BERIKUTNYA setelah pemakaian)</div>
                    </div>
                    <hr style="margin: 10px 0;">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Sistem <strong>ARREARS</strong>: Tagihan untuk pemakaian bulan SEBELUMNYA, 
                        jatuh tempo di bulan BERIKUTNYA. Contoh: Pakai di Desember, bayar di Januari.
                    </small>
                </div>
                
                <!-- INPUT FIELDS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Bulan Generate *</label>
                        <input type="month" class="form-control" id="generateBulan" 
                               value="<?php echo date('Y-m'); ?>" 
                               onchange="updateArrearsTimeline()" required>
                        <small class="text-muted">Bulan saat generate tagihan</small>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Jatuh Tempo (tgl) *</label>
                        <input type="number" class="form-control" id="generateJatuhTempo" 
                               min="1" max="31" value="10" required>
                        <small class="text-muted">Tanggal jatuh tempo di bulan berikutnya</small>
                    </div>
                </div>
                
                <!-- TIMELINE PREVIEW -->
                <div id="arrearsTimelinePreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h5><i class="fas fa-project-diagram"></i> Timeline Tagihan ARREARS:</h5>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <div style="text-align: center;">
                            <div style="background: #4361ee; color: white; padding: 10px; border-radius: 8px; min-width: 120px;">
                                <strong id="previewBulanPemakaian">Des 2024</strong>
                                <div style="font-size: 12px;">Pemakaian</div>
                            </div>
                            <div style="margin-top: 5px; font-size: 12px;">Bulan Sebelumnya</div>
                        </div>
                        
                        <div style="flex: 1; text-align: center;">
                            <i class="fas fa-arrow-right" style="color: var(--gray);"></i>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: #00b894; color: white; padding: 10px; border-radius: 8px; min-width: 120px;">
                                <strong id="previewBulanGenerate">Jan 2025</strong>
                                <div style="font-size: 12px;">Generate Tagihan</div>
                            </div>
                            <div style="margin-top: 5px; font-size: 12px;">Awal Bulan</div>
                        </div>
                        
                        <div style="flex: 1; text-align: center;">
                            <i class="fas fa-arrow-right" style="color: var(--gray);"></i>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: #ff6b6b; color: white; padding: 10px; border-radius: 8px; min-width: 120px;">
                                <strong id="previewJatuhTempo">10 Feb 2025</strong>
                                <div style="font-size: 12px;">Jatuh Tempo</div>
                            </div>
                            <div style="margin-top: 5px; font-size: 12px;">Bulan Berikutnya</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-size: 14px;">
                        <i class="fas fa-calculator"></i> 
                        <strong>Perhitungan:</strong>
                        <span id="previewPelangganCount">0</span> pelanggan aktif  
                        <span id="previewHargaRata">Rp 150.000</span> = 
                        <strong id="previewTotalEstimasi">Rp 0</strong>
                    </div>
                </div>
                
                <!-- SECTION TUNGGAKAN -->
                <div class="card" style="margin-top: 20px; margin-bottom: 20px;">
                    <div class="card-header" style="background: #fff3cd; border-color: #ffeaa7;">
                        <h4 style="color: #856404; margin: 0;">
                            <i class="fas fa-exclamation-triangle"></i> Filter Pelanggan
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- FILTER TUNGGAKAN -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filter Tunggakan</label>
                                <select class="form-control" id="filterTunggakan" onchange="toggleTunggakanFilter()">
                                    <option value="all">Generate untuk semua pelanggan</option>
                                    <option value="exclude_tunggakan">Exclude pelanggan dengan tunggakan</option>
                                    <option value="only_tunggakan">Generate hanya untuk yang punya tunggakan</option>
                                    <option value="exclude_berat">Exclude tunggakan berat (>60 hari)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Kategori Tunggakan</label>
                                <select class="form-control" id="kategoriTunggakan" disabled>
                                    <option value="all">Semua Kategori</option>
                                    <option value="ringan">Ringan (1-30 hari)</option>
                                    <option value="sedang">Sedang (31-60 hari)</option>
                                    <option value="berat">Berat (>60 hari)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- TAMPILKAN DATA TUNGGAKAN -->
                        <div id="tunggakanDataSection" style="display: none; margin-top: 15px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                                <h5 style="margin-bottom: 10px; color: var(--danger);">
                                    <i class="fas fa-list"></i> Daftar Pelanggan dengan Tunggakan
                                </h5>
                                <table style="width: 100%; font-size: 12px;">
                                    <thead style="background: #e9ecef;">
                                        <tr>
                                            <th style="padding: 8px;">Pelanggan</th>
                                            <th style="padding: 8px;">Tunggakan</th>
                                            <th style="padding: 8px;">Hari</th>
                                            <th style="padding: 8px;">Kategori</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tunggakanList">
                                        <!-- Data tunggakan akan diisi di sini -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- SUMMARIES -->
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <div style="background: #e7f3ff; padding: 10px; border-radius: 6px;">
                                    <small><strong>Total Pelanggan Aktif:</strong></small>
                                    <div id="summaryTotalAktif" style="font-size: 18px; font-weight: bold; color: var(--primary);">0</div>
                                </div>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <div style="background: #ffeaa7; padding: 10px; border-radius: 6px;">
                                    <small><strong>Pelanggan dengan Tunggakan:</strong></small>
                                    <div id="summaryTunggakan" style="font-size: 18px; font-weight: bold; color: var(--warning);">0</div>
                                </div>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <div style="background: #ffcccc; padding: 10px; border-radius: 6px;">
                                    <small><strong>Total Tunggakan:</strong></small>
                                    <div id="summaryTotalTunggakan" style="font-size: 18px; font-weight: bold; color: var(--danger);">Rp 0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- OPTIONS -->
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="generateProrata" checked>
                    <label class="form-check-label">
                        <strong>Include perhitungan prorata otomatis</strong>
                        <small class="text-muted">(Untuk pelanggan baru di bulan pemakaian)</small>
                    </label>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="generateEmail">
                    <label class="form-check-label">Kirim email pemberitahuan ke pelanggan</label>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="generateWhatsapp">
                    <label class="form-check-label">Kirim notifikasi WhatsApp</label>
                </div>
                
                <!-- SUMMARY GENERATE -->
                <div id="generateSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h5><i class="fas fa-calculator"></i> Rincian Generate ARREARS:</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div>
                            <p><strong>Bulan Pemakaian:</strong> 
                               <span id="summaryBulanPemakaian" style="color: var(--primary); font-weight: bold;">-</span>
                            </p>
                            <p><strong>Jumlah Tagihan:</strong> 
                               <span id="summaryJumlahTagihan" style="color: var(--primary); font-weight: bold;">0</span>
                            </p>
                            <p><strong>Estimasi Total:</strong> 
                               <span id="summaryEstimasiTotal" style="color: var(--success); font-weight: bold;">Rp 0</span>
                            </p>
                        </div>
                        <div>
                            <p><strong>Bulan Jatuh Tempo:</strong> 
                               <span id="summaryBulanJatuhTempo" style="color: var(--danger); font-weight: bold;">-</span>
                            </p>
                            <p><strong>Estimasi Waktu:</strong> 
                               <span id="summaryWaktu" style="font-weight: bold;">~5 detik</span>
                            </p>
                            <p><strong>Denda Termasuk:</strong> 
                               <span id="summaryDenda" style="color: var(--danger); font-weight: bold;">Rp 0</span>
                            </p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="forceCloseModal('modalGenerateTagihan')">Batal</button>
            <button type="button" class="btn btn-info" onclick="loadTunggakanDataForModal()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button type="button" class="btn btn-primary" onclick="generateTagihanBulk()">
                <i class="fas fa-bolt"></i> Generate Tagihan ARREARS
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: BAYAR TAGIHAN -->
    <!-- MODAL: BAYAR TAGIHAN (REVISI LENGKAP) -->
<div class="modal-overlay hidden" id="modalBayarTagihan">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> Pembayaran Tagihan</h3>
            <button class="modal-close" onclick="hideModal('modalBayarTagihan')">&times;</button>
        </div>
        <div class="modal-body">
            <!-- INFO PELANGGAN -->
            <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                <div class="card-body">
                    <h5><i class="fas fa-user"></i> Data Pelanggan</h5>
                    <table style="width: 100%; font-size: 14px;">
                        <tr><td><strong>Nama:</strong></td><td id="bayarPelangganNama">-</td></tr>
                        <tr><td><strong>Telepon:</strong></td><td id="bayarPelangganTelepon">-</td></tr>
                        <tr><td><strong>Paket:</strong></td><td id="bayarPelangganPaket">-</td></tr>
                        <tr><td><strong>Alamat:</strong></td><td id="bayarPelangganAlamat">-</td></tr>
                    </table>
                </div>
            </div>
            
            <!-- DAFTAR TAGIHAN & TUNGGAKAN -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-receipt"></i> Rincian Pembayaran</h5>
                    <button class="btn btn-sm btn-outline" onclick="checkAllTagihan()">
                        <i class="fas fa-check-square"></i> Pilih Semua
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table" style="font-size: 14px;">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkAll" onclick="toggleCheckAll()"></th>
                                    <th>Invoice</th>
                                    <th>Bulan</th>
                                    <th>Jumlah</th>
                                    <th>Status</th>
                                    <th>Denda</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="listTagihanBayar">
                                <!-- Data akan diisi -->
                                <tr>
                                    <td colspan="7" class="text-center">Memuat data tagihan...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- SUMMARY -->
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div>
                                <strong>Total Tagihan:</strong> <span id="summaryTotalTagihan">Rp 0</span>
                            </div>
                            <div>
                                <strong>Total Denda:</strong> <span id="summaryTotalDenda">Rp 0</span>
                            </div>
                            <div>
                                <strong>Jumlah Terpilih:</strong> <span id="summaryJumlahTerpilih">0 tagihan</span>
                            </div>
                            <div>
                                <strong>Total Terpilih:</strong> <span id="totalTerpilih" style="font-size: 18px; font-weight: bold; color: var(--primary);">Rp 0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- OPSI BAYAR -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Opsi Pembayaran</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Mode Pembayaran</label>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="modeBayar" 
                                   id="modePenuh" value="penuh" checked 
                                   onchange="updateModeBayar()">
                            <label class="form-check-label" for="modePenuh">
                                <strong>Bayar Penuh</strong> (semua tagihan terpilih)
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="modeBayar" 
                                   id="modeSebagian" value="sebagian"
                                   onchange="updateModeBayar()">
                            <label class="form-check-label" for="modeSebagian">
                                <strong>Bayar Sebagian</strong> (tentukan jumlah)
                            </label>
                        </div>
                    </div>
                    
                    <!-- INPUT JUMLAH BAYAR -->
                    <div id="inputSebagian" style="display: none; margin-top: 15px;">
                        <div class="form-group">
                            <label>Jumlah Bayar (Rp)</label>
                            <input type="number" class="form-control" id="jumlahBayarSebagian" 
                                   min="10000" step="1000" oninput="updateSisaPembayaran()"
                                   placeholder="Masukkan jumlah pembayaran">
                        </div>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; font-size: 14px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <strong>Total Harus Bayar:</strong><br>
                                    <span id="totalHarusBayar">Rp 0</span>
                                </div>
                                <div>
                                    <strong>Sisa:</strong><br>
                                    <span id="sisaPembayaran">Rp 0</span>
                                </div>
                                <div>
                                    <strong>Kekurangan:</strong><br>
                                    <span id="kekuranganPembayaran" style="color: #ff6b6b; font-weight: bold;">Rp 0</span>
                                </div>
                                <div>
                                    <strong>Status:</strong><br>
                                    <span id="statusPembayaran">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- BUKTI TRANSFER & METODE -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-credit-card"></i> Metode & Bukti</h5>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Metode Pembayaran *</label>
                            <select class="form-control" id="metodeBayar" required onchange="toggleBuktiTransfer()">
                                <option value="">Pilih Metode</option>
                                <option value="transfer">Transfer Bank</option>
                                <option value="tunai">Tunai</option>
                                <option value="qris">QRIS</option>
                                <option value="gopay">GoPay</option>
                                <option value="ovo">OVO</option>
                                <option value="dana">DANA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tanggal Bayar *</label>
                            <input type="date" class="form-control" id="tanggalBayar" 
                                   value="<?php echo date('Y-m-d'); ?>" required>
                        </div>
                    </div>
                    
                    <!-- UPLOAD BUKTI TRANSFER -->
                    <div id="buktiTransferSection" style="display: none; margin-top: 15px;">
                        <div class="form-group">
                            <label>Bukti Transfer/Struk *</label>
                            <div style="border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; background: #f8f9fa;"
                                 onclick="document.getElementById('fileBuktiBayar').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 36px; color: #4361ee;"></i>
                                <p style="margin: 10px 0; font-weight: 500;">Klik untuk upload bukti pembayaran</p>
                                <small class="text-muted">Format: JPG, PNG, PDF (max 5MB)</small>
                            </div>
                            <input type="file" id="fileBuktiBayar" style="display: none;" 
                                   accept=".jpg,.jpeg,.png,.pdf" onchange="previewBuktiBayar(this)">
                            <div id="previewBuktiBayar" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                    
                    <!-- REFERENSI & CATATAN -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>No. Referensi/Transaksi</label>
                            <input type="text" class="form-control" id="referensiBayar" 
                                   placeholder="Contoh: TRX-001, STRUK-123">
                        </div>
                        <div class="form-group">
                            <label>Catatan Pembayaran</label>
                            <input type="text" class="form-control" id="catatanBayar" 
                                   placeholder="Contoh: Bayar via ATM, tunai kasir, dll">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalBayarTagihan')">Batal</button>
            <button class="btn btn-success" onclick="prosesPembayaran('bayar')">
                <i class="fas fa-check-circle"></i> Konfirmasi Bayar
            </button>
            <button class="btn btn-primary" onclick="prosesPembayaran('cetak')">
                <i class="fas fa-print"></i> Bayar & Cetak
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: KIRIM REMINDER -->
    <div class="modal-overlay hidden" id="modalReminder">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-envelope"></i> Kirim Reminder Tagihan</h3>
                <button class="modal-close" onclick="hideModal('modalReminder')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Pilih Pelanggan</label>
                    <select class="form-control" id="reminderPelanggan" multiple style="height: 150px;">
                        <!-- Pelanggan akan diisi -->
                    </select>
                    <small class="text-muted">Tekan Ctrl untuk memilih multiple</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipe Reminder</label>
                        <select class="form-control" id="reminderType">
                            <option value="email">Email</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="sms">SMS</option>
                            <option value="all">Semua Media</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jadwal Kirim</label>
                        <select class="form-control" id="reminderSchedule">
                            <option value="now">Sekarang</option>
                            <option value="tomorrow">Besok Pagi (08:00)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                
                <div id="customSchedule" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="date" class="form-control" id="reminderDate">
                        </div>
                        <div class="form-group">
                            <label>Jam</label>
                            <input type="time" class="form-control" id="reminderTime">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Template Pesan</label>
                    <select class="form-control" id="reminderTemplate">
                        <option value="standard">Standar</option>
                        <option value="urgent">Mendesak</option>
                        <option value="friendly">Ramah</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Preview Pesan</label>
                    <div class="email-content" id="previewPesan">
                        <p>Yth. [Nama Pelanggan],</p>
                        <p>Tagihan bulan [Bulan] sebesar [Jumlah] jatuh tempo pada [Tanggal Jatuh Tempo].</p>
                        <p>Silakan lakukan pembayaran sebelum jatuh tempo.</p>
                        <p>Terima kasih.</p>
                    </div>
                </div>
                
                <div id="reminderSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Summary:</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Jumlah pelanggan: <span id="summaryPelanggan" style="font-weight: bold;">0</span></li>
                        <li>Media pengiriman: <span id="summaryMedia" style="font-weight: bold;">Email</span></li>
                        <li>Waktu pengiriman: <span id="summaryWaktuReminder" style="font-weight: bold;">Sekarang</span></li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalReminder')">Batal</button>
                <button class="btn btn-primary" onclick="kirimReminder()">
                    <i class="fas fa-paper-plane"></i> Kirim Reminder
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EXPORT LAPORAN -->
    <div class="modal-overlay hidden" id="modalExportLaporan">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-export"></i> Export Laporan</h3>
                <button class="modal-close" onclick="hideModal('modalExportLaporan')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formExportLaporan">
                    <div class="form-group">
                        <label>Tipe Laporan *</label>
                        <select class="form-control" id="exportLaporanType" required>
                            <option value="">Pilih Tipe</option>
                            <option value="keuangan">Laporan Keuangan</option>
                            <option value="pelanggan">Laporan Pelanggan</option>
                            <option value="tagihan">Laporan Tagihan</option>
                            <option value="tunggakan">Laporan Tunggakan</option>
                            <option value="paket">Laporan Paket</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Periode Awal</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="form-group">
                            <label>Periode Akhir</label>
                            <input type="date" class="form-control" id="exportEndDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Format File *</label>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatExcel" value="excel" checked>
                            <label class="form-check-label" for="formatExcel">Excel (.xlsx)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatPDF" value="pdf">
                            <label class="form-check-label" for="formatPDF">PDF (.pdf)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatCSV" value="csv">
                            <label class="form-check-label" for="formatCSV">CSV (.csv)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Include Data</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">Grafik</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeSummary" checked>
                            <label class="form-check-label" for="includeSummary">Ringkasan</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeDetail">
                            <label class="form-check-label" for="includeDetail">Detail Data</label>
                        </div>
                    </div>
                    
                    <div id="exportSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Summary Export:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Tipe: <span id="summaryTipe" style="font-weight: bold;">-</span></li>
                            <li>Format: <span id="summaryFormat" style="font-weight: bold;">Excel</span></li>
                            <li>Estimasi waktu: <span id="summaryEstimasi" style="font-weight: bold;">5 detik</span></li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalExportLaporan')">Batal</button>
                <button class="btn btn-success" onclick="exportLaporan()">
                    <i class="fas fa-download"></i> Download Laporan
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: BACKUP DATA -->
    <div class="modal-overlay hidden" id="modalBackup">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-database"></i> Backup Data</h3>
                <button class="modal-close" onclick="hideModal('modalBackup')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipe Backup</label>
                    <select class="form-control" id="backupType">
                        <option value="full">Full Backup (Semua Data)</option>
                        <option value="pelanggan">Data Pelanggan</option>
                        <option value="tagihan">Data Tagihan</option>
                        <option value="paket">Data Paket</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Format Backup</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupJSON" value="json" checked>
                        <label class="form-check-label" for="backupJSON">JSON</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupCSV" value="csv">
                        <label class="form-check-label" for="backupCSV">CSV</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupExcel" value="excel">
                        <label class="form-check-label" for="backupExcel">Excel</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Enkripsi Data</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="encryptData">
                        <label class="form-check-label" for="encryptData">Enkripsi dengan password</label>
                    </div>
                </div>
                
                <div id="passwordSection" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="form-control" id="backupPassword">
                        </div>
                        <div class="form-group">
                            <label>Konfirmasi Password</label>
                            <input type="password" class="form-control" id="backupPasswordConfirm">
                        </div>
                    </div>
                </div>
                
                <div class="backup-status">
                    <h4>Backup Terakhir:</h4>
                    <div class="backup-item">
                        <span>Full Backup</span>
                        <span>2 hari lalu</span>
                    </div>
                    <div class="backup-item">
                        <span>Data Pelanggan</span>
                        <span>1 minggu lalu</span>
                    </div>
                    <div class="backup-item">
                        <span>Data Tagihan</span>
                        <span>3 hari lalu</span>
                    </div>
                </div>
                
                <div id="backupProgress" style="margin-top: 20px; display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4>Progress Backup:</h4>
                        <div style="background: #e9ecef; height: 10px; border-radius: 5px; margin: 10px 0;">
                            <div id="progressBar" style="background: var(--primary); height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="text-align: center; font-weight: bold;">0%</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalBackup')">Batal</button>
                <button class="btn btn-info" onclick="startBackup()">
                    <i class="fas fa-play"></i> Mulai Backup
                </button>
                <button class="btn btn-success" onclick="restoreBackup()">
                    <i class="fas fa-upload"></i> Restore
                </button>
            </div>
        </div>
    </div>

    <!-- ========== ALL JAVASCRIPT ========== -->
    <script>
        // ============================================
        // CONFIGURATION & INITIALIZATION
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBocAz1byGPHa3ky2Wsj5wQMCtAHdJH48w",
            authDomain: "dnt-network-nota.firebaseapp.com",
            projectId: "dnt-network-nota",
            storageBucket: "dnt-network-nota.firebasestorage.app",
            messagingSenderId: "896578021877",
            appId: "1:896578021877:web:2c882371b4673e7c18d8bc",
            measurementId: "G-NJYGGK0S0H"
        };
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized");
        } catch (error) {
            console.log("Firebase already initialized");
        }
        
        const db = firebase.firestore();
        let currentUser = null;
        let currentPage = 'dashboard';
        let pelangganData = [];
        let paketData = [];
        let tagihanData = [];


        // Tambah di awal script setelah deklarasi variabel lain (line ~96)
let currentPagePelanggan = 1;
let currentPageTagihan = 1;
let currentPageTunggakan = 1;
let currentPagePaket = 1;
const itemsPerPage = 10;
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function showLoading() {
            
        }
        
        function hideLoading() {
            
        }
        
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="toast-body">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function hideModal(modalId) {
    console.log(" Hiding modal:", modalId);
    
    const modalEl = document.getElementById(modalId);
    if (!modalEl) {
        console.error(" Modal tidak ditemukan:", modalId);
        return;
    }
    
    // Gunakan forceCloseModal untuk konsistensi
    forceCloseModal(modalId);
}

// Fungsi pagination umum (tambah setelah fungsi utility)
function renderPagination(totalItems, currentPage, pageType, containerId) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (totalPages <= 1) return '';
    
    let paginationHtml = '<div class="pagination">';
    
    // Previous button
    if (currentPage > 1) {
        paginationHtml += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage - 1})">&laquo;</a>`;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHtml += `<a class="page-link active">${i}</a>`;
        } else {
            paginationHtml += `<a class="page-link" onclick="changePage('${pageType}', ${i})">${i}</a>`;
        }
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHtml += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage + 1})">&raquo;</a>`;
    }
    
    paginationHtml += '</div>';
    
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = paginationHtml;
    }
    
    return paginationHtml;

    const timelineArrears = `
    <small class="text-muted" style="display: block; margin-top: 5px;">
        <i class="fas fa-calendar"></i> 
        Pemakaian: ${tagihan.bulan} | 
        Jatuh tempo: ${moment(tagihan.tanggal_jatuh_tempo).format('DD/MM/YY')}
    </small>
`;
}

async function autoGenerateTagihanArrears() {
    console.log(" Cek auto-generate tagihan arrears...");
    
    // Cek jika tanggal 1-3 di awal bulan
    const today = moment();
    if (today.date() > 3) {
        console.log(" Bukan awal bulan (tanggal 1-3), skip auto-generate");
        return;
    }
    
    try {
        // Tentukan bulan tagihan (bulan sebelumnya)
        const bulanKemarin = today.subtract(1, 'month').format('YYYY-MM');
        const bulanSekarang = today.format('YYYY-MM');
        
        console.log(` Auto-generate untuk pemakaian: ${bulanKemarin}`);
        
        // Cek apakah sudah digenerate bulan ini
        const checkSnapshot = await db.collection('tagihan')
            .where('bulan', '==', bulanKemarin)
            .limit(1)
            .get();
        
        if (!checkSnapshot.empty) {
            console.log(` Tagihan ${bulanKemarin} sudah digenerate, skip`);
            return;
        }
        
        // Generate otomatis
        console.log(` Mulai auto-generate tagihan arrears untuk ${bulanKemarin}`);
        
        // Panggil fungsi generate dengan parameter bulan sekarang
        // (karena generate di bulan sekarang untuk pemakaian bulan sebelumnya)
        const event = { preventDefault: () => {} };
        await generateTagihanBulk();
        
        // Log aktivitas auto-generate
        await db.collection('aktivitas').add({
            aktivitas: `AUTO-GENERATE: Tagihan arrears untuk pemakaian ${bulanKemarin}`,
            user: 'System',
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error(" Error auto-generate:", error);
    }
}

// Panggil saat app load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        autoGenerateTagihanArrears();
    }, 5000); // Delay 5 detik setelah app load
});

function changePage(pageType, pageNumber) {
    switch(pageType) {
        case 'pelanggan':
            currentPagePelanggan = pageNumber;
            loadPelangganData();
            break;
        case 'tagihan':
            currentPageTagihan = pageNumber;
            loadTagihanData();
            break;
        case 'tunggakan':
            currentPageTunggakan = pageNumber;
            loadTunggakanData();
            break;
        case 'paket':
            currentPagePaket = pageNumber;
            loadPaketData();
            break;
    }
}

function getPaginatedData(data, currentPage) {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return data.slice(startIndex, endIndex);
}
        
        function confirmDialog(message, callback) {
            if (confirm(message)) {
                callback();
            }
        }
        
        // Generate unique ID
        function generateId(prefix = '') {
            return prefix + Date.now() + Math.random().toString(36).substr(2, 9);
        }
        
        
        
        // ============================================
        // PAGE TEMPLATES
        // ============================================
        
        async function getDashboardHTML() {
    return `
        <div class="page dashboard-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-home"></i> Dashboard</h2>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="stats-grid">
                <!-- CARD 1: TOTAL PELANGGAN -->
                <div class="stat-card" onclick="navigateToPelanggan()" style="cursor: pointer;">
                    <div class="stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statPelanggan">0</div>
                        <div class="stat-label">Total Pelanggan</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #4361ee;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk lihat detail
                        </div>
                    </div>
                </div>
                
                <!-- CARD 2: TAGIHAN BULAN INI -->
                <div class="stat-card" onclick="navigateToTagihan()" style="cursor: pointer;">
                    <div class="stat-icon success">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statTagihanBulanan">Rp 0</div>
                        <div class="stat-label">Tagihan Bulan Ini</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #00b894;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk lihat tagihan
                        </div>
                    </div>
                </div>
                
                <!-- CARD 3: LUNAS -->
                <div class="stat-card" onclick="filterTagihanLunas()" style="cursor: pointer;">
                    <div class="stat-icon info">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statLunas">0</div>
                        <div class="stat-label">Lunas</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #54a0ff;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk filter lunas
                        </div>
                    </div>
                </div>
                
                <!-- CARD 4: TUNGGAKAN -->
                <div class="stat-card" onclick="filterTagihanTunggakan()" style="cursor: pointer;">
                    <div class="stat-icon danger">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statTunggakan">0</div>
                        <div class="stat-label">Tunggakan</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #ff6b6b;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk lihat tunggakan
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Tagihan 6 Bulan Terakhir</h3>
                    <canvas id="chartTagihan" height="150"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Status Pelanggan</h3>
                    <canvas id="chartStatus" height="150"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Aktivitas Terbaru</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>Aktivitas</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody id="aktivitasTable">
                                <tr>
                                    <td colspan="3" class="text-center">Memuat aktivitas...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// TAMBAHKAN FUNGSI-FUNGSI UNTUK HANDLE KLIK CARD:

// Fungsi untuk navigasi ke halaman Pelanggan
function navigateToPelanggan() {
    console.log("Navigasi ke halaman Pelanggan");
    loadPage('pelanggan');
    showToast('info', 'Pelanggan', 'Membuka data pelanggan...');
}

// Fungsi untuk navigasi ke halaman Tagihan
function navigateToTagihan() {
    console.log("Navigasi ke halaman Tagihan");
    loadPage('tagihan');
    showToast('info', 'Tagihan', 'Membuka data tagihan...');
}

// Fungsi untuk filter tagihan lunas
function filterTagihanLunas() {
    console.log("Filter tagihan lunas");
    loadPage('tagihan');
    
    // Tunggu sedikit untuk memastikan halaman sudah load
    setTimeout(() => {
        const filterStatus = document.getElementById('filterStatusTagihan');
        if (filterStatus) {
            filterStatus.value = 'lunas';
            loadTagihanData();
            showToast('success', 'Filter', 'Menampilkan tagihan yang sudah lunas');
        }
    }, 500);
}

// Fungsi untuk filter tagihan tunggakan
function filterTagihanTunggakan() {
    console.log("Filter tagihan tunggakan");
    loadPage('tunggakan');
    showToast('info', 'Tunggakan', 'Membuka data tunggakan...');
}

// FUNGSI INITIALIZE QUICK ACTIONS (Pastikan ada di file):
function initializeQuickActions() {
    console.log(" Initializing quick actions dengan arrears...");
    
    // Generate Tagihan ARREARS
    document.getElementById('btnGenerateTagihan')?.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log(" Quick Action: Generate Tagihan ARREARS");
        
        const modal = document.getElementById('modalGenerateTagihan');
        if (modal) {
            // Reset dan setup modal arrears
            modal.classList.remove('hidden');
            modal.classList.add('show');
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modal.style.zIndex = '9999';
            
            // Hapus scroll body
            document.body.style.overflow = 'hidden';
            
            // Set default values untuk arrears
            const bulanIni = moment().format('YYYY-MM');
            document.getElementById('generateBulan').value = bulanIni;
            document.getElementById('generateJatuhTempo').value = 10;
            
            // Reset checkbox
            document.getElementById('generateProrata').checked = true;
            document.getElementById('generateEmail').checked = false;
            document.getElementById('generateWhatsapp').checked = false;
            
            // Load data dan update timeline
            setTimeout(() => {
                loadTunggakanDataForModal();
            }, 300);
            
            showToast('info', 'Generate Tagihan ARREARS', 'Membuka form generate tagihan arrears');
        }
    });
    
    
    // Kirim Reminder
    const btnReminder = document.getElementById('btnKirimReminder');
    if (btnReminder) {
        btnReminder.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Kirim Reminder diklik");
            
            const modal = document.getElementById('modalReminder');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Kirim Reminder', 'Membuka form kirim reminder');
            }
        });
    }
    
    // Export Laporan
    const btnExport = document.getElementById('btnExportLaporan');
    if (btnExport) {
        btnExport.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Export Laporan diklik");
            
            const modal = document.getElementById('modalExportLaporan');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Export Laporan', 'Membuka form export laporan');
            }
        });
    }
    
    // Backup Data
    const btnBackup = document.getElementById('btnBackupData');
    if (btnBackup) {
        btnBackup.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Backup Data diklik");
            
            const modal = document.getElementById('modalBackup');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Backup Data', 'Membuka form backup data');
            }
        });
    }
    
    console.log(" Quick Actions berhasil diinisialisasi");
}

// FUNGSI UNTUK LOAD DAN TAMPILKAN DATA TUNGGAKAN DI MODAL
async function loadTunggakanDataForModal() {
    console.log(" Loading tunggakan data untuk modal...");
    
    try {
        // Tampilkan loading di tombol
        const refreshBtn = document.querySelector('#modalGenerateTagihan .btn-info');
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        refreshBtn.disabled = true;
        
        // 1. AMBIL DATA PELANGGAN AKTIF
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('status', '==', 'aktif')
            .get();
        
        const totalAktif = pelangganSnapshot.size;
        console.log(` Total pelanggan aktif: ${totalAktif}`);
        
        // 2. AMBIL DATA TAGIHAN TUNGGAKAN
        const tagihanSnapshot = await db.collection('tagihan')
            .where('status', '==', 'telat')
            .get();
        
        console.log(` Total tagihan tunggakan: ${tagihanSnapshot.size}`);
        
        // 3. KELOMPOKKAN TUNGGAKAN PER PELANGGAN
        const tunggakanByPelanggan = {};
        let totalTunggakan = 0;
        
        if (!tagihanSnapshot.empty) {
            tagihanSnapshot.docs.forEach(doc => {
                const tagihan = doc.data();
                const pelangganId = tagihan.pelanggan_id;
                
                if (!tunggakanByPelanggan[pelangganId]) {
                    tunggakanByPelanggan[pelangganId] = {
                        pelanggan_id: pelangganId,
                        pelanggan_nama: tagihan.pelanggan_nama || 'Tidak ada nama',
                        pelanggan_telepon: tagihan.pelanggan_telepon || '-',
                        total_tunggakan: 0,
                        jumlah_tagihan_tunggak: 0,
                        hari_terlambat: 0,
                        kategori: 'ringan'
                    };
                }
                
                // Hitung total tunggakan
                const jumlahTagihan = Number(tagihan.jumlah) || 0;
                tunggakanByPelanggan[pelangganId].total_tunggakan += jumlahTagihan;
                tunggakanByPelanggan[pelangganId].jumlah_tagihan_tunggak += 1;
                
                // Hitung hari terlambat
                if (tagihan.tanggal_jatuh_tempo) {
                    const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
                    const hariTerlambat = moment().diff(jatuhTempo, 'days');
                    tunggakanByPelanggan[pelangganId].hari_terlambat = Math.max(
                        tunggakanByPelanggan[pelangganId].hari_terlambat,
                        hariTerlambat
                    );
                }
                
                totalTunggakan += jumlahTagihan;
            });
            
            // Tentukan kategori untuk setiap pelanggan
            Object.keys(tunggakanByPelanggan).forEach(pelangganId => {
                const tunggakan = tunggakanByPelanggan[pelangganId];
                const hariTerlambat = tunggakan.hari_terlambat;
                
                if (hariTerlambat <= 30) {
                    tunggakan.kategori = 'ringan';
                } else if (hariTerlambat <= 60) {
                    tunggakan.kategori = 'sedang';
                } else {
                    tunggakan.kategori = 'berat';
                }
            });
        }
        
        const jumlahPelangganTunggak = Object.keys(tunggakanByPelanggan).length;
        
        // 4. UPDATE SUMMARY DI MODAL
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        document.getElementById('summaryTunggakan').textContent = jumlahPelangganTunggak;
        document.getElementById('summaryTotalTunggakan').textContent = formatRupiah(totalTunggakan);
        
        // 5. TAMPILKAN LIST TUNGGAKAN DI TABLE
        const tunggakanList = document.getElementById('tunggakanList');
        if (tunggakanList) {
            if (jumlahPelangganTunggak === 0) {
                tunggakanList.innerHTML = `
                    <tr>
                        <td colspan="4" style="padding: 15px; text-align: center; color: var(--success);">
                            <i class="fas fa-check-circle"></i> Tidak ada tunggakan
                        </td>
                    </tr>
                `;
            } else {
                let html = '';
                Object.values(tunggakanByPelanggan).forEach((tunggakan, index) => {
                    // Warna berdasarkan kategori
                    let kategoriColor = '';
                    let kategoriText = '';
                    
                    if (tunggakan.kategori === 'ringan') {
                        kategoriColor = '#fdcb6e';
                        kategoriText = 'Ringan';
                    } else if (tunggakan.kategori === 'sedang') {
                        kategoriColor = '#e17055';
                        kategoriText = 'Sedang';
                    } else {
                        kategoriColor = '#d63031';
                        kategoriText = 'Berat';
                    }
                    
                    html += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 8px;">
                                <strong>${tunggakan.pelanggan_nama}</strong>
                                <br>
                                <small class="text-muted">${tunggakan.pelanggan_telepon}</small>
                            </td>
                            <td style="padding: 8px; font-weight: bold; color: var(--danger);">
                                ${formatRupiah(tunggakan.total_tunggakan)}
                            </td>
                            <td style="padding: 8px;">
                                <span style="background: ${kategoriColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                    ${tunggakan.hari_terlambat} hari
                                </span>
                            </td>
                            <td style="padding: 8px;">
                                <span style="background: ${kategoriColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                    ${kategoriText}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                tunggakanList.innerHTML = html;
            }
        }
        
        // 6. TAMPILKAN/HIDE SECTION TUNGGAKAN
        const tunggakanSection = document.getElementById('tunggakanDataSection');
        if (tunggakanSection) {
            if (jumlahPelangganTunggak > 0) {
                tunggakanSection.style.display = 'block';
            } else {
                tunggakanSection.style.display = 'none';
            }
        }
        
        // 7. UPDATE ESTIMASI GENERATE
        updateGenerateEstimation(totalAktif, jumlahPelangganTunggak, totalTunggakan);
        
        // Restore tombol
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        
        showToast('success', 'Data Updated', 'Data tunggakan berhasil di-refresh');
        
        // Simpan data untuk digunakan nanti
        window.tunggakanModalData = tunggakanByPelanggan;
        
    } catch (error) {
        console.error(" Error load tunggakan data for modal:", error);
        
        // Restore tombol
        const refreshBtn = document.querySelector('#modalGenerateTagihan .btn-info');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
            refreshBtn.disabled = false;
        }
        
        showToast('error', 'Error', 'Gagal memuat data tunggakan');
    }
}

// FUNGSI UNTUK UPDATE ESTIMASI GENERATE
function updateGenerateEstimation(totalAktif, totalTunggak, totalTunggakan) {
    // Ambil filter yang dipilih
    const filter = document.getElementById('filterTunggakan').value;
    
    let estimasiJumlahTagihan = totalAktif;
    let estimasiDenda = 0;
    
    // Hitung berdasarkan filter
    switch(filter) {
        case 'exclude_tunggakan':
            estimasiJumlahTagihan = totalAktif - totalTunggak;
            estimasiDenda = 0;
            break;
        case 'only_tunggakan':
            estimasiJumlahTagihan = totalTunggak;
            // Estimasi denda 5% dari total tunggakan
            estimasiDenda = Math.round(totalTunggakan * 0.05);
            break;
        case 'exclude_berat':
            // Asumsi 20% dari tunggakan adalah berat
            const estimasiBerat = Math.round(totalTunggak * 0.2);
            estimasiJumlahTagihan = totalAktif - estimasiBerat;
            // Denda untuk tunggakan non-berat
            estimasiDenda = Math.round(totalTunggakan * 0.8 * 0.05);
            break;
        default: // all
            estimasiJumlahTagihan = totalAktif;
            estimasiDenda = Math.round(totalTunggakan * 0.05);
            break;
    }
    
    // Estimasi total tagihan (rata-rata 150rb per pelanggan + denda)
    const estimasiRataTagihan = estimasiJumlahTagihan * 150000;
    const estimasiTotal = estimasiRataTagihan + estimasiDenda;
    
    // Estimasi waktu (10 tagihan per detik)
    const estimasiWaktu = Math.ceil(estimasiJumlahTagihan / 10);
    
    // Update UI
    document.getElementById('summaryJumlahTagihan').textContent = estimasiJumlahTagihan;
    document.getElementById('summaryEstimasiTotal').textContent = formatRupiah(estimasiTotal);
    document.getElementById('summaryWaktu').textContent = `~${estimasiWaktu} detik`;
    document.getElementById('summaryDenda').textContent = formatRupiah(estimasiDenda);
}

// FUNGSI TOGGLE FILTER
function toggleTunggakanFilter() {
    const filter = document.getElementById('filterTunggakan').value;
    const kategoriSelect = document.getElementById('kategoriTunggakan');
    
    // Enable kategori hanya jika filter khusus tunggakan
    if (filter === 'only_tunggakan') {
        kategoriSelect.disabled = false;
    } else {
        kategoriSelect.disabled = true;
        kategoriSelect.value = 'all';
    }
    
    // Refresh estimasi jika ada data
    const totalAktif = parseInt(document.getElementById('summaryTotalAktif').textContent) || 0;
    const totalTunggak = parseInt(document.getElementById('summaryTunggakan').textContent) || 0;
    const totalTunggakanText = document.getElementById('summaryTotalTunggakan').textContent;
    const totalTunggakan = parseFloat(totalTunggakanText.replace(/[^0-9]/g, '')) || 0;
    
    updateGenerateEstimation(totalAktif, totalTunggak, totalTunggakan);
}
        

       async function getPelangganHTML() {
    return `
        <div class="page pelanggan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-users"></i> Data Pelanggan</h2>
                <div class="action-buttons">
                    <!-- TAMBAH TOMBOL IMPORT/EXPORT DI SINI -->
                    <button class="btn btn-outline" onclick="showImportExportPanel()">
                        <i class="fas fa-file-import"></i> Import/Export
                    </button>
                    <button class="btn btn-primary" onclick="showAddPelangganModal()">
                        <i class="fas fa-plus"></i> Tambah Pelanggan
                    </button>
                </div>
            </div>
            
            <!-- PANEL IMPORT/EXPORT (AWALNYA DISEMBUNYIKAN) -->
            <div id="importExportPanel" class="card hidden" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h3><i class="fas fa-file-import"></i> Import & Export Data Pelanggan</h3>
                    <button class="btn btn-sm btn-outline" onclick="hideImportExportPanel()">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- IMPORT SECTION -->
                        <div>
                            <h4><i class="fas fa-upload"></i> Import Data</h4>
                            <div class="form-group">
                                <label>Pilih File Excel/CSV</label>
                                <input type="file" class="form-control" id="fileImportPelanggan" 
                                       accept=".xlsx,.xls,.csv">
                                <small class="text-muted">Format: Excel (.xlsx, .xls) atau CSV</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Template Kolom</label>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px;">
                                    nama, telepon, email, alamat, paket, harga, tanggal_pasang, status
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Aksi Import</label>
                                <select class="form-control" id="importActionPelanggan">
                                    <option value="tambah">Tambah Data Baru Saja</option>
                                    <option value="update">Update Data yang Ada + Tambah Baru</option>
                                    <option value="replace">Ganti Semua Data</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-success" onclick="importDataPelanggan()">
                                <i class="fas fa-upload"></i> Import Data Pelanggan
                            </button>
                            <button class="btn btn-outline" onclick="downloadTemplatePelanggan()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                        </div>
                        
                        <!-- EXPORT SECTION -->
                        <div>
                            <h4><i class="fas fa-download"></i> Export Data</h4>
                            <div class="form-group">
                                <label>Format Export</label>
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="exportFormatPelanggan" 
                                           id="exportExcelPelanggan" value="excel" checked>
                                    <label class="form-check-label" for="exportExcelPelanggan">Excel (.xlsx)</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="exportFormatPelanggan" 
                                           id="exportCSVPelanggan" value="csv">
                                    <label class="form-check-label" for="exportCSVPelanggan">CSV (.csv)</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="exportFormatPelanggan" 
                                           id="exportJSONPelanggan" value="json">
                                    <label class="form-check-label" for="exportJSONPelanggan">JSON (.json)</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Filter Export</label>
                                <select class="form-control" id="exportFilterPelanggan">
                                    <option value="all">Semua Pelanggan</option>
                                    <option value="aktif">Hanya Aktif</option>
                                    <option value="nonaktif">Hanya Nonaktif</option>
                                    <option value="tunggak">Hanya Tunggak</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Include Kolom</label>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="includeID" checked>
                                    <label class="form-check-label">ID Pelanggan</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="includeKoordinat" checked>
                                    <label class="form-check-label">Koordinat GPS</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="includeCatatan" checked>
                                    <label class="form-check-label">Catatan</label>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="exportDataPelanggan()">
                                <i class="fas fa-download"></i> Export Data Pelanggan
                            </button>
                            <button class="btn btn-info" onclick="exportBackupPelanggan()">
                                <i class="fas fa-database"></i> Backup Lengkap
                            </button>
                        </div>
                    </div>
                    
                    <!-- LOG IMPORT/EXPORT -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                        <h5><i class="fas fa-history"></i> Log Terakhir</h5>
                        <div id="importExportLogPelanggan" style="max-height: 100px; overflow-y: auto; font-size: 12px;">
                            <div class="text-muted">Belum ada aktivitas import/export</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- FILTERS DAN TABEL PELANGGAN (TETAP SAMA) -->
            <div class="filters-card">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="filterStatus" onchange="loadPelangganData()">
                            <option value="">Semua Status</option>
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                            <option value="tunggak">Tunggak</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Paket</label>
                        <select class="form-control" id="filterPaket" onchange="loadPelangganData()">
                            <option value="">Semua Paket</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cari</label>
                        <input type="text" class="form-control" id="searchPelanggan" 
                               placeholder="Nama, alamat, atau telepon..." oninput="loadPelangganData()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-outline" style="margin-top: 25px;" onclick="loadPelangganData()">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- CARD TABEL PELANGGAN -->
            <div class="card">
                <div class="card-header">
                    <h3>Daftar Pelanggan</h3>
                    <div class="btn-group">
                        <!-- TAMBAH TOMBOL CEPAT EXPORT DI SINI -->
                        <button class="btn btn-sm btn-outline" onclick="quickExportPelanggan('excel')" title="Export Excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="quickExportPelanggan('csv')" title="Export CSV">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="printPelanggan()" title="Print">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nama</th>
                                    <th>Telepon</th>
                                    <th>Alamat</th>
                                    <th>Paket</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pelangganTable">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                                        Memuat data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION -->
                    <div id="pelangganPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    `;
}
        
        async function getPaketHTML() {
            return `
                <div class="page paket-page">
                    <div class="page-header">
                        <h2 class="page-title"><i class="fas fa-wifi"></i> Data Paket Internet</h2>
                        <div>
                            <button class="btn btn-outline" onclick="exportPaket()">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <button class="btn btn-primary" onclick="showAddPaketModal()">
                                <i class="fas fa-plus"></i> Tambah Paket
                            </button>
                        </div>
                    </div>
                    
                    
                    
                    <div class="card">
                <div class="card-header">
                    <h3>Detail Paket</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nama Paket</th>
                                    <th>Kecepatan</th>
                                    <th>Harga</th>
                                    <th>Kuota</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="paketTable">
                                <!-- Data akan diisi -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION CONTAINER -->
                    <div id="paketPagination"></div>
                    
                    <div style="margin-top: 10px; color: var(--gray); font-size: 14px;">
                        Menampilkan <span id="paketStart">0</span>-<span id="paketEnd">0</span> dari 
                        <span id="paketTotal">0</span> paket
                    </div>
                </div>
            </div>
        </div>
    `;
}
        
        async function getTagihanHTML() {
    return `
        <div class="page tagihan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-receipt"></i> Tagihan ARREARS</h2>
                <div class="action-buttons">
                    <button class="btn btn-outline" onclick="showModal('modalProrata')">
                        <i class="fas fa-calculator"></i> Kalkulator Prorata
                    </button>
                    <button class="btn btn-primary" onclick="showModal('modalGenerateTagihan')" id="btnGenerateTagihan">
                        <i class="fas fa-bolt"></i> Generate Tagihan ARREARS
                    </button>
                </div>
            </div>
            
            <!-- INFO ARREARS -->
            <div class="alert alert-info" style="background: #e7f3ff; border-left: 4px solid #4361ee; padding: 15px; margin-bottom: 20px;">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                    <div>
                        <i class="fas fa-calendar-check" style="color: #00b894;"></i>
                        <strong> Bulan Pemakaian:</strong> Desember 2024
                    </div>
                    <div>
                        <i class="fas fa-calendar-times" style="color: #ff6b6b;"></i>
                        <strong> Jatuh Tempo:</strong> 10 Januari 2025
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Daftar Tagihan</h3>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="printTagihan()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="exportTagihanPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Invoice</th>
                                    <th>Pelanggan</th>
                                    <th>Bulan</th>
                                    <th>Jumlah</th>
                                    <th>Jatuh Tempo</th>
                                    <th>Status</th> <!-- KOLOM STATUS DITAMBAHKAN -->
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tagihanTable">
                                <!-- Data akan diisi -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION -->
                    <div id="tagihanPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    `;
}
        
        async function getTunggakanHTML() {
            return `
                <div class="page tunggakan-page">
                    <div class="page-header">
                        <h2 class="page-title"><i class="fas fa-clock"></i> Tunggakan</h2>
                        <div class="action-buttons">
                            <button class="btn btn-outline" onclick="exportTunggakan()">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <button class="btn btn-success" onclick="showModal('modalReminder')">
                                <i class="fas fa-envelope"></i> Kirim Reminder
                            </button>
                            <button class="btn btn-danger" onclick="generateTunggakanReport()">
                                <i class="fas fa-file-excel"></i> Laporan Tunggakan
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="tunggakanRingan">0</div>
                                <div class="stat-label">Tunggakan Ringan (1-30 hari)</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="tunggakanSedang">0</div>
                                <div class="stat-label">Tunggakan Sedang (31-60 hari)</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-ban"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="tunggakanBerat">0</div>
                                <div class="stat-label">Tunggakan Berat (>60 hari)</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="totalTunggakan">Rp 0</div>
                                <div class="stat-label">Total Tunggakan</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                <div class="card-header">
                    <h3>Detail Tunggakan</h3>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="printTunggakan()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="sendWhatsAppReminder()">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Pelanggan</th>
                                    <th>Invoice</th>
                                    <th>Jatuh Tempo</th>
                                    <th>Hari Terlambat</th>
                                    <th>Jumlah</th>
                                    <th>Denda</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tunggakanTable">
                                <!-- Data akan diisi -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION CONTAINER -->
                    <div id="tunggakanPagination"></div>
                    
                    <div style="margin-top: 10px; color: var(--gray); font-size: 14px;">
                        Menampilkan <span id="tunggakanStart">0</span>-<span id="tunggakanEnd">0</span> dari 
                        <span id="tunggakanTotal">0</span> tunggakan
                    </div>
                </div>
            </div>
        </div>
    `;
}
        
        async function getImportExportHTML() {
            return `
                <div class="page import-export-page">
                    <div class="page-header">
                        <h2 class="page-title"><i class="fas fa-file-import"></i> Import & Export Data</h2>
                    </div>
                    
                    <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-upload"></i> Import Data</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Tipe Data</label>
                                    <select class="form-control" id="importType">
                                        <option value="pelanggan">Data Pelanggan</option>
                                        <option value="paket">Data Paket</option>
                                        <option value="tagihan">Data Tagihan</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Pilih File</label>
                                    <input type="file" class="form-control" id="fileImport" accept=".xlsx,.xls,.csv">
                                    <small class="text-muted">Format: Excel (.xlsx, .xls) atau CSV</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>Aksi</label>
                                    <select class="form-control" id="importAction">
                                        <option value="tambah">Tambah Data Baru</option>
                                        <option value="update">Update Data Existing</option>
                                        <option value="replace">Replace Semua Data</option>
                                    </select>
                                </div>
                                
                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn btn-primary" onclick="downloadTemplate()">
                                        <i class="fas fa-download"></i> Download Template
                                    </button>
                                    <button class="btn btn-success" onclick="importExcel()">
                                        <i class="fas fa-upload"></i> Import Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-download"></i> Export Data</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Tipe Data</label>
                                    <select class="form-control" id="exportType">
                                        <option value="pelanggan">Data Pelanggan</option>
                                        <option value="paket">Data Paket</option>
                                        <option value="tagihan">Data Tagihan</option>
                                        <option value="tunggakan">Data Tunggakan</option>
                                        <option value="all">Semua Data</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Format File</label>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportExcel" value="excel" checked>
                                        <label class="form-check-label" for="exportExcel">Excel (.xlsx)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportCSV" value="csv">
                                        <label class="form-check-label" for="exportCSV">CSV (.csv)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportJSON" value="json">
                                        <label class="form-check-label" for="exportJSON">JSON (.json)</label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Include</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="includeHeader" checked>
                                        <label class="form-check-label" for="includeHeader">Header Kolom</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="includeTimestamp" checked>
                                        <label class="form-check-label" for="includeTimestamp">Timestamp</label>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn btn-success" onclick="exportData()">
                                        <i class="fas fa-download"></i> Export Data
                                    </button>
                                    <button class="btn btn-info" onclick="backupManual()">
                                        <i class="fas fa-save"></i> Backup Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Log Import/Export</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Tipe</th>
                                            <th>File</th>
                                            <th>Jumlah Data</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logTable">
                                        <tr>
                                            <td colspan="5" class="text-center">Tidak ada log</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function getLaporanHTML() {
            return `
                <div class="page laporan-page">
                    <div class="page-header">
                        <h2 class="page-title"><i class="fas fa-chart-bar"></i> Laporan & Analytics</h2>
                        <div class="action-buttons">
                            <button class="btn btn-outline" onclick="printLaporan()">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button class="btn btn-primary" onclick="generateLaporan()">
                                <i class="fas fa-sync-alt"></i> Generate Laporan
                            </button>
                            <button class="btn btn-success" onclick="showModal('modalExportLaporan')">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="filters-card">
                        <div class="filter-row">
                            <div class="form-group">
                                <label>Periode Awal</label>
                                <input type="date" class="form-control" id="laporanStartDate" value="${moment().startOf('month').format('YYYY-MM-DD')}">
                            </div>
                            <div class="form-group">
                                <label>Periode Akhir</label>
                                <input type="date" class="form-control" id="laporanEndDate" value="${moment().endOf('month').format('YYYY-MM-DD')}">
                            </div>
                            <div class="form-group">
                                <label>Tipe Laporan</label>
                                <select class="form-control" id="laporanType">
                                    <option value="keuangan">Laporan Keuangan</option>
                                    <option value="pelanggan">Laporan Pelanggan</option>
                                    <option value="tagihan">Laporan Tagihan</option>
                                    <option value="tunggakan">Laporan Tunggakan</option>
                                    <option value="paket">Laporan Paket</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" style="margin-top: 25px;" onclick="generateLaporan()">
                                    <i class="fas fa-filter"></i> Generate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3>Grafik Pendapatan</h3>
                            <canvas id="laporanChart1" height="150"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Distribusi Pelanggan</h3>
                            <canvas id="laporanChart2" height="150"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Detail Laporan</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="laporanTable">
                                    <!-- Data laporan -->
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // ============================================
// FUNGSI IMPORT/EXPORT DATA PELANGGAN
// ============================================

// TAMPILKAN/SEMBUNYIKAN PANEL IMPORT/EXPORT
function showImportExportPanel() {
    document.getElementById('importExportPanel').classList.remove('hidden');
    showToast('info', 'Import/Export', 'Buka panel import/export data pelanggan');
}

function hideImportExportPanel() {
    document.getElementById('importExportPanel').classList.add('hidden');
}

// DOWNLOAD TEMPLATE EXCEL
function downloadTemplatePelanggan() {
    try {
        // Buat data template
        const templateData = [
            ['nama', 'telepon', 'email', 'alamat', 'paket', 'harga', 'tanggal_pasang', 'status', 'koordinat', 'catatan'],
            ['Budi Santoso', '081234567890', 'budi@email.com', 'Jl. Contoh No. 123', 'Paket 20 Mbps', '250000', '2024-01-15', 'aktif', '-6.2088, 106.8456', 'Pelanggan baru'],
            ['Siti Rahayu', '082345678901', 'siti@email.com', 'Jl. Contoh No. 456', 'Paket 10 Mbps', '150000', '2024-02-01', 'aktif', '-6.2250, 106.8050', ''],
            // ... tambahkan contoh lainnya
        ];
        
        // Buat workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        XLSX.utils.book_append_sheet(wb, ws, 'Template Pelanggan');
        
        // Download
        XLSX.writeFile(wb, 'Template_Pelanggan_XBILL.xlsx');
        
        showToast('success', 'Template', 'Template berhasil didownload');
        
    } catch (error) {
        console.error("Error download template:", error);
        showToast('error', 'Error', 'Gagal download template');
    }
}

// IMPORT DATA DARI EXCEL/CSV
async function importDataPelanggan() {
    const fileInput = document.getElementById('fileImportPelanggan');
    const action = document.getElementById('importActionPelanggan').value;
    
    if (!fileInput.files.length) {
        showToast('error', 'Error', 'Pilih file terlebih dahulu');
        return;
    }
    
    try {
        showLoading();
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                console.log(` Data dari file: ${jsonData.length} baris`);
                
                if (jsonData.length === 0) {
                    throw new Error('File kosong atau format tidak sesuai');
                }
                
                // Validasi kolom minimal
                const requiredFields = ['nama', 'telepon', 'alamat', 'paket'];
                const firstRow = jsonData[0];
                const missingFields = requiredFields.filter(field => !firstRow.hasOwnProperty(field));
                
                if (missingFields.length > 0) {
                    throw new Error(`Kolom wajib tidak ditemukan: ${missingFields.join(', ')}`);
                }
                
                // Proses import berdasarkan aksi
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Batch write ke Firebase
                const batch = db.batch();
                const now = new Date().toISOString();
                
                for (let i = 0; i < jsonData.length; i++) {
                    try {
                        const row = jsonData[i];
                        
                        // Validasi data
                        if (!row.nama || !row.telepon) {
                            errors.push(`Baris ${i + 2}: Nama atau telepon kosong`);
                            errorCount++;
                            continue;
                        }
                        
                        // Format data
                        const pelangganData = {
                            nama: row.nama.toString().trim(),
                            telepon: row.telepon.toString().trim(),
                            email: row.email ? row.email.toString().trim() : `${row.telepon}@xbill.com`,
                            alamat: row.alamat ? row.alamat.toString().trim() : '',
                            paket: row.paket ? row.paket.toString().trim() : 'Paket 10 Mbps',
                            harga: parseInt(row.harga) || 150000,
                            tanggal_pasang: row.tanggal_pasang || new Date().toISOString().split('T')[0],
                            status: row.status || 'aktif',
                            koordinat: row.koordinat || '',
                            catatan: row.catatan || '',
                            created_at: now,
                            updated_at: now
                        };
                        
                        // Generate ID
                        const pelangganId = `CUST_${Date.now()}_${i}`;
                        const pelangganRef = db.collection('pelanggan').doc(pelangganId);
                        
                        // Add to batch
                        batch.set(pelangganRef, pelangganData);
                        successCount++;
                        
                    } catch (rowError) {
                        errors.push(`Baris ${i + 2}: ${rowError.message}`);
                        errorCount++;
                    }
                }
                
                // Execute batch
                await batch.commit();
                
                // Log aktivitas
                await db.collection('aktivitas').add({
                    aktivitas: `Import data pelanggan: ${successCount} berhasil, ${errorCount} gagal`,
                    user: localStorage.getItem('userName') || 'Administrator',
                    timestamp: now
                });
                
                // Update log di UI
                updateImportExportLog(`Import: ${successCount} data berhasil, ${errorCount} error`);
                
                hideLoading();
                
                // Tampilkan hasil
                const resultMessage = `
                     Hasil Import:
                     Berhasil: ${successCount} data
                     Gagal: ${errorCount} data
                    ${errors.length > 0 ? `\n Error:\n${errors.slice(0, 5).join('\n')}` : ''}
                `;
                
                showToast('success', 'Import Berhasil', resultMessage);
                
                // Refresh data pelanggan
                if (currentPage === 'pelanggan') {
                    await loadPelangganData();
                }
                
                // Reset file input
                fileInput.value = '';
                
            } catch (parseError) {
                hideLoading();
                console.error("Error parsing file:", parseError);
                showToast('error', 'Error Parsing', parseError.message);
            }
        };
        
        reader.onerror = function() {
            hideLoading();
            showToast('error', 'Error', 'Gagal membaca file');
        };
        
        reader.readAsArrayBuffer(file);
        
    } catch (error) {
        hideLoading();
        console.error("Error import:", error);
        showToast('error', 'Error', 'Gagal import data: ' + error.message);
    }
}

// EXPORT DATA PELANGGAN
async function exportDataPelanggan() {
    try {
        showLoading();
        
        // Ambil filter
        const filter = document.getElementById('exportFilterPelanggan').value;
        const format = document.querySelector('input[name="exportFormatPelanggan"]:checked').value;
        const includeID = document.getElementById('includeID').checked;
        const includeKoordinat = document.getElementById('includeKoordinat').checked;
        const includeCatatan = document.getElementById('includeCatatan').checked;
        
        // Query data berdasarkan filter
        let query = db.collection('pelanggan');
        
        if (filter !== 'all') {
            query = query.where('status', '==', filter);
        }
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data untuk diexport');
            return;
        }
        
        // Format data untuk export
        const data = [];
        
        // Header
        const headers = ['No'];
        if (includeID) headers.push('ID');
        headers.push('Nama', 'Telepon', 'Email', 'Alamat', 'Paket', 'Harga', 'Status', 'Tanggal Pasang');
        if (includeKoordinat) headers.push('Koordinat');
        if (includeCatatan) headers.push('Catatan');
        headers.push('Created At');
        
        data.push(headers);
        
        // Data rows
        let index = 1;
        snapshot.forEach(doc => {
            const pelanggan = doc.data();
            const row = [index++];
            
            if (includeID) row.push(doc.id);
            row.push(
                pelanggan.nama || '',
                pelanggan.telepon || '',
                pelanggan.email || '',
                pelanggan.alamat || '',
                pelanggan.paket || '',
                pelanggan.harga || 0,
                pelanggan.status || '',
                pelanggan.tanggal_pasang || ''
            );
            
            if (includeKoordinat) row.push(pelanggan.koordinat || '');
            if (includeCatatan) row.push(pelanggan.catatan || '');
            row.push(pelanggan.created_at ? moment(pelanggan.created_at).format('DD/MM/YYYY HH:mm') : '');
            
            data.push(row);
        });
        
        // Buat file berdasarkan format
        const now = moment().format('YYYYMMDD_HHmmss');
        let fileName = `Data_Pelanggan_XBILL_${now}`;
        
        if (format === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Data Pelanggan');
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            
        } else if (format === 'csv') {
            const csvContent = data.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${fileName}.csv`;
            link.click();
            
        } else if (format === 'json') {
            const jsonData = [];
            snapshot.forEach(doc => {
                jsonData.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${fileName}.json`;
            link.click();
        }
        
        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Export data pelanggan: ${snapshot.size} data, format: ${format}`,
            user: localStorage.getItem('userName') || 'Administrator',
            timestamp: new Date().toISOString()
        });
        
        // Update log
        updateImportExportLog(`Export: ${snapshot.size} data ke format ${format}`);
        
        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} data berhasil diexport`);
        
    } catch (error) {
        hideLoading();
        console.error("Error export:", error);
        showToast('error', 'Error', 'Gagal export data: ' + error.message);
    }
}

// QUICK EXPORT (TOMBOl CEPAT)
async function quickExportPelanggan(format = 'excel') {
    try {
        showLoading();
        
        // Ambil semua data pelanggan
        const snapshot = await db.collection('pelanggan').get();
        
        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data pelanggan');
            return;
        }
        
        // Format data sederhana
        const data = [
            ['No', 'Nama', 'Telepon', 'Email', 'Alamat', 'Paket', 'Harga', 'Status', 'Tanggal Pasang']
        ];
        
        let index = 1;
        snapshot.forEach(doc => {
            const pelanggan = doc.data();
            data.push([
                index++,
                pelanggan.nama || '',
                pelanggan.telepon || '',
                pelanggan.email || '',
                pelanggan.alamat || '',
                pelanggan.paket || '',
                pelanggan.harga || 0,
                pelanggan.status || '',
                pelanggan.tanggal_pasang || ''
            ]);
        });
        
        // Export berdasarkan format
        const now = moment().format('YYYYMMDD_HHmmss');
        
        if (format === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Pelanggan');
            XLSX.writeFile(wb, `Pelanggan_XBILL_${now}.xlsx`);
            
        } else if (format === 'csv') {
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Pelanggan_XBILL_${now}.csv`;
            link.click();
        }
        
        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} data diexport`);
        
    } catch (error) {
        hideLoading();
        console.error("Error quick export:", error);
        showToast('error', 'Error', 'Gagal export cepat');
    }
}

// BACKUP LENGKAP
async function exportBackupPelanggan() {
    if (!confirm('Buat backup lengkap semua data pelanggan?\n\nBackup akan mencakup semua data termasuk yang sudah dihapus.')) {
        return;
    }
    
    try {
        showLoading();
        
        // Ambil SEMUA data pelanggan (termasuk yang sudah dihapus/archive jika ada)
        const snapshot = await db.collection('pelanggan').get();
        
        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data untuk dibackup');
            return;
        }
        
        // Format data backup lengkap
        const backupData = {
            metadata: {
                system: 'X-BILL ISP',
                type: 'pelanggan_backup',
                exported_at: new Date().toISOString(),
                total_records: snapshot.size,
                version: '1.0'
            },
            data: []
        };
        
        // Tambah semua data
        snapshot.forEach(doc => {
            backupData.data.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        // Buat file JSON
        const now = moment().format('YYYYMMDD_HHmmss');
        const fileName = `Backup_Pelanggan_XBILL_${now}.json`;
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        
        // Download
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        
        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Backup lengkap data pelanggan: ${snapshot.size} records`,
            user: localStorage.getItem('userName') || 'Administrator',
            timestamp: new Date().toISOString()
        });
        
        hideLoading();
        showToast('success', 'Backup Berhasil', `Backup ${snapshot.size} data berhasil dibuat`);
        
    } catch (error) {
        hideLoading();
        console.error("Error backup:", error);
        showToast('error', 'Error', 'Gagal membuat backup');
    }
}

// UPDATE LOG IMPORT/EXPORT
function updateImportExportLog(message) {
    const logContainer = document.getElementById('importExportLogPelanggan');
    if (!logContainer) return;
    
    const timestamp = moment().format('HH:mm:ss');
    const logEntry = document.createElement('div');
    logEntry.style.padding = '5px';
    logEntry.style.borderBottom = '1px solid #f1f1f1';
    logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
    
    logContainer.prepend(logEntry);
    
    // Batasi hanya 10 log terakhir
    const logs = logContainer.children;
    if (logs.length > 10) {
        for (let i = 10; i < logs.length; i++) {
            logContainer.removeChild(logs[i]);
        }
    }
}
        
        

        // ============================================
// FIX QUICK ACTIONS EVENT HANDLERS
// ============================================

function initializeQuickActions() {
    // Generate Tagihan
    document.getElementById('btnGenerateTagihan')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalGenerateTagihan');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Generate Tagihan', 'Membuka form generate tagihan');
        } else {
            showToast('error', 'Error', 'Modal generate tagihan tidak ditemukan');
        }
    });
    
    // Kirim Reminder
    document.getElementById('btnKirimReminder')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalReminder');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Kirim Reminder', 'Membuka form kirim reminder');
        } else {
            showToast('error', 'Error', 'Modal reminder tidak ditemukan');
        }
    });
    
    // Export Laporan
    document.getElementById('btnExportLaporan')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalExportLaporan');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Export Laporan', 'Membuka form export laporan');
        } else {
            showToast('error', 'Error', 'Modal export laporan tidak ditemukan');
        }
    });
    
    // Backup Data
    document.getElementById('btnBackupData')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalBackup');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Backup Data', 'Membuka form backup data');
        } else {
            showToast('error', 'Error', 'Modal backup tidak ditemukan');
        }
    });
}

// Panggil fungsi ini dalam renderDashboard() setelah rendering selesai
async function renderDashboard() {
    console.log(" MEMULAI RENDER DASHBOARD");
    
    try {
        // 1. TAMPILKAN LOADING
        const loadingEl = document.getElementById('loadingOverlay');
        if (loadingEl) {
            loadingEl.classList.remove('hidden');
        }
        
        // 2. AMBIL DATA DARI FIREBASE
        console.log(" Mengambil data dari Firebase...");
        
        // Gunakan Promise.all untuk mengambil data secara paralel
        const [pelangganSnapshot, tagihanSnapshot] = await Promise.all([
            db.collection('pelanggan').get(),
            db.collection('tagihan').get()
        ]);
        
        console.log(` Data loaded: ${pelangganSnapshot.size} pelanggan, ${tagihanSnapshot.size} tagihan`);
        
        // 3. HITUNG STATISTIK
        
        // A. TOTAL PELANGGAN
        const totalPelanggan = pelangganSnapshot.size;
        console.log(` Total Pelanggan: ${totalPelanggan}`);
        
        // Update UI untuk Total Pelanggan
        const statPelangganEl = document.getElementById('statPelanggan');
        if (statPelangganEl) {
            statPelangganEl.textContent = totalPelanggan;
        }
        
        // B. TAGIHAN BULAN INI
        const currentMonth = moment().format('YYYY-MM');
        console.log(` Bulan berjalan: ${currentMonth}`);
        
        let totalTagihanBulanIni = 0;
        let lunasCount = 0;
        let tunggakanCount = 0;
        let belumBayarCount = 0;
        
        // Filter tagihan untuk bulan ini
        tagihanSnapshot.forEach(doc => {
            const tagihan = doc.data();
            if (tagihan.bulan === currentMonth) {
                totalTagihanBulanIni += Number(tagihan.jumlah) || 0;
                
                if (tagihan.status === 'lunas') {
                    lunasCount++;
                } else if (tagihan.status === 'telat') {
                    tunggakanCount++;
                } else if (tagihan.status === 'belum') {
                    belumBayarCount++;
                }
            }
        });
        
        console.log(` Tagihan Bulan Ini: ${formatRupiah(totalTagihanBulanIni)}`);
        console.log(` Lunas: ${lunasCount}`);
        console.log(` Tunggakan: ${tunggakanCount}`);
        console.log(` Belum Bayar: ${belumBayarCount}`);
        
        // Update UI untuk Tagihan Bulan Ini
        const statTagihanEl = document.getElementById('statTagihanBulanan');
        if (statTagihanEl) {
            statTagihanEl.textContent = formatRupiah(totalTagihanBulanIni);
        }
        
        // Update UI untuk Lunas
        const statLunasEl = document.getElementById('statLunas');
        if (statLunasEl) {
            statLunasEl.textContent = lunasCount;
        }
        
        // Update UI untuk Tunggakan
        const statTunggakanEl = document.getElementById('statTunggakan');
        if (statTunggakanEl) {
            statTunggakanEl.textContent = tunggakanCount;
        }
        
        // C. HITUNG STATUS PELANGGAN
        let aktifCount = 0;
        let nonaktifCount = 0;
        let tunggakPelangganCount = 0;
        
        pelangganSnapshot.forEach(doc => {
            const pelanggan = doc.data();
            const status = pelanggan.status || 'nonaktif';
            
            if (status === 'aktif') {
                aktifCount++;
            } else if (status === 'nonaktif') {
                nonaktifCount++;
            } else if (status === 'tunggak') {
                tunggakPelangganCount++;
            }
        });
        
        console.log(` Status Pelanggan: Aktif=${aktifCount}, Nonaktif=${nonaktifCount}, Tunggak=${tunggakPelangganCount}`);
        
        // 4. RENDER CHART
        console.log(" Rendering chart...");
        renderDashboardCharts(aktifCount, nonaktifCount, tunggakPelangganCount);
        
        // 5. LOAD AKTIVITAS
        console.log(" Loading aktivitas...");
        await loadAktivitas();
        
        // 6. INISIALISASI QUICK ACTIONS
        console.log(" Inisialisasi quick actions...");
        setTimeout(() => {
            initializeQuickActions();
        }, 500);
        
        // 7. SETUP AUTO REFRESH
        if (window.dashboardRefreshInterval) {
            clearInterval(window.dashboardRefreshInterval);
        }
        
        window.dashboardRefreshInterval = setInterval(() => {
            console.log(" Auto-refresh dashboard");
            refreshDashboardStats();
        }, 60000); // Refresh setiap 1 menit
        
        // 8. SEMBUNYIKAN LOADING
        setTimeout(() => {
            if (loadingEl) {
                loadingEl.classList.add('hidden');
            }
        }, 500);
        
        console.log(" RENDER DASHBOARD SELESAI");
        
        // 9. TAMPILKAN NOTIFIKASI JIKA ADA TUNGGAKAN
        if (tunggakanCount > 0) {
            setTimeout(() => {
                showToast('warning', 'Ada Tunggakan!', 
                    `Terdapat ${tunggakanCount} tagihan yang menunggak sebesar ${formatRupiah(totalTagihanBulanIni)}`);
            }, 1000);
        }
        
    } catch (error) {
        console.error(" ERROR dalam renderDashboard:", error);
        console.error("Error message:", error.message);
        
        // Set nilai default jika error
        document.getElementById('statPelanggan').textContent = '0';
        document.getElementById('statTagihanBulanan').textContent = 'Rp 0';
        document.getElementById('statLunas').textContent = '0';
        document.getElementById('statTunggakan').textContent = '0';
        
        // Sembunyikan loading
        document.getElementById('loadingOverlay')?.classList.add('hidden');
        
        showToast('error', 'Error Dashboard', 'Gagal memuat data dashboard');
    }
}

// FUNGSI REFRESH STATS ONLY
async function refreshDashboardStats() {
    try {
        console.log(" Refreshing dashboard stats...");
        
        // CEK APAKAH ELEMENT DASHBOARD MASIH ADA
        const isDashboardPage = document.querySelector('.dashboard-page') !== null;
        if (!isDashboardPage) {
            console.log(" Bukan halaman dashboard, skip refresh");
            return;
        }
        
        // WAIT UNTIL ELEMENTS ARE READY
        await waitForElement('#statPelanggan');
        
        const [pelangganSnapshot, tagihanSnapshot] = await Promise.all([
            db.collection('pelanggan').get(),
            db.collection('tagihan').get()
        ]);
        
        // Update Total Pelanggan
        const totalPelanggan = pelangganSnapshot.size;
        updateElementText('#statPelanggan', totalPelanggan);
        
        // Update Tagihan Bulan Ini
        const currentMonth = moment().format('YYYY-MM');
        let totalTagihanBulanIni = 0;
        let lunasCount = 0;
        let tunggakanCount = 0;
        
        tagihanSnapshot.forEach(doc => {
            const tagihan = doc.data();
            if (tagihan.bulan === currentMonth) {
                totalTagihanBulanIni += Number(tagihan.jumlah) || 0;
                
                if (tagihan.status === 'lunas') {
                    lunasCount++;
                } else if (tagihan.status === 'telat') {
                    tunggakanCount++;
                }
            }
        });
        
        updateElementText('#statTagihanBulanan', formatRupiah(totalTagihanBulanIni));
        updateElementText('#statLunas', lunasCount);
        updateElementText('#statTunggakan', tunggakanCount);
        
        console.log(" Dashboard stats refreshed");
        
    } catch (error) {
        console.error(" Error refreshing dashboard stats:", error);
    }
}

// HELPER FUNCTION: Wait for element
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const startTime = Date.now();
        
        function check() {
            const element = document.querySelector(selector);
            if (element) {
                resolve(element);
            } else if (Date.now() - startTime >= timeout) {
                reject(new Error(`Element ${selector} not found after ${timeout}ms`));
            } else {
                setTimeout(check, 100);
            }
        }
        
        check();
    });
}

// HELPER FUNCTION: Safe update element text
function updateElementText(selector, value) {
    const element = document.querySelector(selector);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(` Element ${selector} not found for update`);
    }
}

// FUNGSI RENDER CHART YANG SEDERHANA
// GANTI fungsi renderDashboardCharts() dengan yang ini:
function renderDashboardCharts(aktifCount, nonaktifCount, tunggakCount) {
    console.log(" Rendering charts dengan data REAL...");
    
    // Chart 1: Tagihan 6 Bulan Terakhir (REAL DATA)
    const ctx1 = document.getElementById('chartTagihan');
    if (ctx1) {
        try {
            if (window.tagihanChart) {
                window.tagihanChart.destroy();
            }
            
        // AMBIL DATA REAL DARI FIREBASE
        loadRealTagihanData().then(tagihanData => {
            const labels = tagihanData.map(t => t.bulan);
            const data = tagihanData.map(t => t.total);
            
            window.tagihanChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tagihan (Rp)',
                        data: data,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Jumlah Tagihan'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        }
                    }
                }
            });
            
            console.log(" Chart tagihan REAL berhasil dirender");
        });
            
        } catch (chartError) {
            console.error(" Error rendering tagihan chart:", chartError);
        }
    }
    
    // Chart 2: Status Pelanggan (tetap sama)
    const ctx2 = document.getElementById('chartStatus');
    if (ctx2) {
        try {
            if (window.statusChart) {
                window.statusChart.destroy();
            }
            
            window.statusChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Aktif', 'Tunggak', 'Nonaktif'],
                    datasets: [{
                        data: [aktifCount, tunggakCount, nonaktifCount],
                        backgroundColor: ['#00b894', '#ff6b6b', '#fdcb6e'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            console.log(" Chart status pelanggan berhasil dirender");
        } catch (chartError) {
            console.error(" Error rendering status chart:", chartError);
        }
    }
}

// FUNGSI BARU: Ambil data tagihan 6 bulan terakhir REAL dari Firebase
async function loadRealTagihanData() {
    console.log(" Mengambil data tagihan 6 bulan terakhir REAL...");
    
    try {
        // Buat array untuk 6 bulan terakhir
        const last6Months = [];
        for (let i = 5; i >= 0; i--) {
            const month = moment().subtract(i, 'months');
            last6Months.push({
                bulan: month.format('YYYY-MM'),
                label: month.format('MMM YY'),
                total: 0
            });
        }
        
        console.log("Bulan yang dicari:", last6Months.map(m => m.bulan));
        
        // Ambil semua tagihan
        const snapshot = await db.collection('tagihan').get();
        
        if (snapshot.empty) {
            console.log(" Tidak ada data tagihan");
            return last6Months; // Kembalikan dengan total 0
        }
        
        // Hitung total per bulan
        snapshot.docs.forEach(doc => {
            const tagihan = doc.data();
            const bulanTagihan = tagihan.bulan;
            
            // Cari bulan yang sesuai
            const bulanData = last6Months.find(m => m.bulan === bulanTagihan);
            if (bulanData) {
                bulanData.total += Number(tagihan.jumlah) || 0;
            }
        });
        
        console.log("Hasil perhitungan REAL:", last6Months);
        
        // Format untuk chart (gunakan label bukan bulan)
        const chartData = last6Months.map(month => ({
            bulan: month.label, // Pakai label untuk chart
            total: month.total
        }));
        
        return chartData;
        
    } catch (error) {
        console.error(" Error load real tagihan data:", error);
        // Fallback ke dummy data jika error
        return [
            { bulan: 'Jan 24', total: 5000000 },
            { bulan: 'Feb 24', total: 7500000 },
            { bulan: 'Mar 24', total: 6500000 },
            { bulan: 'Apr 24', total: 8000000 },
            { bulan: 'Mei 24', total: 9000000 },
            { bulan: 'Jun 24', total: 8500000 }
        ];
    }
}

// ============================================
// FUNGSI PAGINATION
// ============================================

function getPaginatedData(data, currentPage) {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return data.slice(startIndex, endIndex);
}

function renderPagination(totalItems, currentPage, pageType, containerId) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (totalPages <= 1) return '';
    
    let paginationHtml = '<div class="pagination">';
    
    // Previous button
    if (currentPage > 1) {
        paginationHtml += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage - 1})">&laquo;</a>`;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHtml += `<a class="page-link active">${i}</a>`;
        } else {
            paginationHtml += `<a class="page-link" onclick="changePage('${pageType}', ${i})">${i}</a>`;
        }
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHtml += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage + 1})">&raquo;</a>`;
    }
    
    paginationHtml += '</div>';
    
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = paginationHtml;
    }
    
    return paginationHtml;
}

function changePage(pageType, pageNumber) {
    switch(pageType) {
        case 'pelanggan':
            currentPagePelanggan = pageNumber;
            loadPelangganData();
            break;
        case 'tagihan':
            currentPageTagihan = pageNumber;
            loadTagihanData();
            break;
        case 'tunggakan':
            currentPageTunggakan = pageNumber;
            loadTunggakanData();
            break;
        case 'paket':
            currentPagePaket = pageNumber;
            loadPaketData();
            break;
    }
}

// PERBAIKAN fungsi renderDashboard() - tambah parameter:
async function renderDashboard() {
    console.log(" MEMULAI RENDER DASHBOARD dengan data REAL");
    
    try {
        // 1. TAMPILKAN LOADING
        const loadingEl = document.getElementById('loadingOverlay');
        if (loadingEl) {
            loadingEl.classList.remove('hidden');
        }
        
        // 2. AMBIL DATA DARI FIREBASE
        console.log(" Mengambil data REAL dari Firebase...");
        
        // Gunakan Promise.all untuk mengambil data secara paralel
        const [pelangganSnapshot, tagihanSnapshot] = await Promise.all([
            db.collection('pelanggan').get(),
            db.collection('tagihan').get()
        ]);
        
        console.log(` Data loaded: ${pelangganSnapshot.size} pelanggan, ${tagihanSnapshot.size} tagihan`);
        
        // 3. HITUNG STATISTIK
        
        // A. TOTAL PELANGGAN
        const totalPelanggan = pelangganSnapshot.size;
        console.log(` Total Pelanggan: ${totalPelanggan}`);
        
        // Update UI untuk Total Pelanggan
        const statPelangganEl = document.getElementById('statPelanggan');
        if (statPelangganEl) {
            statPelangganEl.textContent = totalPelanggan;
        }
        
        // B. TAGIHAN BULAN INI (REAL)
        const currentMonth = moment().format('YYYY-MM');
        console.log(` Bulan berjalan: ${currentMonth}`);
        
        let totalTagihanBulanIni = 0;
        let lunasCount = 0;
        let tunggakanCount = 0;
        let belumBayarCount = 0;
        
        // Filter tagihan untuk bulan ini
        tagihanSnapshot.forEach(doc => {
            const tagihan = doc.data();
            if (tagihan.bulan === currentMonth) {
                totalTagihanBulanIni += Number(tagihan.jumlah) || 0;
                
                if (tagihan.status === 'lunas') {
                    lunasCount++;
                } else if (tagihan.status === 'telat') {
                    tunggakanCount++;
                } else if (tagihan.status === 'belum') {
                    belumBayarCount++;
                }
            }
        });
        
        console.log(` Tagihan Bulan Ini REAL: ${formatRupiah(totalTagihanBulanIni)}`);
        console.log(` Lunas: ${lunasCount}`);
        console.log(` Tunggakan: ${tunggakanCount}`);
        console.log(` Belum Bayar: ${belumBayarCount}`);
        
        // Update UI untuk Tagihan Bulan Ini
        const statTagihanEl = document.getElementById('statTagihanBulanan');
        if (statTagihanEl) {
            statTagihanEl.textContent = formatRupiah(totalTagihanBulanIni);
        }
        
        // Update UI untuk Lunas
        const statLunasEl = document.getElementById('statLunas');
        if (statLunasEl) {
            statLunasEl.textContent = lunasCount;
        }
        
        // Update UI untuk Tunggakan
        const statTunggakanEl = document.getElementById('statTunggakan');
        if (statTunggakanEl) {
            statTunggakanEl.textContent = tunggakanCount;
        }
        
        // C. HITUNG STATUS PELANGGAN (REAL)
        let aktifCount = 0;
        let nonaktifCount = 0;
        let tunggakPelangganCount = 0;
        
        pelangganSnapshot.forEach(doc => {
            const pelanggan = doc.data();
            const status = pelanggan.status || 'nonaktif';
            
            if (status === 'aktif') {
                aktifCount++;
            } else if (status === 'nonaktif') {
                nonaktifCount++;
            } else if (status === 'tunggak') {
                tunggakPelangganCount++;
            }
        });
        
        console.log(` Status Pelanggan REAL: Aktif=${aktifCount}, Nonaktif=${nonaktifCount}, Tunggak=${tunggakPelangganCount}`);
        
        // 4. RENDER CHART DENGAN DATA REAL
        console.log(" Rendering chart dengan data REAL...");
        renderDashboardCharts(aktifCount, nonaktifCount, tunggakPelangganCount);
        
        // 5. LOAD AKTIVITAS
        console.log(" Loading aktivitas...");
        await loadAktivitas();
        
        // 6. INISIALISASI QUICK ACTIONS
        console.log(" Inisialisasi quick actions...");
        setTimeout(() => {
            initializeQuickActions();
        }, 500);
        
        // 7. SEMBUNYIKAN LOADING
        setTimeout(() => {
            if (loadingEl) {
                loadingEl.classList.add('hidden');
            }
        }, 500);
        
        console.log(" RENDER DASHBOARD SELESAI dengan data REAL");
        
        // 8. TAMPILKAN NOTIFIKASI JIKA ADA TUNGGAKAN
        if (tunggakanCount > 0) {
            setTimeout(() => {
                showToast('warning', 'Ada Tunggakan!', 
                    `Terdapat ${tunggakanCount} tagihan yang menunggak sebesar ${formatRupiah(totalTagihanBulanIni)}`);
            }, 1000);
        }
        
    } catch (error) {
        console.error(" ERROR dalam renderDashboard:", error);
        console.error("Error message:", error.message);
        
        // Set nilai default jika error
        document.getElementById('statPelanggan').textContent = '0';
        document.getElementById('statTagihanBulanan').textContent = 'Rp 0';
        document.getElementById('statLunas').textContent = '0';
        document.getElementById('statTunggakan').textContent = '0';
        
        // Sembunyikan loading
        document.getElementById('loadingOverlay')?.classList.add('hidden');
        
        showToast('error', 'Error Dashboard', 'Gagal memuat data dashboard');
    }
}

// TAMBAHKAN fungsi untuk refresh chart saja
function refreshTagihanChart() {
    console.log(" Refreshing tagihan chart...");
    
    // Hapus chart lama
    if (window.tagihanChart) {
        window.tagihanChart.destroy();
        window.tagihanChart = null;
    }
    
    // Load data baru dan render
    loadRealTagihanData().then(tagihanData => {
        const ctx1 = document.getElementById('chartTagihan');
        if (ctx1) {
            const labels = tagihanData.map(t => t.bulan);
            const data = tagihanData.map(t => t.total);
            
            window.tagihanChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tagihan (Rp)',
                        data: data,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });
            
            console.log(" Chart tagihan berhasil direfresh dengan data REAL");
        }
    });
}

// MODIFIKASI fungsi refreshDashboard() untuk include chart refresh
function refreshDashboard() {
    console.log(" Manual refresh dashboard dengan data REAL");
    
    // Tampilkan loading
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) loadingEl.classList.remove('hidden');
    
    // Refresh semua data
    renderDashboard().then(() => {
        // Refresh chart khusus
        setTimeout(() => {
            refreshTagihanChart();
        }, 1000);
    });
    
    showToast('info', 'Memperbarui', 'Dashboard sedang diperbarui dengan data terbaru...');
}

// FUNGSI REFRESH DASHBOARD (untuk tombol refresh)
function refreshDashboard() {
    console.log(" Manual refresh dashboard");
    renderDashboard();
    showToast('info', 'Memperbarui', 'Dashboard sedang diperbarui...');
}

        // ============================================
// FUNGSI TAMBAHAN (FIX TOMBOL & LOKASI)
// ============================================

// 1. Fungsi Get Location (Akurat)
function getLocation() {
    const coordInput = document.getElementById('pelangganKoordinat');
    
    if (!navigator.geolocation) {
        showToast('error', 'Error', 'GPS tidak didukung.');
        return;
    }

    // Jangan banyak notifikasi saat cari lokasi

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            coordInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            showToast('success', 'Sukses', 'Lokasi ditemukan.');
        },
        (error) => {
            // Jangan banyak toast error
            console.error("GPS Error:", error);
            showToast('error', 'Gagal', 'Gagal ambil lokasi (Cek GPS/WiFi).');
        },
        {
            enableHighAccuracy: true,
            timeout: 5000, // Cuma 5 DETIK
            maximumAge: 0
        }
    );
}

// 2. Event Listener Global (Fix Tombol Batal / X)
// ============================================
// PERBAIKAN TOMBOL BATAL & X (AGAR PASTI JALAN)
// ============================================

// PERBAIKAN EVENT HANDLER GLOBAL
document.addEventListener('click', function(e) {
    console.log(" Click event:", e.target);
    
    // 1. Tangkap Tombol Close (X)
    if (e.target.classList.contains('modal-close') || e.target.closest('.modal-close')) {
        e.preventDefault();
        e.stopPropagation();
        
        const modal = e.target.closest('.modal-overlay');
        if (modal) {
            console.log(" Closing modal via X button");
            forceCloseModal(modal.id);
        }
        return;
    }

    // 2. Tangkap Tombol Batal (teks "Batal")
    if (e.target.textContent.trim() === 'Batal' || 
        (e.target.tagName === 'BUTTON' && e.target.textContent.trim() === 'Batal')) {
        e.preventDefault();
        e.stopPropagation();
        
        const modal = e.target.closest('.modal-overlay');
        if (modal) {
            console.log(" Closing modal via Batal button");
            forceCloseModal(modal.id);
        }
        return;
    }
    
    // 3. Tangkap Tombol Tutup (teks "Tutup")
    if (e.target.textContent.trim() === 'Tutup' || 
        (e.target.tagName === 'BUTTON' && e.target.textContent.trim() === 'Tutup')) {
        e.preventDefault();
        e.stopPropagation();
        
        const modal = e.target.closest('.modal-overlay');
        if (modal) {
            console.log(" Closing modal via Tutup button");
            forceCloseModal(modal.id);
        }
        return;
    }
});

// TAMBAHKAN EVENT LISTENER untuk ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        console.log(" ESC pressed, closing all modals");
        
        // Tutup semua modal yang terbuka
        const openModals = document.querySelectorAll('.modal-overlay.show');
        openModals.forEach(modal => {
            forceCloseModal(modal.id);
        });
    }
});

// TAMBAHKAN EVENT LISTENER untuk klik di luar modal
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('show')) {
        console.log(" Click outside modal, closing:", e.target.id);
        forceCloseModal(e.target.id);
    }
});

// Fungsi Helper untuk Paksa Tutup Modal
// PERBAIKAN TOTAL untuk fungsi forceCloseModal
function forceCloseModal(modalId) {
    console.log(" Force closing modal:", modalId);
    
    const modalEl = document.getElementById(modalId);
    if (!modalEl) {
        console.error(" Modal tidak ditemukan:", modalId);
        return;
    }
    
    // HANYA ganti class, JANGAN ubah style langsung
    modalEl.classList.remove('show');
    modalEl.classList.add('hidden');
    
    // Restore body scroll
    document.body.style.overflow = 'auto';
    
    console.log(" Modal ditutup");
}

// Fungsi untuk show modal yang bener
function showModal(modalId) {
    const modalEl = document.getElementById(modalId);
    if (!modalEl) return;
    
    modalEl.classList.remove('hidden');
    modalEl.classList.add('show');
    document.body.style.overflow = 'hidden';
}
        
        async function loadAktivitas() {
            try {
                const snapshot = await db.collection('aktivitas')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                const table = document.getElementById('aktivitasTable');
                if (!table) return;
                
                if (snapshot.empty) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center">Tidak ada aktivitas</td>
                        </tr>
                    `;
                    return;
                }
                
                table.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return `
                        <tr>
                            <td>${moment(data.timestamp).format('DD/MM HH:mm')}</td>
                            <td>${data.aktivitas}</td>
                            <td>${data.user || 'System'}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error("Error loading activities:", error);
            }
        }
        
        function renderCharts() {
            // Chart 1: Tagihan 6 Bulan
            const ctx1 = document.getElementById('chartTagihan')?.getContext('2d');
            if (ctx1) {
                if (window.tagihanChart) {
                    window.tagihanChart.destroy();
                }
                
                window.tagihanChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: moment.monthsShort(),
                        datasets: [{
                            label: 'Tagihan (Rp)',
                            data: [5000000, 7500000, 6500000, 8000000, 9000000, 8500000, 9500000, 10000000, 11000000, 10500000, 12000000, 11500000],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatRupiah(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 2: Status Pelanggan
            const ctx2 = document.getElementById('chartStatus')?.getContext('2d');
            if (ctx2) {
                if (window.statusChart) {
                    window.statusChart.destroy();
                }
                
                window.statusChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aktif', 'Tunggak', 'Nonaktif'],
                        datasets: [{
                            data: [70, 15, 15],
                            backgroundColor: ['#00b894', '#ff6b6b', '#fdcb6e']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }
        
        async function loadPelangganData() {
    try {
        const snapshot = await db.collection('pelanggan').get();
        const allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // 10 DATA SAJA
        const start = (currentPagePelanggan - 1) * 10;
        const pageData = allData.slice(start, start + 10);
        
        // Render table
        const table = document.getElementById('pelangganTable');
        if (table) {
            table.innerHTML = pageData.map((p, i) => `
    <tr>
        <td>${start + i + 1}</td>
        <td><strong>${p.nama || '-'}</strong></td>
        <td>${p.telepon || '-'}</td>
        <td>${p.alamat?.substring(0, 40) || '-'}${p.alamat?.length > 40 ? '...' : ''}</td>
        <td>
            <span class="badge badge-primary">${p.paket || '-'}</span>
            <br>
            <small class="text-muted">${formatRupiah(p.harga || 0)}</small>
        </td>
        <td>
            <span class="badge ${p.status === 'aktif' ? 'badge-success' : 
                               p.status === 'tunggak' ? 'badge-danger' : 'badge-warning'}">
                ${p.status === 'aktif' ? 'Aktif' : 
                 p.status === 'tunggak' ? 'Tunggak' : 'Nonaktif'}
            </span>
        </td>
        <td>
            <!-- TOMBOL AKSI SEPERTI DI TAGIHAN -->
            <div class="btn-group">
                <button class="btn btn-sm btn-info" onclick="editPelanggan('${p.id}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-success" onclick="viewDetailPelanggan('${p.id}')" title="Detail">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deletePelanggan('${p.id}')" title="Hapus">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>
`).join('');
        }
        
        // PAGINATION DENGAN PANAH
        const totalPages = Math.ceil(allData.length / 10);
        const pagination = document.getElementById('pelangganPagination');
        if (pagination && totalPages > 1) {
            let html = '<div class="pagination">';
            
            // PANAH KIRI (Previous)
            if (currentPagePelanggan > 1) {
                html += `<a class="page-link" onclick="currentPagePelanggan = ${currentPagePelanggan - 1}; loadPelangganData();">&laquo; Prev</a>`;
            }
            
            // PAGE NUMBERS
            for (let i = 1; i <= totalPages; i++) {
                html += `<a class="page-link ${i === currentPagePelanggan ? 'active' : ''}" 
                         onclick="currentPagePelanggan = ${i}; loadPelangganData();">${i}</a>`;
            }
            
            // PANAH KANAN (Next)
            if (currentPagePelanggan < totalPages) {
                html += `<a class="page-link" onclick="currentPagePelanggan = ${currentPagePelanggan + 1}; loadPelangganData();">Next &raquo;</a>`;
            }
            
            html += '</div>';
            pagination.innerHTML = html;
        }
        
    } catch (error) {
        console.error("Error:", error);
    }
}

function renderPelangganTable(data, totalItems) {
    const table = document.getElementById('pelangganTable');
    if (!table) return;

    if (!data || data.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                    <i class="fas fa-search" style="font-size: 48px; color: #e9ecef; margin-bottom: 15px;"></i>
                    <h4 style="color: var(--gray);">Tidak ada data</h4>
                    <p>Tidak ada pelanggan yang sesuai dengan filter yang dipilih.</p>
                    <button class="btn btn-outline mt-2" onclick="document.getElementById('filterStatus').value=''; 
                                                                  document.getElementById('filterPaket').value=''; 
                                                                  document.getElementById('searchPelanggan').value=''; 
                                                                  loadPelangganData();">
                        <i class="fas fa-times"></i> Reset Filter
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    const startIndex = ((currentPagePelanggan - 1) * itemsPerPage);
    
    table.innerHTML = data.map((pelanggan, index) => {
        return `
            <tr>
                <td style="font-weight: bold;">${startIndex + index + 1}</td>
                <td><strong>${pelanggan.nama || '-'}</strong></td>
                <td>${pelanggan.telepon || '-'}</td>
                <td>${(pelanggan.alamat || '-').substring(0, 40)}${(pelanggan.alamat || '').length > 40 ? '...' : ''}</td>
                <td>
                    <span class="badge badge-primary">${pelanggan.paket || '-'}</span>
                    <br>
                    <small class="text-success">${formatRupiah(pelanggan.harga || 0)}/bln</small>
                </td>
                <td>
                    <span class="badge ${pelanggan.status === 'aktif' ? 'badge-success' : pelanggan.status === 'tunggak' ? 'badge-danger' : 'badge-warning'}">
                        <i class="fas ${pelanggan.status === 'aktif' ? 'fa-check-circle' : pelanggan.status === 'tunggak' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                        ${(pelanggan.status || 'nonaktif').charAt(0).toUpperCase() + (pelanggan.status || '').slice(1)}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPelanggan('${pelanggan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePelanggan('${pelanggan.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // UPDATE INFO
    const start = ((currentPagePelanggan - 1) * itemsPerPage) + 1;
    const end = Math.min(currentPagePelanggan * itemsPerPage, totalItems);
    
    document.getElementById('pelangganStart').textContent = start;
    document.getElementById('pelangganEnd').textContent = end;
    document.getElementById('pelangganTotal').textContent = totalItems;
}

function renderPelangganPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const container = document.getElementById('pelangganPagination');
    
    if (!container || totalPages <= 1) {
        if (container) container.innerHTML = '';
        return;
    }
    
    let paginationHtml = '<div class="pagination">';
    
    // Previous button
    if (currentPagePelanggan > 1) {
        paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan - 1})">&laquo;</a>`;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPagePelanggan) {
            paginationHtml += `<a class="page-link active">${i}</a>`;
        } else {
            paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${i})">${i}</a>`;
        }
    }
    
    // Next button
    if (currentPagePelanggan < totalPages) {
        paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan + 1})">&raquo;</a>`;
    }
    
    paginationHtml += '</div>';
    container.innerHTML = paginationHtml;
}





function renderPelangganTable(data) {
    const table = document.getElementById('pelangganTable');
    if (!table) return;

    if (!data || data.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                    <i class="fas fa-search" style="font-size: 48px; color: #e9ecef; margin-bottom: 15px;"></i>
                    <h4 style="color: var(--gray);">Tidak ada data</h4>
                    <p>Tidak ada pelanggan yang sesuai dengan filter yang dipilih.</p>
                    <button class="btn btn-outline mt-2" onclick="document.getElementById('filterStatus').value=''; 
                                                                  document.getElementById('filterPaket').value=''; 
                                                                  document.getElementById('searchPelanggan').value=''; 
                                                                  loadPelangganData();">
                        <i class="fas fa-times"></i> Reset Filter
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    const startIndex = ((currentPagePelanggan - 1) * itemsPerPage);
    
    table.innerHTML = data.map((pelanggan, index) => {
        return `
            <tr>
                <td style="font-weight: bold;">${startIndex + index + 1}</td>
                <td><strong>${pelanggan.nama}</strong></td>
                <td>${pelanggan.telepon}</td>
                <td>${pelanggan.alamat.substring(0, 40)}${pelanggan.alamat.length > 40 ? '...' : ''}</td>
                <td>
                    <span class="badge badge-primary">${pelanggan.paket}</span>
                    <br>
                    <small class="text-success">${formatRupiah(pelanggan.harga)}/bln</small>
                </td>
                <td>
                    <span class="badge ${pelanggan.status === 'aktif' ? 'badge-success' : pelanggan.status === 'tunggak' ? 'badge-danger' : 'badge-warning'}">
                        <i class="fas ${pelanggan.status === 'aktif' ? 'fa-check-circle' : pelanggan.status === 'tunggak' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                        ${pelanggan.status.charAt(0).toUpperCase() + pelanggan.status.slice(1)}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPelanggan('${pelanggan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePelanggan('${pelanggan.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function applyPelangganFilters(data) {
    const statusFilter = document.getElementById('filterStatus')?.value || '';
    const paketFilter = document.getElementById('filterPaket')?.value || '';
    const searchFilter = document.getElementById('searchPelanggan')?.value || '';
    
    return data.filter(pelanggan => {
        // Filter status
        if (statusFilter && pelanggan.status !== statusFilter) return false;
        
        // Filter paket
        if (paketFilter && pelanggan.paket !== paketFilter) return false;
        
        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (pelanggan.nama && pelanggan.nama.toLowerCase().includes(searchLower)) ||
                (pelanggan.telepon && pelanggan.telepon.includes(searchFilter)) ||
                (pelanggan.alamat && pelanggan.alamat.toLowerCase().includes(searchLower))
            );
        }
        
        return true;
    });
}

function renderPelangganTable(data) {
    const table = document.getElementById('pelangganTable');
    if (!table) return;
    
    if (data.length === 0) {
        table.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';
        return;
    }
    
    table.innerHTML = data.map((pelanggan, index) => {
        const startIndex = ((currentPagePelanggan - 1) * itemsPerPage);
        return `
            <tr>
                <td>${startIndex + index + 1}</td>
                <td><strong>${pelanggan.nama || '-'}</strong></td>
                <td>${pelanggan.telepon || '-'}</td>
                <td>${pelanggan.alamat?.substring(0, 30) || '-'}${pelanggan.alamat?.length > 30 ? '...' : ''}</td>
                <td>
                    <span class="badge badge-primary">${pelanggan.paket || '-'}</span><br>
                    <small>${formatRupiah(pelanggan.harga || 0)}</small>
                </td>
                <td>
                    <span class="badge ${pelanggan.status === 'aktif' ? 'badge-success' : pelanggan.status === 'tunggak' ? 'badge-danger' : 'badge-warning'}">
                        ${pelanggan.status || 'nonaktif'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPelanggan('${pelanggan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePelanggan('${pelanggan.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// FUNGSI SEBENARNYA UNTUK LOAD DATA
async function loadPelangganDataActual(tableBody) {
    console.log(" Mengambil data dari Firebase...");
    
    // AMBIL DATA DENGAN RETRY LOGIC
    let retryCount = 0;
    const maxRetries = 2;
    
    while (retryCount <= maxRetries) {
        try {
            const snapshot = await db.collection('pelanggan').get();
            
            if (snapshot.empty) {
                console.log(" Database pelanggan kosong");
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 48px; color: #e9ecef;"></i>
                            <h4 class="mt-3 text-muted">Database Kosong</h4>
                            <p>Belum ada data pelanggan</p>
                            <button class="btn btn-primary mt-2" onclick="showAddPelangganModal()">
                                <i class="fas fa-plus"></i> Tambah Pelanggan Pertama
                            </button>
                        </td>
                    </tr>
                `;
                pelangganData = [];
                return;
            }
            
            pelangganData = snapshot.docs.map(doc => ({
                id: doc.id,
                nama: doc.data().nama || 'Tidak ada nama',
                telepon: doc.data().telepon || '-',
                alamat: doc.data().alamat || '-',
                paket: doc.data().paket || '-',
                harga: doc.data().harga || 0,
                status: doc.data().status || 'nonaktif',
                email: doc.data().email || `${doc.data().telepon || ''}@xbill.com`
            }));
            
            console.log(` ${pelangganData.length} pelanggan berhasil dimuat`);
            
            // RENDER TABLE
            renderPelangganTable();
            break; // BERHASIL, KELUAR DARI LOOP
            
        } catch (error) {
            retryCount++;
            console.warn(` Retry ${retryCount}/${maxRetries}:`, error.message);
            
            if (retryCount > maxRetries) {
                throw error; // GAGAL SETELAH MAX RETRY
            }
            
            // TUNGGU SEBELUM RETRY
            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
        }
    }
}

// FUNGSI RENDER PELANGGAN TABLE - PERBAIKAN
function renderPelangganTable() {
    console.log("Memulai renderPelangganTable...");
    console.log("Data yang akan dirender:", pelangganData);
    
    const table = document.getElementById('pelangganTable');
    if (!table) {
        console.error("ERROR: Tabel pelangganTable tidak ditemukan untuk dirender!");
        return;
    }

    if (!pelangganData || pelangganData.length === 0) {
        console.log("Data pelanggan kosong, menampilkan pesan kosong");
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                    <i class="fas fa-search" style="font-size: 48px; color: #e9ecef; margin-bottom: 15px;"></i>
                    <h4 style="color: var(--gray);">Tidak ada data</h4>
                    <p>Tidak ada pelanggan yang sesuai dengan filter yang dipilih.</p>
                    <button class="btn btn-outline mt-2" onclick="document.getElementById('filterStatus').value=''; 
                                                                  document.getElementById('filterPaket').value=''; 
                                                                  document.getElementById('searchPelanggan').value=''; 
                                                                  loadPelangganData();">
                        <i class="fas fa-times"></i> Reset Filter
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    console.log("Merender", pelangganData.length, "baris data");
    
    table.innerHTML = pelangganData.map((pelanggan, index) => {
        // Pastikan semua field memiliki nilai default
        const nama = pelanggan.nama || '-';
        const telepon = pelanggan.telepon || '-';
        const alamat = pelanggan.alamat || '-';
        const paket = pelanggan.paket || '-';
        const harga = pelanggan.harga || 0;
        const status = pelanggan.status || 'nonaktif';
        
        // Tentukan warna badge berdasarkan status
        let badgeClass = 'badge-warning';
        if (status === 'aktif') badgeClass = 'badge-success';
        if (status === 'tunggak') badgeClass = 'badge-danger';
        
        return `
            <tr>
                <td style="font-weight: bold;">${index + 1}</td>
                <td>
                    <strong>${nama}</strong>
                    ${pelanggan.email ? `<br><small class="text-muted">${pelanggan.email}</small>` : ''}
                </td>
                <td>${telepon}</td>
                <td>
                    ${alamat.substring(0, 40)}${alamat.length > 40 ? '...' : ''}
                    ${pelanggan.koordinat ? `<br><small class="text-info"><i class="fas fa-map-marker-alt"></i> ${pelanggan.koordinat}</small>` : ''}
                </td>
                <td>
                    <span class="badge badge-primary">${paket}</span>
                    <br>
                    <small class="text-success">${formatRupiah(harga)}/bln</small>
                </td>
                <td>
                    <span class="badge ${badgeClass}">
                        <i class="fas ${status === 'aktif' ? 'fa-check-circle' : status === 'tunggak' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPelanggan('${pelanggan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="viewDetailPelanggan('${pelanggan.id}')" title="Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline btn-danger" onclick="deletePelanggan('${pelanggan.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    console.log("Render tabel selesai");
}

// TAMBAHKAN FUNGSI VIEW DETAIL (Opsional, untuk tombol detail)
async function viewDetailPelanggan(id) {
    try {
        const doc = await db.collection('pelanggan').doc(id).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data pelanggan tidak ditemukan');
            return;
        }
        
        const data = doc.data();
        let detailHtml = `
            <div style="padding: 20px;">
                <h4>Detail Pelanggan</h4>
                <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                    <tr><td><strong>Nama</strong></td><td>${data.nama || '-'}</td></tr>
                    <tr><td><strong>Telepon</strong></td><td>${data.telepon || '-'}</td></tr>
                    <tr><td><strong>Email</strong></td><td>${data.email || '-'}</td></tr>
                    <tr><td><strong>Alamat</strong></td><td>${data.alamat || '-'}</td></tr>
                    <tr><td><strong>Paket</strong></td><td>${data.paket || '-'} (${formatRupiah(data.harga || 0)})</td></tr>
                    <tr><td><strong>Status</strong></td><td>${data.status || '-'}</td></tr>
                    <tr><td><strong>Tanggal Pasang</strong></td><td>${data.tanggal_pasang || '-'}</td></tr>
                    <tr><td><strong>Koordinat</strong></td><td>${data.koordinat || '-'}</td></tr>
                    <tr><td><strong>Catatan</strong></td><td>${data.catatan || '-'}</td></tr>
                </table>
            </div>
        `;
        
        // Buat modal detail sederhana
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-user"></i> Detail Pelanggan</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${detailHtml}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="editPelanggan('${id}')">
                        <i class="fas fa-edit"></i> Edit Data
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error viewing detail:", error);
        showToast('error', 'Error', 'Gagal memuat detail pelanggan');
    }
}
        
        function renderPelangganTable() {
    const table = document.getElementById('pelangganTable');
    if (!table) return;

    if (!pelangganData || pelangganData.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-inbox"></i> Tidak ada data pelanggan ditemukan
                </td>
            </tr>
        `;
        return;
    }
    
    table.innerHTML = pelangganData.map((pelanggan, index) => {
        // Cegah error jika field undefined
        const nama = pelanggan.nama || '-';
        const telepon = pelanggan.telepon || '-';
        const alamat = pelanggan.alamat || '-';
        const paket = pelanggan.paket || '-';
        const harga = pelanggan.harga || 0;
        const status = pelanggan.status || 'nonaktif';
        
        return `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${nama}</strong></td>
                <td>${telepon}</td>
                <td>${alamat.substring(0, 30)}${alamat.length > 30 ? '...' : ''}</td>
                <td>
                    <span class="badge badge-primary">${paket}</span><br>
                    <small>${formatRupiah(harga)}</small>
                </td>
                <td>
                    <span class="badge ${status === 'aktif' ? 'badge-success' : status === 'tunggak' ? 'badge-danger' : 'badge-warning'}">
                        ${status}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPelanggan('${pelanggan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePelanggan('${pelanggan.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}
        
        async function loadPaketData() {
    try {
        const snapshot = await db.collection('paket').get();
        paketData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // 10 DATA SAJA
        const start = (currentPagePaket - 1) * 10;
        const pageData = paketData.slice(start, start + 10);
        
        // Render table
        const table = document.getElementById('paketTable');
        if (table && currentPage === 'paket') {
            table.innerHTML = pageData.map((p, i) => `
                <tr>
                    <td><strong>${p.nama}</strong></td>
                    <td>${p.kecepatan}</td>
                    <td>${formatRupiah(p.harga)}</td>
                    <td>${p.kuota || 'Unlimited'}</td>
                    <td><span class="badge">${p.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="editPaket('${p.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePaket('${p.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // PAGINATION DENGAN PANAH
        if (currentPage === 'paket') {
            const totalPages = Math.ceil(paketData.length / 10);
            const pagination = document.getElementById('paketPagination');
            if (pagination && totalPages > 1) {
                let html = '<div class="pagination">';
                
                // PANAH KIRI
                if (currentPagePaket > 1) {
                    html += `<a class="page-link" onclick="currentPagePaket = ${currentPagePaket - 1}; loadPaketData();">&laquo; Prev</a>`;
                }
                
                // PAGE NUMBERS
                for (let i = 1; i <= totalPages; i++) {
                    html += `<a class="page-link ${i === currentPagePaket ? 'active' : ''}" 
                             onclick="currentPagePaket = ${i}; loadPaketData();">${i}</a>`;
                }
                
                // PANAH KANAN
                if (currentPagePaket < totalPages) {
                    html += `<a class="page-link" onclick="currentPagePaket = ${currentPagePaket + 1}; loadPaketData();">Next &raquo;</a>`;
                }
                
                html += '</div>';
                pagination.innerHTML = html;
            }
        }
        
    } catch (error) {
        console.error("Error:", error);
    }
}

function renderPaketTable(data) {
    const table = document.getElementById('paketTable');
    if (!table) return;
    
    if (data.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>';
        return;
    }
    
    table.innerHTML = data.map((paket, index) => {
        const startIndex = ((currentPagePaket - 1) * itemsPerPage);
        return `
            <tr>
                <td><strong>${paket.nama}</strong><br><small>${paket.deskripsi || ''}</small></td>
                <td>${paket.kecepatan}</td>
                <td>${formatRupiah(paket.harga)}</td>
                <td>${paket.kuota || 'Unlimited'}</td>
                <td>
                    <span class="badge ${paket.status === 'aktif' ? 'badge-success' : 'badge-warning'}">
                        ${paket.status === 'aktif' ? 'Aktif' : 'Nonaktif'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPaket('${paket.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePaket('${paket.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}
        
        async function loadTagihanData() {
    try {
        const snapshot = await db.collection('tagihan').get();
        const allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // 10 DATA SAJA
        const start = (currentPageTagihan - 1) * 10;
        const pageData = allData.slice(start, start + 10);
        
        // Render table DENGAN STATUS
        const table = document.getElementById('tagihanTable');
        if (table) {
            table.innerHTML = pageData.map((t, i) => {
                // Tentukan badge status
                let statusBadge = '';
                let statusText = '';
                
                if (t.status === 'lunas') {
                    statusBadge = 'badge-success';
                    statusText = 'Lunas';
                } else if (t.status === 'telat') {
                    statusBadge = 'badge-danger';
                    statusText = 'Telat';
                } else {
                    statusBadge = 'badge-warning';
                    statusText = 'Belum Bayar';
                }
                
                return `
                    <tr>
                        <td><strong>${t.id?.substring(0, 12)}...</strong></td>
                        <td><strong>${t.pelanggan_nama || '-'}</strong></td>
                        <td>${t.bulan || '-'}</td>
                        <td><strong>${formatRupiah(t.jumlah || 0)}</strong></td>
                        <td>${t.tanggal_jatuh_tempo ? moment(t.tanggal_jatuh_tempo).format('DD/MM/YYYY') : '-'}</td>
                        <td>
                            <span class="badge ${statusBadge}">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                ${t.status !== 'lunas' ? `
                                    <button class="btn btn-sm btn-success" onclick="bayarTagihan('${t.id}')" title="Bayar">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </button>
                                ` : ''}
                                
                                ${t.status !== 'lunas' ? `
                                   <button class="btn btn-sm btn-warning" onclick="sendWhatsAppReminder('${t.id}')" title="Kirim WhatsApp">
                                    <i class="fab fa-whatsapp"></i>
                                </button>

                                <button class="btn btn-sm btn-info" onclick="showTagihanDetail('${t.id}')" title="Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // PAGINATION DENGAN PANAH
        const totalPages = Math.ceil(allData.length / 10);
        const pagination = document.getElementById('tagihanPagination');
        if (pagination && totalPages > 1) {
            let html = '<div class="pagination">';
            
            // PANAH KIRI
            if (currentPageTagihan > 1) {
                html += `<a class="page-link" onclick="currentPageTagihan = ${currentPageTagihan - 1}; loadTagihanData();">&laquo; Prev</a>`;
            }
            
            // PAGE NUMBERS
            for (let i = 1; i <= totalPages; i++) {
                html += `<a class="page-link ${i === currentPageTagihan ? 'active' : ''}" 
                         onclick="currentPageTagihan = ${i}; loadTagihanData();">${i}</a>`;
            }
            
            // PANAH KANAN
            if (currentPageTagihan < totalPages) {
                html += `<a class="page-link" onclick="currentPageTagihan = ${currentPageTagihan + 1}; loadTagihanData();">Next &raquo;</a>`;
            }
            
            html += '</div>';
            pagination.innerHTML = html;
        }
        
    } catch (error) {
        console.error("Error:", error);
    }
}

function applyTagihanFilters(data) {
    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';
    
    return data.filter(tagihan => {
        // Filter bulan
        if (bulanFilter && tagihan.bulan !== bulanFilter) return false;
        
        // Filter status
        if (statusFilter && tagihan.status !== statusFilter) return false;
        
        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (tagihan.pelanggan_nama && tagihan.pelanggan_nama.toLowerCase().includes(searchLower)) ||
                (tagihan.id && tagihan.id.toLowerCase().includes(searchLower)) ||
                (tagihan.bulan && tagihan.bulan.includes(searchFilter))
            );
        }
        
        return true;
    });
}

function renderTagihanTable(data) {
    const table = document.getElementById('tagihanTable');
    if (!table) return;
    
    if (data.length === 0) {
        table.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';
        return;
    }
    
    table.innerHTML = data.map((tagihan, index) => {
        const startIndex = ((currentPageTagihan - 1) * itemsPerPage);
        const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
        const hariTerlambat = tagihan.status === 'telat' ? moment().diff(jatuhTempo, 'days') : 0;
        
        return `
            <tr>
                <td><strong>${tagihan.id?.substring(0, 12)}...</strong></td>
                <td><strong>${tagihan.pelanggan_nama || '-'}</strong></td>
                <td>${tagihan.bulan || '-'}</td>
                <td><strong>${formatRupiah(tagihan.jumlah || 0)}</strong></td>
                <td>${jatuhTempo.format('DD/MM/YYYY')}</td>
                <td>
                    <span class="badge ${tagihan.status === 'lunas' ? 'badge-success' : 
                                       tagihan.status === 'telat' ? 'badge-danger' : 'badge-warning'}">
                        ${tagihan.status === 'lunas' ? 'Lunas' : 
                         tagihan.status === 'telat' ? 'Telat' : 'Belum Bayar'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        ${tagihan.status !== 'lunas' ? `
                            <button class="btn btn-sm btn-success" onclick="bayarTagihan('${tagihan.id}')">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-info" onclick="viewInvoice('${tagihan.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// FUNGSI BARU: Apply filter di client side
function applyTagihanFilters() {
    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';
    
    console.log("Filter:", { bulanFilter, statusFilter, searchFilter });
    
    // Clone data asli
    let filteredData = [...tagihanData];
    
    // Filter bulan
    if (bulanFilter) {
        filteredData = filteredData.filter(t => t.bulan === bulanFilter);
    }
    
    // Filter status
    if (statusFilter) {
        filteredData = filteredData.filter(t => t.status === statusFilter);
    }
    
    // Filter search
    if (searchFilter) {
        const searchLower = searchFilter.toLowerCase();
        filteredData = filteredData.filter(t => 
            (t.pelanggan_nama && t.pelanggan_nama.toLowerCase().includes(searchLower)) ||
            (t.id && t.id.toLowerCase().includes(searchLower)) ||
            (t.bulan && t.bulan.includes(searchFilter))
        );
    }
    
    // Update global variable
    tagihanData = filteredData;
    
    // Render tabel
    renderTagihanTable();
}
        
        function renderTagihanTable() {
    const table = document.getElementById('tagihanTable');
    if (!table) return;
    
    if (tagihanData.length === 0) {
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center" style="padding: 40px;">
                    <i class="fas fa-inbox" style="font-size: 48px; color: #e9ecef;"></i>
                    <h4 class="mt-3" style="color: var(--gray);">Tidak ada tagihan</h4>
                    <p>Belum ada tagihan untuk ditampilkan</p>
                    <button class="btn btn-primary mt-2" onclick="showModal('modalGenerateTagihan')">
                        <i class="fas fa-bolt"></i> Generate Tagihan
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    table.innerHTML = tagihanData.map(tagihan => {
        const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
        const hariTerlambat = tagihan.status === 'telat' ? moment().diff(jatuhTempo, 'days') : 0;
        const denda = tagihan.status === 'telat' ? Math.round(tagihan.jumlah * 0.02) : 0;
        const totalBayar = tagihan.jumlah + denda;
        
        return `
            <tr>
                <td>
                    <strong>${tagihan.id.substring(0, 12)}...</strong>
                    <br>
                    <small class="text-muted">${tagihan.pelanggan_id?.substring(0, 8) || ''}</small>
                </td>
                <td>
                    <strong>${tagihan.pelanggan_nama || '-'}</strong>
                    <br>
                    <small class="text-muted">${tagihan.pelanggan_telepon || ''}</small>
                </td>
                <td>
                    ${tagihan.bulan || '-'}
                    <br>
                    <small class="badge ${tagihan.prorata ? 'badge-info' : 'badge-secondary'}">
                        ${tagihan.prorata ? 'Prorata' : 'Normal'}
                    </small>
                </td>
                <td>
                    <strong>${formatRupiah(tagihan.jumlah || 0)}</strong>
                    ${denda > 0 ? `<br><small class="text-danger">Denda: ${formatRupiah(denda)}</small>` : ''}
                </td>
                <td>
                    ${jatuhTempo.format('DD/MM/YYYY')}
                    ${hariTerlambat > 0 ? `
                        <br>
                        <span class="badge badge-danger">
                            <i class="fas fa-clock"></i> Telat ${hariTerlambat} hari
                        </span>
                    ` : ''}
                </td>
                <td>
                    <span class="badge ${tagihan.status === 'lunas' ? 'badge-success' : 
                                       tagihan.status === 'telat' ? 'badge-danger' : 'badge-warning'}">
                        <i class="fas ${tagihan.status === 'lunas' ? 'fa-check-circle' : 
                                      tagihan.status === 'telat' ? 'fa-exclamation-triangle' : 'fa-clock'}"></i>
                        ${tagihan.status === 'lunas' ? 'Lunas' : 
                         tagihan.status === 'telat' ? 'Telat' : 'Belum Bayar'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <!-- TOMBOL BAYAR - HANYA UNTUK YANG BELUM LUNAS -->
                        ${tagihan.status !== 'lunas' ? `
                            <button class="btn btn-sm btn-success" onclick="bayarTagihan('${tagihan.id}')" title="Bayar Tagihan">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        ` : ''}
                        
                        <!-- TOMBOL DETAIL - SEMUA TAGIHAN -->
                        <button class="btn btn-sm btn-info" onclick="viewInvoice('${tagihan.id}')" title="Lihat Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        
                        <!-- TOMBOL REMINDER - UNTUK YANG BELUM LUNAS -->
                        ${tagihan.status !== 'lunas' ? `
                            <button class="btn btn-sm btn-warning" onclick="sendReminderSingle('${tagihan.pelanggan_id}')" title="Kirim Reminder">
                                <i class="fas fa-envelope"></i>
                            </button>
                        ` : ''}
                        
                        <!-- TOMBOL PRINT - KHUSUS YANG SUDAH LUNAS -->
                        ${tagihan.status === 'lunas' ? `
                            <button class="btn btn-sm btn-secondary" onclick="printInvoice('${tagihan.id}')" title="Print Invoice">
                                <i class="fas fa-print"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}
        
        async function loadTunggakanData() {
    try {
        console.log("Memuat data tunggakan...");
        
        // AMBIL SEMUA DATA, FILTER DI CLIENT
        const snapshot = await db.collection('tagihan').get();
        
        const allTagihanData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        // Filter hanya yang status telat
        const tunggakanData = allTagihanData.filter(t => t.status === 'telat');
        
        console.log(`Total tunggakan: ${tunggakanData.length}`);
        
        // Calculate categories
        const ringan = tunggakanData.filter(t => {
            const hariTerlambat = moment().diff(moment(t.tanggal_jatuh_tempo), 'days');
            return hariTerlambat <= 30;
        });
        
        const sedang = tunggakanData.filter(t => {
            const hariTerlambat = moment().diff(moment(t.tanggal_jatuh_tempo), 'days');
            return hariTerlambat > 30 && hariTerlambat <= 60;
        });
        
        const berat = tunggakanData.filter(t => {
            const hariTerlambat = moment().diff(moment(t.tanggal_jatuh_tempo), 'days');
            return hariTerlambat > 60;
        });
        
        // Update stats
        const tunggakanRinganEl = document.getElementById('tunggakanRingan');
        const tunggakanSedangEl = document.getElementById('tunggakanSedang');
        const tunggakanBeratEl = document.getElementById('tunggakanBerat');
        const totalTunggakanEl = document.getElementById('totalTunggakan');
        
        if (tunggakanRinganEl) tunggakanRinganEl.textContent = ringan.length;
        if (tunggakanSedangEl) tunggakanSedangEl.textContent = sedang.length;
        if (tunggakanBeratEl) tunggakanBeratEl.textContent = berat.length;
        
        const totalTunggakan = tunggakanData.reduce((sum, t) => sum + (t.jumlah || 0), 0);
        if (totalTunggakanEl) totalTunggakanEl.textContent = formatRupiah(totalTunggakan);
        
        // Render table
        const table = document.getElementById('tunggakanTable');
        if (table) {
            if (tunggakanData.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: #e9ecef;"></i>
                            <h4 style="margin-top: 15px;">Tidak ada tunggakan</h4>
                            <p>Semua tagihan sudah dibayar tepat waktu!</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = tunggakanData.map(t => {
                const hariTerlambat = moment().diff(moment(t.tanggal_jatuh_tempo), 'days');
                const denda = Math.round(t.jumlah * Math.min(0.1, 0.02 * Math.floor(hariTerlambat / 30)));
                let kategori = '';
                if (hariTerlambat <= 30) kategori = 'ringan';
                else if (hariTerlambat <= 60) kategori = 'sedang';
                else kategori = 'berat';
                
                return `
                    <tr>
                        <td><strong>${t.pelanggan_nama || '-'}</strong></td>
                        <td><code>${t.id.substring(0, 10)}...</code></td>
                        <td>${moment(t.tanggal_jatuh_tempo).format('DD/MM/YYYY')}</td>
                        <td>
                            <span class="badge ${kategori === 'ringan' ? 'badge-warning' : 
                                               kategori === 'sedang' ? 'badge-danger' : 'badge-primary'}">
                                ${hariTerlambat} hari
                            </span>
                        </td>
                        <td>${formatRupiah(t.jumlah || 0)}</td>
                        <td>${formatRupiah(denda)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-success" onclick="bayarTagihan('${t.id}')">
                                    <i class="fas fa-money-bill-wave"></i> Bayar
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="sendReminderSingle('${t.pelanggan_id}')">
                                    <i class="fas fa-envelope"></i> Reminder
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
    } catch (error) {
        console.error("Error loading tunggakan:", error);
        showToast('error', 'Error', 'Gagal memuat data tunggakan');
    }
}

// ============================================
// FUNGSI INISIALISASI DATABASE OTOMATIS
// ============================================

async function initializeDatabase() {
    console.log(" Memulai inisialisasi database...");
    
    try {
        // 1. CEK APAKAH DATABASE SUDAH ADA
        console.log(" Mengecek struktur database...");
        
        // Cek apakah ada data di collections
        const [pelangganSnapshot, paketSnapshot, tagihanSnapshot] = await Promise.all([
            db.collection('pelanggan').limit(1).get(),
            db.collection('paket').limit(1).get(),
            db.collection('tagihan').limit(1).get()
        ]);
        
        const hasData = !pelangganSnapshot.empty || !paketSnapshot.empty || !tagihanSnapshot.empty;
        
        if (hasData) {
            console.log(" Database sudah ada, tidak perlu inisialisasi");
            return;
        }
        
        console.log(" Database kosong, membuat data awal...");
        
        // 2. BUAT COLLECTION PAKET TERLEBIH DAHULU
        console.log(" Membuat data paket internet...");
        await createInitialPackages();
        
        // 3. BUAT COLLECTION PELANGGAN
        console.log(" Membuat data pelanggan contoh...");
        await createInitialCustomers();
        
        // 4. BUAT COLLECTION TAGIHAN
        console.log(" Membuat data tagihan contoh...");
        await createInitialInvoices();
        
        // 5. BUAT COLLECTION AKTIVITAS
        console.log(" Membuat log aktivitas...");
        await createInitialActivities();
        
        // 6. BUAT INDEX OTOMATIS (jika perlu)
        console.log(" Mengecek index...");
        await checkAndCreateIndexes();
        
        console.log(" Inisialisasi database selesai!");
        showToast('success', 'Database Siap', 'Database berhasil diinisialisasi dengan data contoh');
        
    } catch (error) {
        console.error(" Error inisialisasi database:", error);
        showToast('error', 'Error', 'Gagal menginisialisasi database: ' + error.message);
    }
}

// FUNGSI UNTUK MEMBUAT PAKET INTERNET AWAL
async function createInitialPackages() {
    const packages = [
        {
            id: 'PAKET_1',
            nama: 'Paket 10 Mbps',
            kecepatan: '10 Mbps',
            harga: 150000,
            kuota: 'Unlimited',
            deskripsi: 'Paket hemat untuk penggunaan ringan',
            fitur: 'Unlimited Bandwidth,Support 24/7,1 User',
            warna: '#4361ee',
            status: 'aktif',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            id: 'PAKET_2',
            nama: 'Paket 20 Mbps',
            kecepatan: '20 Mbps',
            harga: 250000,
            kuota: 'Unlimited',
            deskripsi: 'Paket standar untuk keluarga',
            fitur: 'Unlimited Bandwidth,Support 24/7,5 User,Gaming Ready',
            warna: '#00b894',
            status: 'aktif',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            id: 'PAKET_3',
            nama: 'Paket 50 Mbps',
            kecepatan: '50 Mbps',
            harga: 350000,
            kuota: 'Unlimited',
            deskripsi: 'Paket bisnis untuk kantor kecil',
            fitur: 'Unlimited Bandwidth,Priority Support,10 User,Static IP',
            warna: '#ff6b6b',
            status: 'aktif',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            id: 'PAKET_4',
            nama: 'Paket 100 Mbps',
            kecepatan: '100 Mbps',
            harga: 500000,
            kuota: 'Unlimited',
            deskripsi: 'Paket premium untuk kebutuhan berat',
            fitur: 'Unlimited Bandwidth,Priority Support,Unlimited User,Static IP,Backup Line',
            warna: '#fdcb6e',
            status: 'aktif',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }
    ];
    
    const batch = db.batch();
    
    packages.forEach(pkg => {
        const paketRef = db.collection('paket').doc(pkg.id);
        batch.set(paketRef, pkg);
    });
    
    await batch.commit();
    console.log(` ${packages.length} paket berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT PELANGGAN AWAL
async function createInitialCustomers() {
    const customers = [
        {
            id: 'CUST_001',
            nama: 'Budi Santoso',
            telepon: '081234567890',
            email: 'budi@gmail.com',
            alamat: 'Jl. Merdeka No. 123, Jakarta Pusat',
            koordinat: '-6.2088, 106.8456',
            paket: 'Paket 20 Mbps',
            harga: 250000,
            tanggal_pasang: moment().subtract(6, 'months').format('YYYY-MM-DD'),
            status: 'aktif',
            catatan: 'Pelanggan setia sejak 2023',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            id: 'CUST_002',
            nama: 'Siti Rahayu',
            telepon: '082345678901',
            email: 'siti@yahoo.com',
            alamat: 'Jl. Sudirman No. 456, Jakarta Selatan',
            koordinat: '-6.2250, 106.8050',
            paket: 'Paket 10 Mbps',
            harga: 150000,
            tanggal_pasang: moment().subtract(3, 'months').format('YYYY-MM-DD'),
            status: 'aktif',
            catatan: 'Pelanggan baru, bayar tepat waktu',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            id: 'CUST_003',
            nama: 'Ahmad Hidayat',
            telepon: '083456789012',
            email: 'ahmad@gmail.com',
            alamat: 'Jl. Thamrin No. 789, Jakarta Pusat',
            koordinat: '-6.1865, 106.8227',
            paket: 'Paket 50 Mbps',
            harga: 350000,
            tanggal_pasang: moment().subtract(1, 'year').format('YYYY-MM-DD'),
            status: 'tunggak',
            catatan: 'Sering telat bayar',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            id: 'CUST_004',
            nama: 'Dewi Lestari',
            telepon: '084567890123',
            email: 'dewi@gmail.com',
            alamat: 'Jl. Gatot Subroto No. 321, Jakarta Selatan',
            koordinat: '-6.2349, 106.8116',
            paket: 'Paket 100 Mbps',
            harga: 500000,
            tanggal_pasang: moment().subtract(2, 'months').format('YYYY-MM-DD'),
            status: 'aktif',
            catatan: 'Kantor kecil, butuh koneksi stabil',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        },
        {
            id: 'CUST_005',
            nama: 'Joko Widodo',
            telepon: '085678901234',
            email: 'joko@outlook.com',
            alamat: 'Jl. Kebon Sirih No. 111, Jakarta Pusat',
            koordinat: '-6.1818, 106.8365',
            paket: 'Paket 20 Mbps',
            harga: 250000,
            tanggal_pasang: moment().subtract(8, 'months').format('YYYY-MM-DD'),
            status: 'nonaktif',
            catatan: 'Pindah kota',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        }
    ];
    
    const batch = db.batch();
    
    customers.forEach(customer => {
        const custRef = db.collection('pelanggan').doc(customer.id);
        batch.set(custRef, customer);
    });
    
    await batch.commit();
    console.log(` ${customers.length} pelanggan berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT TAGIHAN AWAL
async function createInitialInvoices() {
    const invoices = [];
    
    // Tagihan untuk 6 bulan terakhir
    for (let i = 0; i < 6; i++) {
        const month = moment().subtract(i, 'months').format('YYYY-MM');
        
        // Tagihan untuk Budi Santoso
        invoices.push({
            id: `INV_BUDI_${month}`,
            pelanggan_id: 'CUST_001',
            pelanggan_nama: 'Budi Santoso',
            pelanggan_email: 'budi@gmail.com',
            pelanggan_telepon: '081234567890',
            bulan: month,
            jumlah: 250000,
            status: i === 0 ? 'belum' : 'lunas', // Bulan ini belum bayar, sebelumnya lunas
            tanggal_jatuh_tempo: moment(`${month}-10`).format('YYYY-MM-DD'),
            tanggal_dibuat: moment().subtract(i, 'months').format('YYYY-MM-DD'),
            prorata: false,
            denda: 0
        });
        
        // Tagihan untuk Siti Rahayu
        invoices.push({
            id: `INV_SITI_${month}`,
            pelanggan_id: 'CUST_002',
            pelanggan_nama: 'Siti Rahayu',
            pelanggan_email: 'siti@yahoo.com',
            pelanggan_telepon: '082345678901',
            bulan: month,
            jumlah: 150000,
            status: i === 0 ? 'belum' : 'lunas',
            tanggal_jatuh_tempo: moment(`${month}-10`).format('YYYY-MM-DD'),
            tanggal_dibuat: moment().subtract(i, 'months').format('YYYY-MM-DD'),
            prorata: false,
            denda: 0
        });
        
        // Tagihan untuk Ahmad Hidayat (tunggak)
        invoices.push({
            id: `INV_AHMAD_${month}`,
            pelanggan_id: 'CUST_003',
            pelanggan_nama: 'Ahmad Hidayat',
            pelanggan_email: 'ahmad@gmail.com',
            pelanggan_telepon: '083456789012',
            bulan: month,
            jumlah: 350000,
            status: i <= 2 ? 'telat' : (i === 0 ? 'belum' : 'lunas'),
            tanggal_jatuh_tempo: moment(`${month}-10`).format('YYYY-MM-DD'),
            tanggal_dibuat: moment().subtract(i, 'months').format('YYYY-MM-DD'),
            prorata: false,
            denda: i <= 2 ? 70000 : 0
        });
    }
    
    const batch = db.batch();
    
    invoices.forEach(invoice => {
        const invoiceRef = db.collection('tagihan').doc(invoice.id);
        batch.set(invoiceRef, invoice);
    });
    
    await batch.commit();
    console.log(` ${invoices.length} tagihan berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT AKTIVITAS AWAL
async function createInitialActivities() {
    const activities = [
        {
            aktivitas: 'Sistem X-BILL diinstall',
            user: 'System',
            timestamp: moment().subtract(1, 'day').toISOString()
        },
        {
            aktivitas: 'Data paket internet dibuat',
            user: 'Administrator',
            timestamp: moment().subtract(1, 'day').toISOString()
        },
        {
            aktivitas: '5 pelanggan ditambahkan',
            user: 'Administrator',
            timestamp: moment().subtract(1, 'day').toISOString()
        },
        {
            aktivitas: 'Tagihan bulanan digenerate',
            user: 'System',
            timestamp: moment().subtract(1, 'day').toISOString()
        },
        {
            aktivitas: 'Login berhasil',
            user: 'Administrator',
            timestamp: new Date().toISOString()
        }
    ];
    
    const batch = db.batch();
    
    activities.forEach((activity, index) => {
        const activityRef = db.collection('aktivitas').doc(`ACT_${Date.now()}_${index}`);
        batch.set(activityRef, activity);
    });
    
    await batch.commit();
    console.log(` ${activities.length} aktivitas berhasil dibuat`);
}

// FUNGSI UNTUK CEK DAN BUAT INDEX
async function checkAndCreateIndexes() {
    try {
        console.log(" Mengecek index Firestore...");
        
        // Tidak ada fungsi langsung untuk buat index via JavaScript
        // User harus buat manual di Firebase Console
        console.log(" Untuk performa optimal, buat index di Firebase Console:");
        console.log("1. Buka https://console.firebase.google.com/");
        console.log("2. Pilih project Anda");
        console.log("3. Pilih Firestore Database > Indexes");
        console.log("4. Buat index untuk query yang sering digunakan");
        
    } catch (error) {
        console.error(" Error cek index:", error);
    }
}

// ============================================
// ROUTING & PAGE MANAGEMENT
// ============================================

async function loadPage(page) {
    currentPage = page;
    const mainContent = document.getElementById('mainContent');
    
    // Update active nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === page) {
            item.classList.add('active');
        }
    });
    
    switch(page) {
        case 'dashboard':
            mainContent.innerHTML = await getDashboardHTML();
            
            // INISIALISASI DATABASE JIKA KOSONG
            if (!window.databaseInitialized) {
                await initializeDatabase();
                window.databaseInitialized = true;
            }
            
            await renderDashboard();
            break;
            
        case 'pelanggan':
            mainContent.innerHTML = await getPelangganHTML();
            await loadPaketData();
            await loadPelangganData();
            break;
            
        case 'paket':
            mainContent.innerHTML = await getPaketHTML();
            await loadPaketData();
            break;
            
        case 'tagihan':
            mainContent.innerHTML = await getTagihanHTML();
            await loadTagihanData();
            break;
            
        case 'tunggakan':
            mainContent.innerHTML = await getTunggakanHTML();
            await loadTunggakanData();
            break;
            
        case 'laporan':
            mainContent.innerHTML = await getLaporanHTML();
            break;
            
        case 'setting':
            mainContent.innerHTML = await getSettingHTML();
            break;
    }
}

// TAMBAHKAN TOMBOL RESET DATABASE DI HALAMAN IMPORT/EXPORT
// Modifikasi getImportExportHTML():
async function getImportExportHTML() {
    return `
        <div class="page import-export-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-file-import"></i> Import & Export Data</h2>
                <button class="btn btn-danger" onclick="resetDatabase()" title="Reset semua data ke kondisi awal">
                    <i class="fas fa-database"></i> Reset Database
                </button>
            </div>
            
            <!-- ... sisa kode tetap ... -->
            
            <div class="card mt-4">
                <div class="card-header">
                    <h3><i class="fas fa-database"></i> Tools Database</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Perhatian!</strong> Tindakan ini akan menghapus semua data dan membuat ulang data contoh.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="initializeDatabase()">
                            <i class="fas fa-play"></i> Inisialisasi Database
                        </button>
                        <button class="btn btn-danger" onclick="resetDatabase()">
                            <i class="fas fa-trash"></i> Reset & Buat Ulang
                        </button>
                        <button class="btn btn-info" onclick="checkDatabaseStatus()">
                            <i class="fas fa-chart-bar"></i> Status Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// FUNGSI RESET DATABASE
async function resetDatabase() {
    if (!confirm(' PERINGATAN!\n\nAnda akan menghapus SEMUA data dan membuat ulang data contoh.\n\nLanjutkan?')) {
        return;
    }
    
    try {
        showLoading();
        console.log(" Memulai reset database...");
        
        // Hapus semua collections
        const collections = ['pelanggan', 'paket', 'tagihan', 'aktivitas'];
        
        for (const collectionName of collections) {
            console.log(` Menghapus collection: ${collectionName}`);
            
            const snapshot = await db.collection(collectionName).get();
            const batch = db.batch();
            
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            console.log(` ${snapshot.size} dokumen dihapus dari ${collectionName}`);
        }
        
        // Reset flag
        window.databaseInitialized = false;
        
        // Buat ulang data
        await initializeDatabase();
        
        hideLoading();
        showToast('success', 'Reset Berhasil', 'Database berhasil direset dan data contoh dibuat ulang');
        
        // Redirect ke dashboard
        loadPage('dashboard');
        
    } catch (error) {
        console.error(" Error reset database:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal reset database: ' + error.message);
    }
}

// FUNGSI CEK STATUS DATABASE
async function checkDatabaseStatus() {
    try {
        showLoading();
        
        const collections = ['pelanggan', 'paket', 'tagihan', 'aktivitas'];
        let result = '<h4>Status Database:</h4><ul>';
        
        for (const collectionName of collections) {
            const snapshot = await db.collection(collectionName).get();
            result += `<li><strong>${collectionName}:</strong> ${snapshot.size} dokumen</li>`;
        }
        
        result += '</ul>';
        
        hideLoading();
        
        // Tampilkan modal dengan status
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-database"></i> Status Database</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${result}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="initializeDatabase()">
                        <i class="fas fa-play"></i> Inisialisasi
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error cek status database:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal cek status database');
    }
}
        

// DI showApp() ATAU loadPage():
function updateUIBasedOnRole() {
  const role = localStorage.getItem('userRole');
  
  // Sembunyikan menu untuk karyawan
  if (role === 'karyawan') {
    document.querySelector('[data-page="paket"]').style.display = 'none';
    document.querySelector('[data-page="import-export"]').style.display = 'none';
    document.querySelector('[data-page="laporan"]').style.display = 'none';
  }


  
  // Update nama user di navbar
  document.getElementById('userRole').textContent = 
    role === 'admin' ? 'Administrator' : 'Karyawan';
}

        // ============================================
        // CRUD FUNCTIONS - PELANGGAN
        // ============================================
        
        // PERBAIKAN: GANTI FUNGSI showAddPelangganModal
function showAddPelangganModal() {
    // 1. Permission check
    if (localStorage.getItem('userRole') !== 'admin') {
        alert(' HANYA ADMIN!');
        return;
    }
    
    // 2. Reset form
    const form = document.getElementById('formPelanggan');
    if (form) form.reset();
    
    // 3. Set default values
    document.getElementById('pelangganId').value = '';
    document.getElementById('pelangganHarga').value = '';
    document.getElementById('pelangganKoordinat').value = '';
    document.getElementById('pelangganTanggalPasang').value = moment().format('YYYY-MM-DD');
    document.getElementById('pelangganStatus').value = 'aktif';
    
    // 4. Update title
    const modalTitle = document.querySelector('#modalPelanggan .modal-title');
    if (modalTitle) modalTitle.textContent = 'Tambah Pelanggan';
    
    // 5. Setup paket dropdown (FIXED VERSION)
    const paketSelect = document.getElementById('pelangganPaket');
    if (paketSelect && paketData) {
        // Clear existing options
        paketSelect.innerHTML = '<option value="">-- Pilih Paket --</option>';
        
        // Add options
        paketData.forEach(p => {
            const option = document.createElement('option');
            option.value = p.nama;
            option.textContent = `${p.nama} `;
            option.dataset.harga = p.harga;
            paketSelect.appendChild(option);
        });
        
        // Simple event handler
        paketSelect.onchange = function() {
            const harga = this.options[this.selectedIndex].dataset.harga;
            document.getElementById('pelangganHarga').value = harga || '';
        };
    }
   
    // 6. Show modal (PASTI SHOW)
    const modal = document.getElementById('modalPelanggan');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('show');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

console.log(" Function updated");

function setupAutoProrata() {
    const tglInput = document.getElementById('pelangganTanggalPasang');
    const hargaInput = document.getElementById('pelangganHarga');
    
    if (!tglInput || !hargaInput) return;
    
    tglInput.addEventListener('change', function() {
        const tglPasang = new Date(this.value);
        const sekarang = new Date();
        const harga = parseInt(hargaInput.value) || 0;
        
        if (harga > 0 && 
            tglPasang.getMonth() === sekarang.getMonth() && 
            tglPasang.getFullYear() === sekarang.getFullYear()) {
            
            const hariDalamBulan = 30;
            const sisaHari = hariDalamBulan - tglPasang.getDate() + 1;
            const prorata = Math.round((harga / hariDalamBulan) * sisaHari);
            
            // TAMPILKAN INFO PRORATA
            showToast('info', 'Prorata', 
                `Bulan pertama: ${sisaHari} hari = ${formatRupiah(prorata)}`);
            
            // OPSIONAL: Auto-update harga field
            // hargaInput.value = prorata;
        }
    });
}

// PANGGIL DI showAddPelangganModal():
// setupAutoProrata();
async function generateTagihanArrears(pelangganId, pelangganData, tglPasang) {
    const tglPasangObj = new Date(tglPasang);
    
    // 1. TAGIHAN UNTUK BULAN PERTAMA (PRORATA)
    // Tagihan bulan berikutnya untuk penggunaan bulan pertama
    const bulanTagihan1 = moment(tglPasang).add(1, 'month').format('YYYY-MM');
    
    // Hitung prorata bulan pertama
    const prorata = hitungProrataBulanPertama(pelangganData.harga, tglPasang);
    
    // Buat tagihan prorata (jatuh tempo: 10 bulan berikutnya)
    await buatTagihanArrears(pelangganId, pelangganData, {
        bulan: bulanTagihan1,
        jumlah: prorata,
        keterangan: `Prorata ${moment(tglPasang).format('MMM YYYY')}`,
        jatuh_tempo: moment(bulanTagihan1).date(10).format('YYYY-MM-DD')
    });
    
    // 2. TAGIHAN BULAN-BULAN BERIKUTNYA (FULL)
    // Mulai dari bulan setelah bulan pertama
    const mulaiBulanFull = moment(tglPasang).add(2, 'months');
    
    for (let i = 0; i < 12; i++) { // 12 bulan ke depan
        const bulanTagihan = mulaiBulanFull.clone().add(i, 'months').format('YYYY-MM');
        const jatuhTempo = mulaiBulanFull.clone().add(i, 'months').date(10).format('YYYY-MM-DD');
        
        await buatTagihanArrears(pelangganId, pelangganData, {
            bulan: bulanTagihan,
            jumlah: pelangganData.harga,
            keterangan: `Tagihan reguler`,
            jatuh_tempo: jatuhTempo
        });
    }
}

function hitungProrataBulanPertama(hargaBulanan, tglPasang) {
    const tgl = new Date(tglPasang);
    const tahun = tgl.getFullYear();
    const bulan = tgl.getMonth();
    const hariDalamBulan = new Date(tahun, bulan + 1, 0).getDate();
    const sisaHari = hariDalamBulan - tgl.getDate() + 1;
    
    return Math.round((hargaBulanan / hariDalamBulan) * sisaHari);
}


// Helper terpisah untuk isi dropdown agar rapi
function populatePaketOptions() {
    const paketSelect = document.getElementById('pelangganPaket');
if (paketSelect && paketData) {
    paketSelect.innerHTML = '<option value="">-- Pilih Paket --</option>';
    
    paketData.forEach(p => {
        const option = document.createElement('option');
        option.value = p.nama;
        option.textContent = p.nama; //  HANYA NAMA
        option.dataset.harga = p.harga;
        paketSelect.appendChild(option);
    });
    
    paketSelect.onchange = function() {
        const harga = this.options[this.selectedIndex].dataset.harga;
        document.getElementById('pelangganHarga').value = harga || '';
    };
}
}
        
        async function savePelanggan() {
    const btn = document.querySelector('#modalPelanggan .btn-primary');
    const originalText = btn.innerHTML;

    try {
        // 1. AMBIL DATA
        const nama = document.getElementById('pelangganNama').value;
        const telepon = document.getElementById('pelangganTelepon').value;
        const alamat = document.getElementById('pelangganAlamat').value;
        const paket = document.getElementById('pelangganPaket').value;
        const harga = parseInt(document.getElementById('pelangganHarga').value) || 0;
        const tglPasang = document.getElementById('pelangganTanggalPasang').value;
        const status = document.getElementById('pelangganStatus').value;
        const koordinat = document.getElementById('pelangganKoordinat').value;

        // 2. VALIDASI
        if (!nama || !telepon || !alamat || !paket) {
            showToast('error', 'Error', 'Lengkapi data!');
            return;
        }

        // 3. LOADING
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        const data = {
            nama, telepon, alamat, koordinat, paket, harga,
            tanggal_pasang: tglPasang,
            status: status,
            catatan: document.getElementById('pelangganCatatan').value || '',
            email: telepon + '@xbill.com',
            updated_at: new Date().toISOString()
        };

        const id = document.getElementById('pelangganId').value;
        let isNew = !id;

        // 4. SIMPAN KE FIREBASE
        if (id) {
            await db.collection('pelanggan').doc(id).update(data);
        } else {
            data.created_at = new Date().toISOString();
            const docRef = await db.collection('pelanggan').add(data);
            const newId = docRef.id;
            
            // 5. GENERATE TAGIHAN PERTAMA OTOMATIS (HANYA UNTUK BARU)
            setTimeout(() => {
                generateTagihanPertama(newId, data, tglPasang);
            }, 500);
        }

        // 6. TUTUP MODAL & REFRESH
        hideModal('modalPelanggan');
        showToast('success', 'Berhasil', 'Data Tersimpan.');

        if (currentPage === 'pelanggan') {
            await loadPelangganData();
        }

    } catch (error) {
        console.error(error);
        showToast('error', 'Gagal', 'Terjadi kesalahan.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function generateTagihanPertama(pelangganId, pelangganData, tglPasang) {
    try {
        // === PERBAIKAN: Timeline arrears untuk pelanggan baru ===
        const tglPasangObj = new Date(tglPasang);
        
        // 1. Tentukan bulan pemakaian (bulan saat pasang)
        const bulanPemakaian = moment(tglPasangObj).format('YYYY-MM'); // Contoh: "2024-12"
        
        // 2. Jatuh tempo = bulan berikutnya, tanggal 10
        const bulanJatuhTempo = moment(tglPasangObj).add(1, 'month').format('YYYY-MM'); // "2025-01"
        const tanggalJatuhTempo = `${bulanJatuhTempo}-10`;
        
        // 3. Hitung prorata untuk sisa hari di bulan pemakaian
        const hariDalamBulan = moment(bulanPemakaian).daysInMonth();
        const sisaHari = hariDalamBulan - tglPasangObj.getDate() + 1;
        const jumlah = Math.round((pelangganData.harga / hariDalamBulan) * sisaHari);
        
        console.log(" Tagihan pertama ARREARS:");
        console.log(`- Pelanggan: ${pelangganData.nama}`);
        console.log(`- Pasang: ${tglPasang} (${sisaHari} hari sisa di ${bulanPemakaian})`);
        console.log(`- Tagihan: ${bulanPemakaian} = ${formatRupiah(jumlah)}`);
        console.log(`- Jatuh tempo: ${tanggalJatuhTempo}`);
        
        const tagihanId = 'INV_' + pelangganId + '_' + bulanPemakaian.replace('-', '');
        
        const tagihanData = {
            id: tagihanId,
            pelanggan_id: pelangganId,
            pelanggan_nama: pelangganData.nama,
            pelanggan_telepon: pelangganData.telepon,
            pelanggan_email: pelangganData.email || pelangganData.telepon + '@xbill.com',
            bulan: bulanPemakaian, // Bulan pemakaian (saat pasang)
            jumlah: jumlah,
            status: 'belum',
            tanggal_jatuh_tempo: tanggalJatuhTempo, // Jatuh tempo bulan berikutnya
            tanggal_dibuat: new Date().toISOString(),
            prorata: true,
            prorata_hari: sisaHari,
            denda: 0,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        await db.collection('tagihan').doc(tagihanId).set(tagihanData);
        
        console.log(" Tagihan pertama ARREARS digenerate:", tagihanId);
        
        // Tampilkan timeline yang jelas ke user
        const timelineMessage = `
             Timeline ARREARS untuk ${pelangganData.nama}:
            1. Pasang: ${moment(tglPasang).format('DD MMM YYYY')}
            2. Pemakaian: ${bulanPemakaian} (${sisaHari} hari)
            3. Tagihan: ${formatRupiah(jumlah)} (prorata)
            4. Jatuh tempo: ${moment(tanggalJatuhTempo).format('DD MMM YYYY')}
        `;
        
        showToast('info', 'Tagihan ARREARS Dibuat', timelineMessage);
        
        // LOG AKTIVITAS dengan detail arrears
        await db.collection('aktivitas').add({
            aktivitas: `Auto-generate tagihan ARREARS pertama untuk ${pelangganData.nama}: ${bulanPemakaian} (prorata ${sisaHari} hari)  jatuh tempo ${tanggalJatuhTempo}`,
            user: localStorage.getItem('userName') || 'System',
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error(" Gagal generate tagihan pertama arrears:", error);
        showToast('error', 'Error', 'Gagal buat tagihan pertama: ' + error.message);
    }
}
        
        async function editPelanggan(id) {
            try {
                showLoading();
                
                const doc = await db.collection('pelanggan').doc(id).get();
                if (!doc.exists) {
                    throw new Error('Pelanggan tidak ditemukan');
                }
                
                const data = doc.data();
                
                document.getElementById('modalPelanggan').querySelector('.modal-title').textContent = 'Edit Pelanggan';
                document.getElementById('pelangganId').value = id;
                document.getElementById('pelangganNama').value = data.nama || '';
                document.getElementById('pelangganTelepon').value = data.telepon || '';
                document.getElementById('pelangganAlamat').value = data.alamat || '';
                document.getElementById('pelangganEmail').value = data.email || '';
                document.getElementById('pelangganKoordinat').value = data.koordinat || '';
                document.getElementById('pelangganPaket').value = data.paket || '';
                document.getElementById('pelangganHarga').value = data.harga || 150000;
                document.getElementById('pelangganTanggalPasang').value = data.tanggal_pasang || '';
                document.getElementById('pelangganStatus').value = data.status || 'aktif';
                document.getElementById('pelangganCatatan').value = data.catatan || '';
                
                showModal('modalPelanggan');
                hideLoading();
                
            } catch (error) {
                console.error("Error editing pelanggan:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal memuat data pelanggan');
            }
        }
        
      // FUNGSI HAPUS PELANGGAN - FIXED
// GANTI SEMUA FUNGSI DELETE PELANGGAN YANG LAMA DENGAN INI:

// PASTI WORK - GANTI SAJA INI

async function deletePelanggan(id) {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('HANYA ADMIN!'); return;
    }
    if (!confirm('HAPUS?')) return;
    await db.collection('pelanggan').doc(id).delete();
    showToast('success', 'Berhasil', 'Data terhapus');
    if (currentPage === 'pelanggan') loadPelangganData();
}

// TAMBAHKAN INI DI renderPelangganTable()
function attachDeleteEvents() {
    // HAPUS SEMUA EVENT LAMA
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
    });
    
    // PASANG EVENT BARU
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.onclick = function(e) {
            e.stopPropagation();
            e.stopImmediatePropagation();
            const id = this.getAttribute('data-id');
            if (id) deletePelanggan(id);
        };
    });
}


// FUNGSI UNTUK UPDATE TIMELINE PREVIEW DI MODAL
function updateArrearsTimeline() {
    const bulanGenerate = document.getElementById('generateBulan').value;
    const jatuhTempoHari = document.getElementById('generateJatuhTempo').value || 10;
    
    if (!bulanGenerate) return;
    
    // Hitung timeline arrears
    const bulanPemakaian = moment(bulanGenerate).subtract(1, 'month');
    const bulanJatuhTempo = moment(bulanGenerate).add(1, 'month');
    
    // Update preview
    document.getElementById('previewBulanPemakaian').textContent = bulanPemakaian.format('MMM YYYY');
    document.getElementById('previewBulanGenerate').textContent = moment(bulanGenerate).format('MMM YYYY');
    document.getElementById('previewJatuhTempo').textContent = `${jatuhTempoHari} ${bulanJatuhTempo.format('MMM YYYY')}`;
    
    // Update summary
    document.getElementById('summaryBulanPemakaian').textContent = bulanPemakaian.format('MMM YYYY');
    document.getElementById('summaryBulanJatuhTempo').textContent = `${jatuhTempoHari} ${bulanJatuhTempo.format('MMM YYYY')}`;
}

// FUNGSI UNTUK LOAD DATA DAN UPDATE PREVIEW
async function loadTunggakanDataForModal() {
    console.log(" Loading data untuk modal arrears...");
    
    try {
        // 1. AMBIL DATA PELANGGAN AKTIF
        const snapshot = await db.collection('pelanggan').where('status', '==', 'aktif').get();
        const totalAktif = snapshot.size;
        
        // 2. HITUNG RATA-RATA HARGA
        let totalHarga = 0;
        snapshot.forEach(doc => {
            totalHarga += Number(doc.data().harga) || 150000;
        });
        const rataHarga = Math.round(totalHarga / totalAktif);
        
        // 3. UPDATE UI
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        document.getElementById('previewPelangganCount').textContent = totalAktif;
        document.getElementById('previewHargaRata').textContent = formatRupiah(rataHarga);
        
        const estimasiTotal = totalAktif * rataHarga;
        document.getElementById('previewTotalEstimasi').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryEstimasiTotal').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryJumlahTagihan').textContent = totalAktif;
        
        // 4. UPDATE TIMELINE
        updateArrearsTimeline();
        
        showToast('success', 'Data Updated', 'Data pelanggan berhasil di-refresh');
        
    } catch (error) {
        console.error(" Error load data for modal:", error);
        showToast('error', 'Error', 'Gagal memuat data');
    }
}

// INIT MODAL SAAT DIBUKA
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modalGenerateTagihan');
    if (modal) {
        modal.addEventListener('show', function() {
            // Set default bulan (bulan ini)
            document.getElementById('generateBulan').value = moment().format('YYYY-MM');
            document.getElementById('generateJatuhTempo').value = 10;
            
            // Load data dan update timeline
            setTimeout(() => {
                loadTunggakanDataForModal();
            }, 500);
        });
    }
});

// FUNGSI UNTUK EKSEKUSI DELETE (DIPANGGIL DARI MODAL)
async function executeDelete(id) {
    console.log(" EKSEKUSI DELETE UNTUK:", id);
    
    try {
        // TAMPILKAN LOADING
        const deleteBtn = document.querySelector('button[onclick*="executeDelete"]');
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghapus...';
            deleteBtn.disabled = true;
        }
        
        // HAPUS DARI FIREBASE
        await db.collection('pelanggan').doc(id).delete();
        console.log(" BERHASIL DIHAPUS");
        
        // HAPUS MODAL
        const modal = document.getElementById('deleteConfirmModal');
        if (modal) modal.remove();
        
        // TAMPILKAN NOTIFIKASI
        showToast('success', 'Berhasil', 'Data pelanggan telah dihapus');
        
        // REFRESH DATA
        if (currentPage === 'pelanggan') {
            loadPelangganData();
        }
        
        // LOG AKTIVITAS
        await db.collection('aktivitas').add({
            aktivitas: `Menghapus pelanggan ${id.substring(0, 8)}...`,
            user: currentUser?.name || 'Administrator',
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error(" ERROR DELETE:", error);
        showToast('error', 'Gagal', 'Gagal menghapus: ' + error.message);
        
        // HAPUS MODAL
        const modal = document.getElementById('deleteConfirmModal');
        if (modal) modal.remove();
    }
}

// GANTI TOMBOL DI TABLE MENJADI:
// <button class="btn btn-sm btn-danger" onclick="deletePelanggan('${pelanggan.id}'); return false;" title="Hapus">
        
        // ============================================
        // CRUD FUNCTIONS - PAKET
        // ============================================
        
        function showAddPaketModal() {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('HANYA ADMIN!'); return;
    }
    document.getElementById('formPaket').reset();
    const modal = document.getElementById('modalPaket');
    modal.classList.remove('hidden');
    modal.classList.add('show');
}
        
        async function savePaket() {
            try {
                const form = document.getElementById('formPaket');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                showLoading();
                
                const paketData = {
                    nama: document.getElementById('paketNama').value,
                    kecepatan: document.getElementById('paketKecepatan').value,
                    harga: parseInt(document.getElementById('paketHarga').value),
                    kuota: document.getElementById('paketKuota').value || 'Unlimited',
                    deskripsi: document.getElementById('paketDeskripsi').value || '',
                    fitur: document.getElementById('paketFitur').value || '',
                    warna: document.getElementById('paketWarna').value,
                    status: document.getElementById('paketStatus').value,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const paketId = document.getElementById('paketId').value;
                let isNew = !paketId;
                
                if (paketId) {
                    // Update existing
                    await db.collection('paket').doc(paketId).update(paketData);
                    showToast('success', 'Berhasil', 'Paket berhasil diperbarui');
                } else {
                    // Add new
                    const docRef = await db.collection('paket').add({
                        ...paketData,
                        id: generateId('PAKET_')
                    });
                    showToast('success', 'Berhasil', 'Paket berhasil ditambahkan');
                }
                
                // Log activity
                await db.collection('aktivitas').add({
                    aktivitas: isNew ? 'Menambah paket baru' : 'Memperbarui data paket',
                    user: currentUser?.name || 'Administrator',
                    timestamp: new Date().toISOString()
                });
                
                hideModal('modalPaket');
                hideLoading();
                
                // Reload data
                if (currentPage === 'paket') {
                    await loadPaketData();
                }
                if (currentPage === 'pelanggan') {
                    await loadPaketData();
                }
                
            } catch (error) {
                console.error("Error saving paket:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal menyimpan data paket');
            }
        }
        
        async function editPaket(id) {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert(' HANYA ADMIN YANG BOLEH EDIT PAKET!');
        return;
    }
    
    try {
        showLoading();
        const doc = await db.collection('paket').doc(id).get();
        if (!doc.exists) throw new Error('Paket tidak ditemukan');
        
        const data = doc.data();
        document.getElementById('modalPaket').querySelector('.modal-title').textContent = 'Edit Paket';
        document.getElementById('paketId').value = id;
        document.getElementById('paketNama').value = data.nama || '';
        document.getElementById('paketKecepatan').value = data.kecepatan || '';
        document.getElementById('paketHarga').value = data.harga || 150000;
        document.getElementById('paketKuota').value = data.kuota || '';
        document.getElementById('paketDeskripsi').value = data.deskripsi || '';
        document.getElementById('paketFitur').value = data.fitur || '';
        document.getElementById('paketWarna').value = data.warna || '#4361ee';
        document.getElementById('paketStatus').value = data.status || 'aktif';
        
        showModal('modalPaket');
        hideLoading();
    } catch (error) {
        console.error("Error editing paket:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal memuat data paket');
    }
}
        
        async function deletePaket(id) {
            confirmDialog('Hapus paket ini? Pelanggan yang menggunakan paket ini akan terpengaruh.', async () => {
                try {
                    showLoading();
                    await db.collection('paket').doc(id).delete();
                    
                    // Log activity
                    await db.collection('aktivitas').add({
                        aktivitas: 'Menghapus paket',
                        user: currentUser?.name || 'Administrator',
                        timestamp: new Date().toISOString()
                    });
                    
                    hideLoading();
                    showToast('success', 'Berhasil', 'Paket berhasil dihapus');
                    
                    if (currentPage === 'paket') {
                        await loadPaketData();
                    }
                    
                } catch (error) {
                    console.error("Error deleting paket:", error);
                    hideLoading();
                    showToast('error', 'Error', 'Gagal menghapus paket');
                }
            });
        }
        
        // ============================================
        // TAGIHAN FUNCTIONS
        // ============================================
        
        async function generateTagihanBulk() {
    console.log(" Memulai generate tagihan ARREARS (pakai dulu, bayar belakangan)...");
    
    const submitBtn = document.querySelector('#modalGenerateTagihan .btn-primary');
    const originalText = submitBtn ? submitBtn.innerHTML : '';
    
    try {
        // AMBIL INPUT
        const bulan = document.getElementById('generateBulan').value; // Contoh: "2025-01"
        const jatuhTempoHari = parseInt(document.getElementById('generateJatuhTempo').value);
        
        if (!bulan || !jatuhTempoHari) {
            showToast('error', 'Error', 'Harap isi bulan dan jatuh tempo');
            return;
        }
        
        // === PERBAIKAN PERTAMA: Tentukan bulan tagihan & jatuh tempo ===
        // BULAN TAGIHAN = BULAN SEBELUMNYA (arrears)
        const bulanTagihan = moment(bulan).subtract(1, 'month').format('YYYY-MM');
        
        // JATUH TEMPO = BULAN BERIKUTNYA (setelah pemakaian)
        const bulanJatuhTempo = bulan; // Contoh: "2025-01"
        const tanggalJatuhTempo = `${bulanJatuhTempo}-${jatuhTempoHari.toString().padStart(2, '0')}`;
        
        console.log(" Timeline Arrears:");
        console.log(`- Pemakaian: ${bulanTagihan} (bulan sebelumnya)`);
        console.log(`- Generate: ${bulan} (awal bulan berikutnya)`);
        console.log(`- Jatuh tempo: ${tanggalJatuhTempo} (di bulan berikutnya)`);
        
        // Tampilkan loading
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing ARREARS...';
        }
        
        // AMBIL PELANGGAN AKTIF
        const snapshot = await db.collection('pelanggan')
            .where('status', '==', 'aktif')
            .get();
        
        if (snapshot.empty) {
            showToast('warning', 'Peringatan', 'Tidak ada pelanggan aktif');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
            return;
        }
        
        // GENERATE TAGIHAN
        const batch = db.batch();
        const tagihanList = [];
        const now = new Date();
        let totalTagihan = 0;
        
        snapshot.forEach(doc => {
            const pelanggan = doc.data();
            const pelangganId = doc.id;
            
            // === PERBAIKAN KEDUA: Cek apakah sudah ada tagihan untuk bulan ini ===
            const tagihanId = `INV_${pelangganId}_${bulanTagihan.replace('-', '')}`;
            
            // Data pelanggan
            const pelangganNama = pelanggan.nama || 'Tidak ada nama';
            const pelangganTelepon = pelanggan.telepon || 'Tidak ada telepon';
            const pelangganHarga = Number(pelanggan.harga) || 150000;
            
            // === PERBAIKAN KETIGA: Hitung PRORATA untuk pelanggan baru ===
            let jumlah = pelangganHarga; // Default: full bulan
            let isProrata = false;
            
            // Cek jika pelanggan pasang di bulan tagihan
            if (pelanggan.tanggal_pasang) {
                const tglPasang = new Date(pelanggan.tanggal_pasang);
                const bulanPasang = moment(tglPasang).format('YYYY-MM');
                
                if (bulanPasang === bulanTagihan) {
                    // Pelanggan baru di bulan tagihan  hitung prorata
                    const hariDalamBulan = moment(bulanTagihan).daysInMonth();
                    const sisaHari = hariDalamBulan - tglPasang.getDate() + 1;
                    
                    if (sisaHari < hariDalamBulan && sisaHari > 0) {
                        jumlah = Math.round((pelangganHarga / hariDalamBulan) * sisaHari);
                        isProrata = true;
                        
                        console.log(` Prorata: ${pelangganNama} - ${sisaHari} hari = ${formatRupiah(jumlah)}`);
                    }
                }
            }
            
            // Data tagihan ARREARS
            const tagihanData = {
                id: tagihanId,
                pelanggan_id: pelangganId,
                pelanggan_nama: pelangganNama,
                pelanggan_email: pelanggan.email || `${pelangganTelepon}@xbill.com`,
                pelanggan_telepon: pelangganTelepon,
                bulan: bulanTagihan, // Bulan pemakaian (sebelumnya)
                jumlah: jumlah,
                status: 'belum',
                tanggal_jatuh_tempo: tanggalJatuhTempo, // Jatuh tempo bulan berikutnya
                tanggal_dibuat: now.toISOString(),
                prorata: isProrata,
                denda: 0,
                created_at: now.toISOString(),
                updated_at: now.toISOString()
            };
            
            const tagihanRef = db.collection('tagihan').doc(tagihanId);
            batch.set(tagihanRef, tagihanData);
            tagihanList.push(tagihanData);
            totalTagihan += jumlah;
        });
        
        await batch.commit();
        
        // Log aktivitas dengan timeline arrears
        await db.collection('aktivitas').add({
            aktivitas: `Generate tagihan ARREARS ${bulanTagihan} untuk ${tagihanList.length} pelanggan (jatuh tempo: ${tanggalJatuhTempo})`,
            user: localStorage.getItem('userName') || 'Administrator',
            timestamp: new Date().toISOString()
        });
        
        // Tutup modal
        forceCloseModal('modalGenerateTagihan');
        
        // Restore tombol
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
        
        // Tampilkan summary dengan timeline arrears
        const summaryMessage = `
             ${tagihanList.length} tagihan ARREARS digenerate
             Untuk pemakaian: ${bulanTagihan}
             Jatuh tempo: ${moment(tanggalJatuhTempo).format('DD MMM YYYY')}
             Total: ${formatRupiah(totalTagihan)}
        `;
        
        showToast('success', 'Tagihan ARREARS Berhasil', summaryMessage);
        
        // Refresh data
        if (currentPage === 'tagihan') await loadTagihanData();
        if (currentPage === 'dashboard') await renderDashboard();
        
    } catch (error) {
        console.error(" Error generate tagihan arrears:", error);
        
        // Restore tombol
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
        
        showToast('error', 'Error', 'Gagal generate tagihan arrears: ' + error.message);
    }
}

// FUNGSI UNTUK AMBIL DATA TUNGGAKAN
async function getTunggakanData() {
    try {
        const snapshot = await db.collection('tagihan')
            .where('status', '==', 'telat')
            .get();
        
        if (snapshot.empty) {
            return [];
        }
        
        const tunggakanByPelanggan = {};
        
        snapshot.docs.forEach(doc => {
            const tagihan = doc.data();
            const pelangganId = tagihan.pelanggan_id;
            
            if (!tunggakanByPelanggan[pelangganId]) {
                tunggakanByPelanggan[pelangganId] = {
                    pelanggan_id: pelangganId,
                    pelanggan_nama: tagihan.pelanggan_nama,
                    total: 0,
                    jumlah_tunggakan: 0,
                    hari_terlambat: 0
                };
            }
            
            // Hitung hari terlambat
            const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
            const hariTerlambat = moment().diff(jatuhTempo, 'days');
            
            // Update data tunggakan
            tunggakanByPelanggan[pelangganId].total += Number(tagihan.jumlah) || 0;
            tunggakanByPelanggan[pelangganId].jumlah_tunggakan += 1;
            tunggakanByPelanggan[pelangganId].hari_terlambat = Math.max(
                tunggakanByPelanggan[pelangganId].hari_terlambat, 
                hariTerlambat
            );
        });
        
        return Object.values(tunggakanByPelanggan);
        
    } catch (error) {
        console.error(" Error get tunggakan data:", error);
        return [];
    }
}

// FUNGSI PREVIEW GENERATE TAGIHAN
async function previewGenerateTagihan() {
    try {
        console.log(" Preview generate tagihan...");
        
        // Update summary
        await updateGenerateSummary();
        
        showToast('info', 'Preview', 'Menghitung summary generate...');
        
    } catch (error) {
        console.error("Error preview:", error);
    }
}

// FUNGSI UPDATE SUMMARY
async function updateGenerateSummary() {
    try {
        const bulan = document.getElementById('generateBulan').value;
        if (!bulan) return;
        
        // Ambil data pelanggan aktif
        const snapshot = await db.collection('pelanggan')
            .where('status', '==', 'aktif')
            .get();
        
        const totalAktif = snapshot.size;
        
        // Ambil data tunggakan
        const tunggakanData = await getTunggakanData();
        const jumlahTunggakan = tunggakanData.length;
        
        // Hitung total tunggakan
        const totalTunggakan = tunggakanData.reduce((sum, t) => sum + t.total, 0);
        
        // Estimasi tagihan (rata-rata 150rb per pelanggan)
        const estimasiTagihan = totalAktif * 150000;
        
        // Update UI
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        document.getElementById('summaryTunggakan').textContent = jumlahTunggakan;
        document.getElementById('summaryTotalTunggakan').textContent = formatRupiah(totalTunggakan);
        document.getElementById('summaryTagihan').textContent = formatRupiah(estimasiTagihan);
        
        // Estimasi waktu
        const estimasiWaktu = Math.ceil(totalAktif / 10); // 10 pelanggan per detik
        document.getElementById('summaryWaktu').textContent = `~${estimasiWaktu} detik`;
        
    } catch (error) {
        console.error("Error update summary:", error);
    }
}

// Di fungsi initializeQuickActions() atau saat buka modal:
// FUNGSI UNTUK BUKA MODAL DENGAN DATA TUNGGAKAN
function showGenerateTagihanModal() {
    const role = localStorage.getItem('userRole');
    if (role !== 'admin' && role !== 'karyawan') {
        alert('HANYA ADMIN/KARYAWAN!'); return;
    }
    const modal = document.getElementById('modalGenerateTagihan');
    modal.classList.remove('hidden');
    modal.classList.add('show');
}
        
        // FUNGSI UNTUK TOMBOL "BAYAR"
async function bayarTagihan(tagihanId) {
    try {
        console.log("Membuka form bayar untuk tagihan:", tagihanId);
        
        // Ambil data tagihan
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Tagihan tidak ditemukan');
            return;
        }
        
        const tagihan = doc.data();
        
        // Isi form modal bayar
        document.getElementById('bayarInvoice').value = tagihan.id || tagihanId;
        document.getElementById('bayarPelanggan').value = tagihan.pelanggan_nama || 'Tidak ada nama';
        document.getElementById('bayarJumlah').value = formatRupiah(tagihan.jumlah || 0);
        
        // Hitung denda jika telat
        let denda = 0;
        if (tagihan.status === 'telat' && tagihan.tanggal_jatuh_tempo) {
            const hariTerlambat = moment().diff(moment(tagihan.tanggal_jatuh_tempo), 'days');
            denda = Math.round((tagihan.jumlah || 0) * Math.min(0.1, 0.02 * hariTerlambat));
        }
        
        document.getElementById('bayarDenda').value = formatRupiah(denda);
        document.getElementById('totalBayar').value = (tagihan.jumlah || 0) + denda;
        document.getElementById('tagihanId').value = tagihanId;
        
        // Set tanggal hari ini
        document.getElementById('tanggalBayar').value = moment().format('YYYY-MM-DD');
        
        // Buka modal
        const modal = document.getElementById('modalBayarTagihan');
        modal.classList.remove('hidden');
        modal.classList.add('show');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        showToast('info', 'Pembayaran', 'Isi form pembayaran');
        
    } catch (error) {
        console.error("Error membuka form bayar:", error);
        showToast('error', 'Error', 'Gagal membuka form pembayaran');
    }
}

// FUNGSI UNTUK TOMBOL "LIHAT DETAIL"
async function viewInvoice(tagihanId) {
    try {
        console.log("Melihat detail tagihan:", tagihanId);
        
        // Ambil data tagihan
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Tagihan tidak ditemukan');
            return;
        }
        
        const tagihan = doc.data();
        
        // Ambil data pelanggan
        let pelanggan = {};
        if (tagihan.pelanggan_id) {
            const pelangganDoc = await db.collection('pelanggan').doc(tagihan.pelanggan_id).get();
            if (pelangganDoc.exists) {
                pelanggan = pelangganDoc.data();
            }
        }
        
        // Buat HTML untuk detail
        const detailHTML = `
            <div style="padding: 20px;">
                <div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: var(--primary);">INVOICE</h3>
                        <h1 style="color: var(--dark);">${tagihan.id || tagihanId}</h1>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h4>Informasi Pelanggan</h4>
                            <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                                <tr><td><strong>Nama</strong></td><td>${pelanggan.nama || tagihan.pelanggan_nama || '-'}</td></tr>
                                <tr><td><strong>Telepon</strong></td><td>${pelanggan.telepon || tagihan.pelanggan_telepon || '-'}</td></tr>
                                <tr><td><strong>Email</strong></td><td>${pelanggan.email || tagihan.pelanggan_email || '-'}</td></tr>
                                <tr><td><strong>Alamat</strong></td><td>${pelanggan.alamat || '-'}</td></tr>
                            </table>
                        </div>
                        
                        <div>
                            <h4>Detail Tagihan</h4>
                            <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                                <tr><td><strong>Bulan</strong></td><td>${tagihan.bulan || '-'}</td></tr>
                                <tr><td><strong>Jatuh Tempo</strong></td><td>${moment(tagihan.tanggal_jatuh_tempo).format('DD/MM/YYYY') || '-'}</td></tr>
                                <tr><td><strong>Status</strong></td><td>
                                    <span class="badge ${tagihan.status === 'lunas' ? 'badge-success' : 
                                                       tagihan.status === 'telat' ? 'badge-danger' : 'badge-warning'}">
                                        ${tagihan.status === 'lunas' ? 'LUNAS' : 
                                         tagihan.status === 'telat' ? 'TELAT' : 'BELUM BAYAR'}
                                    </span>
                                </td></tr>
                                <tr><td><strong>Tipe</strong></td><td>${tagihan.prorata ? 'PRORATA' : 'NORMAL'}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <h2 style="margin: 0;">TOTAL: ${formatRupiah(tagihan.jumlah || 0)}</h2>
                    </div>
                    
                    ${tagihan.status === 'lunas' ? `
                        <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                            <h4 style="color: #00b894;"><i class="fas fa-check-circle"></i> SUDAH DIBAYAR</h4>
                            <p><strong>Tanggal Bayar:</strong> ${tagihan.tanggal_bayar || '-'}</p>
                            <p><strong>Metode:</strong> ${tagihan.metode_bayar || '-'}</p>
                            <p><strong>Referensi:</strong> ${tagihan.referensi_bayar || '-'}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Buat modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-file-invoice"></i> Detail Tagihan</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${detailHTML}
                </div>
                <div class="modal-footer">
                    ${tagihan.status !== 'lunas' ? `
                        <button class="btn btn-success" onclick="bayarTagihan('${tagihanId}')">
                            <i class="fas fa-money-bill-wave"></i> Bayar Sekarang
                        </button>
                    ` : ''}
                    <button class="btn btn-primary" onclick="printInvoiceDetail('${tagihanId}')">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error melihat detail:", error);
        showToast('error', 'Error', 'Gagal memuat detail tagihan');
    }
}

// FUNGSI UNTUK TOMBOL "KIRIM REMINDER"
async function sendReminderSingle(pelangganId) {
    try {
        console.log("Kirim reminder untuk pelanggan:", pelangganId);
        
        if (!pelangganId) {
            showToast('error', 'Error', 'ID pelanggan tidak valid');
            return;
        }
        
        // Ambil data pelanggan
        const pelangganDoc = await db.collection('pelanggan').doc(pelangganId).get();
        if (!pelangganDoc.exists) {
            showToast('error', 'Error', 'Pelanggan tidak ditemukan');
            return;
        }
        
        const pelanggan = pelangganDoc.data();
        
        // Tampilkan konfirmasi
        if (confirm(`Kirim reminder tagihan ke ${pelanggan.nama} (${pelanggan.telepon})?`)) {
            showLoading();
            
            // Simulasi kirim reminder
            setTimeout(() => {
                hideLoading();
                showToast('success', 'Berhasil', `Reminder telah dikirim ke ${pelanggan.nama}`);
                
                // Log aktivitas
                db.collection('aktivitas').add({
                    aktivitas: `Kirim reminder ke ${pelanggan.nama}`,
                    user: currentUser?.name || 'Administrator',
                    timestamp: new Date().toISOString()
                });
            }, 1500);
        }
        
    } catch (error) {
        console.error("Error kirim reminder:", error);
        showToast('error', 'Error', 'Gagal mengirim reminder');
    }
}

// FUNGSI UNTUK TOMBOL "PRINT"
function printInvoice(tagihanId) {
    console.log("Print invoice:", tagihanId);
    
    // Buka window print
    window.open(`?print=${tagihanId}`, '_blank');
    
    // Atau show toast info
    showToast('info', 'Print Invoice', 'Membuka printer dialog...');
}

// Fungsi sederhana untuk print detail
function printInvoiceDetail(tagihanId) {
    const printContent = document.querySelector('.modal-overlay.show .modal-body').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}
        
        async function konfirmasiPembayaran() {
            try {
                const form = document.getElementById('formBayarTagihan');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                showLoading();
                
                const tagihanId = document.getElementById('tagihanId').value;
                const totalBayar = parseInt(document.getElementById('totalBayar').value);
                const metodeBayar = document.getElementById('metodeBayar').value;
                const tanggalBayar = document.getElementById('tanggalBayar').value;
                const referensiBayar = document.getElementById('referensiBayar').value;
                const catatanBayar = document.getElementById('catatanBayar').value;
                
                await db.collection('tagihan').doc(tagihanId).update({
                    status: 'lunas',
                    total_bayar: totalBayar,
                    metode_bayar: metodeBayar,
                    tanggal_bayar: tanggalBayar,
                    referensi_bayar: referensiBayar,
                    catatan_bayar: catatanBayar,
                    updated_at: new Date().toISOString()
                });
                
                // Log activity
                await db.collection('aktivitas').add({
                    aktivitas: `Konfirmasi pembayaran tagihan ${tagihanId.substring(0, 8)}...`,
                    user: currentUser?.name || 'Administrator',
                    timestamp: new Date().toISOString()
                });
                
                hideModal('modalBayarTagihan');
                hideLoading();
                
                showToast('success', 'Berhasil', 'Pembayaran berhasil dikonfirmasi');
                
                if (currentPage === 'tagihan') {
                    await loadTagihanData();
                }
                if (currentPage === 'tunggakan') {
                    await loadTunggakanData();
                }
                if (currentPage === 'dashboard') {
                    await renderDashboard();
                }
                
            } catch (error) {
                console.error("Error confirming payment:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal konfirmasi pembayaran');
            }
        }
        
        // ============================================
        // PRORATA CALCULATOR
        // ============================================
        
        function hitungProrata() {
    const biaya = parseInt(document.getElementById('prorataBiaya').value) || 0;
    const mulai = document.getElementById('prorataMulai').value;
    const akhir = document.getElementById('prorataAkhir').value;
    
    if (!mulai || !akhir) {
        showToast('error', 'Error', 'Isi tanggal mulai dan akhir');
        return;
    }
    
    const startDate = moment(mulai);
    const endDate = moment(akhir);
    
    if (endDate.isBefore(startDate)) {
        showToast('error', 'Error', 'Tanggal akhir harus setelah tanggal mulai');
        return;
    }
    
    const jumlahHari = endDate.diff(startDate, 'days') + 1;
    const hariDalamBulan = 30; // Asumsi 30 hari
    
    // === PERBAIKAN: Hitung prorata arrears ===
    const prorata = Math.round((biaya / hariDalamBulan) * jumlahHari);
    
    document.getElementById('prorataHari').value = jumlahHari;
    document.getElementById('prorataHasil').innerHTML = `
        <strong>${formatRupiah(prorata)}</strong>
        <br>
        <small style="color: var(--gray);">
            Untuk ${jumlahHari} hari pemakaian (${startDate.format('DD MMM')} - ${endDate.format('DD MMM YYYY')})
        </small>
    `;
    
    // Tampilkan penjelasan arrears
    const bulanTagihan = startDate.format('MMM YYYY');
    const jatuhTempo = endDate.add(1, 'month').date(10).format('DD MMM YYYY');
    
    const explanation = `
        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
            <strong>Sistem ARREARS:</strong><br>
             Pemakaian: ${bulanTagihan}<br>
             Tagihan dibuat: ${moment().format('DD MMM YYYY')}<br>
             Jatuh tempo: ${jatuhTempo}
        </div>
    `;
    
    document.getElementById('prorataHasil').insertAdjacentHTML('beforeend', explanation);
}
        
        // ============================================
        // REMINDER FUNCTIONS
        // ============================================
        
        async function kirimReminder() {
            try {
                showLoading();
                
                // Simulate sending reminders
                setTimeout(() => {
                    hideLoading();
                    hideModal('modalReminder');
                    showToast('success', 'Berhasil', 'Reminder berhasil dikirim ke pelanggan');
                    
                    // Log activity
                    db.collection('aktivitas').add({
                        aktivitas: 'Mengirim reminder tagihan',
                        user: currentUser?.name || 'Administrator',
                        timestamp: new Date().toISOString()
                    });
                }, 2000);
                
            } catch (error) {
                console.error("Error sending reminder:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal mengirim reminder');
            }
        }
        
        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        
        async function exportData() {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert(' HANYA ADMIN YANG BOLEH EXPORT DATA!');
        return;
    }
    
    try {
        showLoading();
        const type = document.getElementById('exportType').value;
        const format = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';
        
        let data = [];
        let filename = '';
        
        if (type === 'pelanggan') {
            const snapshot = await db.collection('pelanggan').get();
            data = snapshot.docs.map(doc => {
                const p = doc.data();
                return {
                    ID: doc.id,
                    Nama: p.nama,
                    Telepon: p.telepon,
                    Email: p.email,
                    Alamat: p.alamat,
                    Paket: p.paket,
                    Harga: p.harga,
                    Status: p.status,
                    'Tanggal Pasang': p.tanggal_pasang,
                    'Tanggal Update': p.updated_at
                };
            });
            filename = `pelanggan_${moment().format('YYYYMMDD_HHmmss')}`;
        } else if (type === 'paket') {
            const snapshot = await db.collection('paket').get();
            data = snapshot.docs.map(doc => {
                const p = doc.data();
                return {
                    ID: doc.id,
                    'Nama Paket': p.nama,
                    Kecepatan: p.kecepatan,
                    Harga: p.harga,
                    Kuota: p.kuota,
                    Deskripsi: p.deskripsi,
                    Fitur: p.fitur,
                    Status: p.status,
                    'Tanggal Buat': p.created_at
                };
            });
            filename = `paket_${moment().format('YYYYMMDD_HHmmss')}`;
        } else if (type === 'tagihan') {
            const snapshot = await db.collection('tagihan').limit(100).get();
            data = snapshot.docs.map(doc => {
                const t = doc.data();
                return {
                    Invoice: t.id,
                    Pelanggan: t.pelanggan_nama,
                    Bulan: t.bulan,
                    Jumlah: t.jumlah,
                    Status: t.status,
                    'Jatuh Tempo': t.tanggal_jatuh_tempo,
                    'Tanggal Bayar': t.tanggal_bayar || '-',
                    'Metode Bayar': t.metode_bayar || '-',
                    Denda: t.denda || 0
                };
            });
            filename = `tagihan_${moment().format('YYYYMMDD_HHmmss')}`;
        }
        
        if (format === 'excel') {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `${filename}.xlsx`);
        } else if (format === 'csv') {
            const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(data));
            downloadCSV(csv, `${filename}.csv`);
        }
        
        hideLoading();
        showToast('success', 'Berhasil', 'Data berhasil diexport');
        
    } catch (error) {
        console.error("Error exporting:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal export data');
    }
}
        
        // ============================================
        // OTHER BUTTON FUNCTIONS
        // ============================================
        
        function refreshDashboard() {
            renderDashboard();
            showToast('success', 'Berhasil', 'Dashboard diperbarui');
        }
        
        function exportPelanggan() {
            // For now, just export data
            document.getElementById('exportType').value = 'pelanggan';
            exportData();
        }
        
        function generateSingleTagihan(pelangganId) {
            showToast('info', 'Info', 'Membuat tagihan untuk pelanggan...');
            // Implementation would be similar to bulk generate but for single customer
        }
        
        function sendReminderSingle(pelangganId) {
            showToast('info', 'Info', 'Mengirim reminder ke pelanggan...');
        }
        
        function printPelanggan() {
            window.print();
        }
        
        function exportPelangganPDF() {
            showToast('info', 'Coming Soon', 'Export PDF akan segera tersedia');
        }
        
        function exportPaket() {
            document.getElementById('exportType').value = 'paket';
            exportData();
        }
        
        function printTagihan() {
            window.print();
        }
        
        function exportTagihanPDF() {
            showToast('info', 'Coming Soon', 'Export PDF akan segera tersedia');
        }
        
        function exportTunggakan() {
            document.getElementById('exportType').value = 'tunggakan';
            exportData();
        }
        
        function generateTunggakanReport() {
            showToast('info', 'Coming Soon', 'Laporan tunggakan akan segera tersedia');
        }
        
        function sendWhatsAppReminder() {
            showToast('info', 'Coming Soon', 'WhatsApp reminder akan segera tersedia');
        }
        
        function suspendingPelanggan(pelangganId) {
            confirmDialog('Suspend pelanggan ini?', async () => {
                try {
                    showLoading();
                    await db.collection('pelanggan').doc(pelangganId).update({
                        status: 'nonaktif'
                    });
                    
                    hideLoading();
                    showToast('success', 'Berhasil', 'Pelanggan berhasil disuspend');
                    
                    if (currentPage === 'tunggakan') {
                        await loadTunggakanData();
                    }
                    
                } catch (error) {
                    console.error("Error suspending pelanggan:", error);
                    hideLoading();
                    showToast('error', 'Error', 'Gagal suspend pelanggan');
                }
            });
        }
        
        function viewInvoice(tagihanId) {
            showToast('info', 'Coming Soon', 'View invoice akan segera tersedia');
        }
        
        function printInvoice(tagihanId) {
            showToast('info', 'Coming Soon', 'Print invoice akan segera tersedia');
        }
        
        function downloadTemplate() {
            showToast('info', 'Coming Soon', 'Download template akan segera tersedia');
        }
        
        async function importExcel() {
            try {
                const fileInput = document.getElementById('fileImport');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('error', 'Error', 'Pilih file terlebih dahulu');
                    return;
                }
                
                showLoading();
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        // Process data based on import type
                        const importType = document.getElementById('importType').value;
                        
                        showToast('success', 'Berhasil', `${jsonData.length} data berhasil diimport`);
                        
                        hideLoading();
                        
                    } catch (error) {
                        console.error("Error importing data:", error);
                        hideLoading();
                        showToast('error', 'Error', 'Gagal import data');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error("Error importing:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal import data');
            }
        }
        
        function backupManual() {
            showModal('modalBackup');
        }
        
        function startBackup() {
            showToast('info', 'Coming Soon', 'Backup otomatis akan segera tersedia');
        }
        
        function restoreBackup() {
            showToast('info', 'Coming Soon', 'Restore backup akan segera tersedia');
        }
        
        function generateLaporan() {
            showToast('info', 'Coming Soon', 'Generate laporan akan segera tersedia');
        }
        
        function printLaporan() {
            window.print();
        }
        
        function exportLaporan() {
            showModal('modalExportLaporan');
        }
        
        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        // Login Handler
        document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                showLoading();
                
                // Simple authentication
                if (username === 'admin' && password === 'admin123') {
                    currentUser = {
                        uid: 'admin',
                        name: 'Administrator',
                        email: 'admin@xbill.com',
                        role: 'admin'
                    };
                    
                    localStorage.setItem('xbill_user', JSON.stringify(currentUser));
                    
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    
                    // Update UI
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
                    
                    // Load dashboard
                    await loadPage('dashboard');
                    
                    hideLoading();
                    showToast('success', 'Login Berhasil', `Selamat datang, ${currentUser.name}!`);
                    return;
                }
                
                // Try Firebase authentication
                try {
                    const email = username.includes('@') ? username : `${username}@xbill.com`;
                    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    currentUser = {
                        uid: user.uid,
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        role: 'admin'
                    };
                    
                    localStorage.setItem('xbill_user', JSON.stringify(currentUser));
                    
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
                    
                    await loadPage('dashboard');
                    
                    hideLoading();
                    showToast('success', 'Login Berhasil', `Selamat datang, ${currentUser.name}!`);
                    
                } catch (firebaseError) {
                    console.error("Firebase auth error:", firebaseError);
                    hideLoading();
                    showToast('error', 'Login Gagal', 'Username atau password salah');
                }
                
            } catch (error) {
                console.error("Login error:", error);
                hideLoading();
                showToast('error', 'Error', 'Terjadi kesalahan sistem');
            }
        });
        
        // Navigation Handler
        document.addEventListener('click', function(e) {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                e.preventDefault();
                const page = navItem.getAttribute('data-page');
                loadPage(page);
            }
        });
        
        // Logout Handler
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            confirmDialog('Logout dari sistem?', function() {
                localStorage.removeItem('xbill_user');
                window.location.reload();
            });
        });
        
// ============================================
// INISIALISASI EVENT LISTENER - TAMBAHKAN INI
// ============================================

// Tunggu DOM siap
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded, attaching event listeners...");
  
  // 1. Login form
  loginForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  
  try {
    // Firebase Auth login
    const userCredential = await firebase.auth().signInWithEmailAndPassword(
      'dovand@gmail.com', // EMAIL YANG BENER
      'dovand7'           // PASSWORD YANG BENER
    );
    
    // ========== TAMBAH INI ==========
    // SET ROLE KE ADMIN (karena email dovand@gmail.com adalah admin)
    localStorage.setItem('userRole', 'admin');
    localStorage.setItem('userName', 'Administrator');
    // ================================
    
    console.log(" Login sebagai admin");
    showApp();
    
  } catch (error) {
    console.error("Login error:", error);
    alert("Login gagal: " + error.message);
  }
});
  
  // 2. Logout button
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function() {
      localStorage.clear();
      location.reload();
    });
  }
  
  // 3. Bottom nav
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const page = this.getAttribute('data-page');
      if (page) loadPage(page);
    });
  });
});


async function getSettingHTML() {
    return `
        <div class="page setting-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-cog"></i> System Settings</h2>
            </div>
            
            <!-- SETTING MENU GRID -->
            <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                
                <!-- PROFIL PERUSAHAAN -->
                <div class="setting-card" onclick="showCompanyProfile()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Profil Perusahaan</h3>
                        <p>Kelola data perusahaan, alamat, kontak, dan informasi bisnis</p>
                        <div class="setting-badge">Pengaturan Dasar</div>
                    </div>
                </div>
                
                <!-- LOGO & BRANDING -->
                <div class="setting-card" onclick="showBrandingSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-palette"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logo & Branding</h3>
                        <p>Custom logo, warna tema, font, dan tampilan aplikasi</p>
                        <div class="setting-badge">UI/UX</div>
                    </div>
                </div>
                
                <!-- KONTAK & NOTIFIKASI -->
                <div class="setting-card" onclick="showContactSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Kontak & Notifikasi</h3>
                        <p>WhatsApp, Email, SMS, dan pengaturan notifikasi</p>
                        <div class="setting-badge">Komunikasi</div>
                    </div>
                </div>
                
                <!-- TEMPLATE PESAN -->
                <div class="setting-card" onclick="showMessageTemplates()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-comment-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Template Pesan</h3>
                        <p>Custom template untuk reminder, invoice, dan notifikasi</p>
                        <div class="setting-badge">Marketing</div>
                    </div>
                </div>
                
                <!-- KEUANGAN & PAJAK -->
                <div class="setting-card" onclick="showFinancialSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keuangan & Pajak</h3>
                        <p>PPN, denda, metode pembayaran, dan laporan keuangan</p>
                        <div class="setting-badge">Financial</div>
                    </div>
                </div>
                
                <!-- KEAMANAN -->
                <div class="setting-card" onclick="showSecuritySettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keamanan & Akses</h3>
                        <p>Password, user roles, audit log, dan pengamanan data</p>
                        <div class="setting-badge">Security</div>
                    </div>
                </div>
                
                <!-- BACKUP & RESTORE -->
                <div class="setting-card" onclick="showBackupSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%);">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Backup & Restore</h3>
                        <p>Auto-backup, restore data, dan management database</p>
                        <div class="setting-badge">Data</div>
                    </div>
                </div>
                
                <!-- SYSTEM SETTINGS -->
                <div class="setting-card" onclick="showSystemSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <div class="setting-content">
                        <h3>System Settings</h3>
                        <p>Timezone, bahasa, format tanggal, dan pengaturan sistem</p>
                        <div class="setting-badge">System</div>
                    </div>
                </div>
                
                <!-- USER MANAGEMENT -->
                <div class="setting-card" onclick="showUserManagement()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="setting-content">
                        <h3>User Management</h3>
                        <p>Kelola user, permissions, roles, dan akses aplikasi</p>
                        <div class="setting-badge">Admin</div>
                    </div>
                </div>
                
                <!-- API & INTEGRATION -->
                <div class="setting-card" onclick="showAPISettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="setting-content">
                        <h3>API & Integration</h3>
                        <p>API keys, webhooks, dan integrasi dengan sistem lain</p>
                        <div class="setting-badge">Developer</div>
                    </div>
                </div>
                
                <!-- LOGS & AUDIT -->
                <div class="setting-card" onclick="showLogsAudit()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logs & Audit</h3>
                        <p>Activity logs, audit trail, dan monitoring sistem</p>
                        <div class="setting-badge">Monitoring</div>
                    </div>
                </div>
                
                <!-- ABOUT & INFO -->
                <div class="setting-card" onclick="showAboutInfo()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Tentang Aplikasi</h3>
                        <p>Versi, update, credits, dan informasi sistem</p>
                        <div class="setting-badge">Info</div>
                    </div>
                </div>
                
            </div>
            
            <!-- QUICK SETTINGS PANEL -->
            <div class="card" style="margin-top: 30px;">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Settings</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                        <!-- DARK MODE TOGGLE -->
                        <div class="quick-setting">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="quickDarkMode" 
                                           onchange="toggleDarkMode()" style="width: 3em; height: 1.5em;">
                                </div>
                                <div>
                                    <strong>Dark Mode</strong>
                                    <div style="font-size: 12px; color: var(--gray);">Tema gelap/terang</div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- NOTIFICATION TOGGLE -->
                        <div class="quick-setting">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="quickNotifications" 
                                           checked style="width: 3em; height: 1.5em;">
                                </div>
                                <div>
                                    <strong>Notifications</strong>
                                    <div style="font-size: 12px; color: var(--gray);">Aktifkan notifikasi</div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- AUTO-BACKUP -->
                        <div class="quick-setting">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="quickAutoBackup" 
                                           checked style="width: 3em; height: 1.5em;">
                                </div>
                                <div>
                                    <strong>Auto-Backup</strong>
                                    <div style="font-size: 12px; color: var(--gray);">Backup otomatis harian</div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- EMAIL NOTIFICATION -->
                        <div class="quick-setting">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="quickEmailNotify" 
                                           checked style="width: 3em; height: 1.5em;">
                                </div>
                                <div>
                                    <strong>Email Notify</strong>
                                    <div style="font-size: 12px; color: var(--gray);">Notifikasi via email</div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- WHATSAPP NOTIFY -->
                        <div class="quick-setting">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="quickWhatsappNotify" 
                                           checked style="width: 3em; height: 1.5em;">
                                </div>
                                <div>
                                    <strong>WhatsApp Notify</strong>
                                    <div style="font-size: 12px; color: var(--gray);">Notifikasi via WhatsApp</div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- SMS NOTIFY -->
                        <div class="quick-setting">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="quickSMSNotify" 
                                           style="width: 3em; height: 1.5em;">
                                </div>
                                <div>
                                    <strong>SMS Notify</strong>
                                    <div style="font-size: 12px; color: var(--gray);">Notifikasi via SMS</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SYSTEM STATUS -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> System Status</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="status-item">
                            <div class="status-label">Database</div>
                            <div class="status-value" style="color: #00b894;">
                                <i class="fas fa-check-circle"></i> Connected
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Storage</div>
                            <div class="status-value" style="color: #4361ee;">
                                <i class="fas fa-hdd"></i> 2.4 GB / 5 GB
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Last Backup</div>
                            <div class="status-value" id="lastBackupStatus">2 jam lalu</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">System Uptime</div>
                            <div class="status-value" id="systemUptime">15 hari 4 jam</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Active Users</div>
                            <div class="status-value" id="activeUsersCount">3 users</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">App Version</div>
                            <div class="status-value" id="appVersion">v2.1.0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DANGER ZONE -->
            <div class="card" style="margin-top: 30px; border: 2px solid var(--danger);">
                <div class="card-header" style="background: #ff6b6b; color: white;">
                    <h3 style="margin: 0;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <button class="btn btn-outline-danger" onclick="forceLogoutAll()">
                            <i class="fas fa-sign-out-alt"></i> Force Logout All Users
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearAllCache()">
                            <i class="fas fa-trash"></i> Clear All Cache
                        </button>
                        <button class="btn btn-outline-danger" onclick="resetAllSettings()">
                            <i class="fas fa-redo"></i> Reset to Default
                        </button>
                        <button class="btn btn-danger" onclick="deleteAllData()">
                            <i class="fas fa-skull-crossbones"></i> Delete All Data
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <small><i class="fas fa-exclamation-triangle"></i> 
                            <strong>Peringatan:</strong> Tindakan di zona ini tidak dapat dibatalkan. Backup data Anda terlebih dahulu.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
}



// ============================================
// PAKET 1: PROFIL PERUSAHAAN
// ============================================

// Load data profil perusahaan
async function loadCompanyProfile() {
    try {
        const doc = await db.collection('settings').doc('company_profile').get();
        if (doc.exists) {
            const data = doc.data();
            document.getElementById('companyName').value = data.nama || '';
            document.getElementById('companyTagline').value = data.tagline || '';
            document.getElementById('companyAddress').value = data.alamat || '';
            document.getElementById('companyPhone').value = data.telepon || '';
            document.getElementById('companyEmail').value = data.email || '';
            document.getElementById('companyWebsite').value = data.website || '';
            document.getElementById('companyNPWP').value = data.npwp || '';
            document.getElementById('companyDirector').value = data.direktur || '';
            document.getElementById('companyType').value = data.jenis_usaha || 'isp';
            document.getElementById('invoicePrefix').value = data.invoice_prefix || 'INV';
            document.getElementById('invoiceFooter').value = data.invoice_footer || '';
            document.getElementById('invoiceTerms').value = data.invoice_terms || '';
        }
    } catch (error) {
        console.error("Error load company profile:", error);
    }
}

// Save profil perusahaan
async function saveCompanyProfile() {
    try {
        const data = {
            nama: document.getElementById('companyName').value.trim(),
            tagline: document.getElementById('companyTagline').value.trim(),
            alamat: document.getElementById('companyAddress').value.trim(),
            telepon: document.getElementById('companyPhone').value.trim(),
            email: document.getElementById('companyEmail').value.trim(),
            website: document.getElementById('companyWebsite').value.trim(),
            npwp: document.getElementById('companyNPWP').value.trim(),
            direktur: document.getElementById('companyDirector').value.trim(),
            jenis_usaha: document.getElementById('companyType').value,
            invoice_prefix: document.getElementById('invoicePrefix').value.trim(),
            invoice_footer: document.getElementById('invoiceFooter').value.trim(),
            invoice_terms: document.getElementById('invoiceTerms').value.trim(),
            updated_at: new Date().toISOString(),
            updated_by: currentUser?.email || 'admin'
        };

        await db.collection('settings').doc('company_profile').set(data, { merge: true });
        
        showToast('success', 'Berhasil', 'Profil perusahaan disimpan');
        hideModal('modalCompanyProfile');
        
        // Update aktivitas
        await db.collection('aktivitas').add({
            aktivitas: 'Memperbarui profil perusahaan',
            user: currentUser?.email || 'admin',
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error("Error save company profile:", error);
        showToast('error', 'Error', 'Gagal menyimpan profil');
    }
}

// ============================================
// PAKET 2: LOGO & BRANDING
// ============================================

// Preview logo upload
function previewLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('logoPreview');
            preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; border-radius: 10px; object-fit: cover;">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Load branding settings
async function loadBranding() {
    try {
        const doc = await db.collection('settings').doc('branding').get();
        if (doc.exists) {
            const data = doc.data();
            
            // Set warna
            if (data.primary_color) document.getElementById('primaryColor').value = data.primary_color;
            if (data.secondary_color) document.getElementById('secondaryColor').value = data.secondary_color;
            
            // Set tema
            if (data.dashboard_theme) {
                document.querySelector(`input[name="dashboardTheme"][value="${data.dashboard_theme}"]`).checked = true;
            }
            
            // Set font
            if (data.main_font) document.getElementById('mainFont').value = data.main_font;
            if (data.font_size) document.getElementById('fontSize').value = data.font_size;
            
            // Load logo jika ada URL
            if (data.logo_url) {
                const preview = document.getElementById('logoPreview');
                preview.innerHTML = `<img src="${data.logo_url}" style="width: 100%; height: 100%; border-radius: 10px; object-fit: cover;">`;
            }
        }
    } catch (error) {
        console.error("Error load branding:", error);
    }
}

// Save branding settings
async function saveBranding() {
    try {
        // Upload logo jika ada
        const logoInput = document.getElementById('logoUpload');
        let logoUrl = '';
        
        if (logoInput.files.length > 0) {
            // NOTE: Di production, upload ke Firebase Storage
            logoUrl = URL.createObjectURL(logoInput.files[0]);
        }
        
        const data = {
            primary_color: document.getElementById('primaryColor').value,
            secondary_color: document.getElementById('secondaryColor').value,
            dashboard_theme: document.querySelector('input[name="dashboardTheme"]:checked').value,
            main_font: document.getElementById('mainFont').value,
            font_size: document.getElementById('fontSize').value,
            logo_url: logoUrl,
            updated_at: new Date().toISOString()
        };
        
        await db.collection('settings').doc('branding').set(data, { merge: true });
        
        // Terapkan tema langsung
        applyTheme(data);
        
        showToast('success', 'Berhasil', 'Branding diterapkan');
        hideModal('modalBranding');
        
    } catch (error) {
        console.error("Error save branding:", error);
        showToast('error', 'Error', 'Gagal menyimpan branding');
    }
}

// Terapkan tema ke aplikasi
function applyTheme(themeData) {
    // Update CSS variables
    document.documentElement.style.setProperty('--primary', themeData.primary_color);
    document.documentElement.style.setProperty('--secondary', themeData.secondary_color);
    
    // Terapkan font
    document.body.style.fontFamily = themeData.main_font;
    document.body.style.fontSize = themeData.font_size;
    
    // Terapkan tema gelap/terang
    if (themeData.dashboard_theme === 'dark') {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
}

// ============================================
// PAKET 3: KONTAK & NOTIFIKASI (WA/EMAIL/SMS)
// ============================================

// Load contact settings
async function loadContactSettings() {
    try {
        const doc = await db.collection('settings').doc('notifications').get();
        if (doc.exists) {
            const data = doc.data();
            
            // WhatsApp settings
            if (data.whatsapp_number) document.getElementById('whatsappNumber').value = data.whatsapp_number;
            if (data.whatsapp_api_key) document.getElementById('whatsappApiKey').value = data.whatsapp_api_key;
            document.getElementById('enableWhatsApp').checked = data.enable_whatsapp !== false;
            
            // Email settings
            if (data.smtp_host) document.getElementById('smtpHost').value = data.smtp_host;
            if (data.smtp_port) document.getElementById('smtpPort').value = data.smtp_port;
            if (data.smtp_email) document.getElementById('smtpEmail').value = data.smtp_email;
            document.getElementById('enableSSL').checked = data.smtp_ssl === true;
            
            // SMS settings
            if (data.sms_provider) document.getElementById('smsProvider').value = data.sms_provider;
            document.getElementById('enableSMS').checked = data.enable_sms === true;
            
            // Notification settings
            document.getElementById('notifNewCustomer').checked = data.notif_new_customer !== false;
            document.getElementById('notifPayment').checked = data.notif_payment !== false;
            document.getElementById('notifOverdue').checked = data.notif_overdue !== false;
            document.getElementById('reminder3Days').checked = data.reminder_3days === true;
            document.getElementById('reminder1Day').checked = data.reminder_1day === true;
            document.getElementById('reminderOverdue').checked = data.reminder_overdue === true;
        }
    } catch (error) {
        console.error("Error load contact settings:", error);
    }
}

// Save contact settings
async function saveContactSettings() {
    try {
        const data = {
            // WhatsApp
            whatsapp_number: document.getElementById('whatsappNumber').value.trim(),
            whatsapp_api_key: document.getElementById('whatsappApiKey').value.trim(),
            enable_whatsapp: document.getElementById('enableWhatsApp').checked,
            
            // Email
            smtp_host: document.getElementById('smtpHost').value.trim(),
            smtp_port: parseInt(document.getElementById('smtpPort').value) || 587,
            smtp_email: document.getElementById('smtpEmail').value.trim(),
            smtp_ssl: document.getElementById('enableSSL').checked,
            
            // SMS
            sms_provider: document.getElementById('smsProvider').value,
            enable_sms: document.getElementById('enableSMS').checked,
            
            // Notifications
            notif_new_customer: document.getElementById('notifNewCustomer').checked,
            notif_payment: document.getElementById('notifPayment').checked,
            notif_overdue: document.getElementById('notifOverdue').checked,
            reminder_3days: document.getElementById('reminder3Days').checked,
            reminder_1day: document.getElementById('reminder1Day').checked,
            reminder_overdue: document.getElementById('reminderOverdue').checked,
            
            updated_at: new Date().toISOString()
        };
        
        // Simpan password terpisah jika diisi
        const smtpPassword = document.getElementById('smtpPassword').value;
        const smsApiKey = document.getElementById('smsApiKey').value;
        const smsSecret = document.getElementById('smsSecret').value;
        
        if (smtpPassword) {
            data.smtp_password = smtpPassword;
        }
        if (smsApiKey) {
            data.sms_api_key = smsApiKey;
        }
        if (smsSecret) {
            data.sms_secret = smsSecret;
        }
        
        await db.collection('settings').doc('notifications').set(data, { merge: true });
        
        showToast('success', 'Berhasil', 'Pengaturan notifikasi disimpan');
        hideModal('modalContactSettings');
        
    } catch (error) {
        console.error("Error save contact settings:", error);
        showToast('error', 'Error', 'Gagal menyimpan pengaturan');
    }
}

// Test notifikasi
async function testNotification() {
    try {
        const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
        const email = document.getElementById('smtpEmail').value.trim();
        
        if (!whatsappNumber && !email) {
            showToast('warning', 'Peringatan', 'Isi WhatsApp atau Email terlebih dahulu');
            return;
        }
        
        // Test WhatsApp
        if (whatsappNumber && document.getElementById('enableWhatsApp').checked) {
            await testWhatsApp(whatsappNumber);
        }
        
        // Test Email
        if (email && document.getElementById('smtpEmail').value) {
            await testEmail(email);
        }
        
        showToast('success', 'Test Dikirim', 'Test notifikasi sedang dikirim');
        
    } catch (error) {
        console.error("Error test notification:", error);
        showToast('error', 'Error', 'Gagal mengirim test');
    }
}

// Test WhatsApp
async function testWhatsApp(phoneNumber) {
    const apiKey = document.getElementById('whatsappApiKey').value.trim();
    
    // Pilihan provider WhatsApp
    const providers = {
        'fonnte': `https://api.fonnte.com/send`,
        'whacenter': `https://gate.whacenter.com/api/send`,
        'wablas': `https://api.wablas.com/api/send-message`,
        'ruangwa': `https://api.ruangwa.com/api/send-message`
    };
    
    // Jika ada API key, gunakan provider
    if (apiKey) {
        // Implementasi berdasarkan provider
        // Contoh untuk Fonnte
        try {
            const response = await fetch('https://api.fonnte.com/send', {
                method: 'POST',
                headers: {
                    'Authorization': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    target: phoneNumber,
                    message: ` Test Notifikasi X-BILL\n\nHalo! Ini adalah test notifikasi WhatsApp dari sistem X-BILL.\n\nWaktu: ${new Date().toLocaleString()}\n\n Notifikasi WhatsApp berfungsi dengan baik.`
                })
            });
            
            const result = await response.json();
            if (result.status) {
                console.log(" WhatsApp test sent:", result);
            }
        } catch (error) {
            console.error(" WhatsApp test error:", error);
        }
    } else {
        // Fallback: buka WhatsApp web
        const message = encodeURIComponent(` Test Notifikasi X-BILL\n\nHalo! Ini adalah test notifikasi WhatsApp dari sistem X-BILL.\n\nWaktu: ${new Date().toLocaleString()}\n\n Notifikasi WhatsApp berfungsi dengan baik.`);
        window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
    }
}

// Test Email
async function testEmail(email) {
    // Implementasi pengiriman email
    // Di production, gunakan EmailJS atau backend server
    showToast('info', 'Email Test', `Test email akan dikirim ke ${email}\n(Di production perlu backend server)`);
}

// ============================================
// PAKET 4: TEMPLATE PESAN
// ============================================

// Load message templates
async function loadMessageTemplates() {
    try {
        const doc = await db.collection('settings').doc('templates').get();
        if (doc.exists) {
            const data = doc.data();
            
            // Reminder templates
            if (data.reminder_3days) document.getElementById('templateReminder3Days').value = data.reminder_3days;
            if (data.reminder_1day) document.getElementById('templateReminder1Day').value = data.reminder_1day;
            if (data.reminder_overdue) document.getElementById('templateOverdue').value = data.reminder_overdue;
            
            // Confirmation templates
            if (data.payment_confirmed) document.getElementById('templatePaymentConfirmed').value = data.payment_confirmed;
            if (data.new_invoice) document.getElementById('templateNewInvoice').value = data.new_invoice;
            
            // Welcome template
            if (data.welcome_message) document.getElementById('templateWelcome').value = data.welcome_message;
        }
    } catch (error) {
        console.error("Error load templates:", error);
    }
}

// Save message templates
async function saveMessageTemplates() {
    try {
        const data = {
            reminder_3days: document.getElementById('templateReminder3Days').value.trim(),
            reminder_1day: document.getElementById('templateReminder1Day').value.trim(),
            reminder_overdue: document.getElementById('templateOverdue').value.trim(),
            payment_confirmed: document.getElementById('templatePaymentConfirmed').value.trim(),
            new_invoice: document.getElementById('templateNewInvoice').value.trim(),
            welcome_message: document.getElementById('templateWelcome')?.value.trim() || '',
            updated_at: new Date().toISOString()
        };
        
        await db.collection('settings').doc('templates').set(data, { merge: true });
        
        showToast('success', 'Berhasil', 'Template pesan disimpan');
        hideModal('modalMessageTemplates');
        
    } catch (error) {
        console.error("Error save templates:", error);
        showToast('error', 'Error', 'Gagal menyimpan template');
    }
}

// ============================================
// PAKET 5: KEUANGAN & PAJAK
// ============================================

// Load financial settings
async function loadFinancialSettings() {
    try {
        const doc = await db.collection('settings').doc('financial').get();
        if (doc.exists) {
            const data = doc.data();
            
            // Pajak
            if (data.ppn_percentage) document.getElementById('ppnPercentage').value = data.ppn_percentage;
            if (data.pph_percentage) document.getElementById('pphPercentage').value = data.pph_percentage;
            document.getElementById('enableTax').checked = data.enable_tax !== false;
            
            // Denda
            if (data.denda_per_hari) document.getElementById('dendaPerHari').value = data.denda_per_hari;
            if (data.max_denda) document.getElementById('maxDenda').value = data.max_denda;
            if (data.grace_period) document.getElementById('gracePeriod').value = data.grace_period;
            if (data.start_denda_after) document.getElementById('startDendaAfter').value = data.start_denda_after;
            
            // Mata uang
            if (data.currency) document.getElementById('currency').value = data.currency;
            if (data.currency_symbol) document.getElementById('currencySymbol').value = data.currency_symbol;
            if (data.rounding) document.getElementById('rounding').value = data.rounding;
            if (data.decimal_format) document.getElementById('decimalFormat').value = data.decimal_format;
            
            // Pelaporan
            if (data.fiscal_year_start) document.getElementById('fiscalYearStart').value = data.fiscal_year_start;
            if (data.report_deadline) document.getElementById('reportDeadline').value = data.report_deadline;
            document.getElementById('autoGenerateReport').checked = data.auto_generate_report === true;
        }
    } catch (error) {
        console.error("Error load financial:", error);
    }
}

// Save financial settings
async function saveFinancialSettings() {
    try {
        const data = {
            // Pajak
            ppn_percentage: parseFloat(document.getElementById('ppnPercentage').value) || 0,
            pph_percentage: parseFloat(document.getElementById('pphPercentage').value) || 0,
            enable_tax: document.getElementById('enableTax').checked,
            
            // Denda
            denda_per_hari: parseFloat(document.getElementById('dendaPerHari').value) || 0.5,
            max_denda: parseFloat(document.getElementById('maxDenda').value) || 10,
            grace_period: parseInt(document.getElementById('gracePeriod').value) || 3,
            start_denda_after: parseInt(document.getElementById('startDendaAfter').value) || 7,
            
            // Mata uang
            currency: document.getElementById('currency').value,
            currency_symbol: document.getElementById('currencySymbol').value.trim(),
            rounding: parseInt(document.getElementById('rounding').value) || 100,
            decimal_format: parseInt(document.getElementById('decimalFormat').value) || 0,
            
            // Pelaporan
            fiscal_year_start: parseInt(document.getElementById('fiscalYearStart').value) || 1,
            report_deadline: parseInt(document.getElementById('reportDeadline').value) || 5,
            auto_generate_report: document.getElementById('autoGenerateReport').checked,
            
            updated_at: new Date().toISOString()
        };
        
        await db.collection('settings').doc('financial').set(data, { merge: true });
        
        // Update formatRupiah jika mata uang berubah
        if (data.currency !== 'IDR') {
            showToast('info', 'Mata Uang', `Mata uang diubah ke ${data.currency}`);
        }
        
        showToast('success', 'Berhasil', 'Pengaturan keuangan disimpan');
        hideModal('modalFinancialSettings');
        
    } catch (error) {
        console.error("Error save financial:", error);
        showToast('error', 'Error', 'Gagal menyimpan pengaturan keuangan');
    }
}

// ============================================
// PAKET 6: KEAMANAN & AKSES
// ============================================

// Load security settings
async function loadSecuritySettings() {
    try {
        const doc = await db.collection('settings').doc('security').get();
        if (doc.exists) {
            const data = doc.data();
            
            // Login security
            if (data.max_login_attempts) document.getElementById('maxLoginAttempts').value = data.max_login_attempts;
            if (data.lockout_duration) document.getElementById('lockoutDuration').value = data.lockout_duration;
            if (data.session_timeout) document.getElementById('sessionTimeout').value = data.session_timeout;
            if (data.force_logout_hours) document.getElementById('forceLogoutHours').value = data.force_logout_hours;
            document.getElementById('requireStrongPassword').checked = data.require_strong_password === true;
            document.getElementById('enable2FA').checked = data.enable_2fa === true;
            
            // IP Security
            if (data.ip_whitelist) document.getElementById('ipWhitelist').value = data.ip_whitelist;
            document.getElementById('enableIPRestriction').checked = data.enable_ip_restriction === true;
            
            // Audit Log
            if (data.log_retention_days) document.getElementById('logRetentionDays').value = data.log_retention_days;
            if (data.log_backup_frequency) document.getElementById('logBackupFrequency').value = data.log_backup_frequency;
            document.getElementById('logLoginAttempts').checked = data.log_login_attempts !== false;
            document.getElementById('logDataChanges').checked = data.log_data_changes !== false;
            document.getElementById('logExports').checked = data.log_exports !== false;
            
            // User Roles
            if (data.default_user_role) document.getElementById('defaultUserRole').value = data.default_user_role;
            document.getElementById('allowMultipleSessions').checked = data.allow_multiple_sessions === true;
            document.getElementById('notifyNewLogin').checked = data.notify_new_login !== false;
        }
    } catch (error) {
        console.error("Error load security:", error);
    }
}

// Save security settings
async function saveSecuritySettings() {
    try {
        const data = {
            // Login security
            max_login_attempts: parseInt(document.getElementById('maxLoginAttempts').value) || 3,
            lockout_duration: parseInt(document.getElementById('lockoutDuration').value) || 15,
            session_timeout: parseInt(document.getElementById('sessionTimeout').value) || 30,
            force_logout_hours: parseInt(document.getElementById('forceLogoutHours').value) || 8,
            require_strong_password: document.getElementById('requireStrongPassword').checked,
            enable_2fa: document.getElementById('enable2FA').checked,
            
            // IP Security
            ip_whitelist: document.getElementById('ipWhitelist').value.trim(),
            enable_ip_restriction: document.getElementById('enableIPRestriction').checked,
            
            // Audit Log
            log_retention_days: parseInt(document.getElementById('logRetentionDays').value) || 90,
            log_backup_frequency: document.getElementById('logBackupFrequency').value,
            log_login_attempts: document.getElementById('logLoginAttempts').checked,
            log_data_changes: document.getElementById('logDataChanges').checked,
            log_exports: document.getElementById('logExports').checked,
            
            // User Roles
            default_user_role: document.getElementById('defaultUserRole').value,
            allow_multiple_sessions: document.getElementById('allowMultipleSessions').checked,
            notify_new_login: document.getElementById('notifyNewLogin').checked,
            
            updated_at: new Date().toISOString()
        };
        
        await db.collection('settings').doc('security').set(data, { merge: true });
        
        // Update session timeout jika berubah
        if (data.session_timeout) {
            localStorage.setItem('session_timeout', data.session_timeout.toString());
        }
        
        showToast('success', 'Berhasil', 'Pengaturan keamanan disimpan');
        hideModal('modalSecuritySettings');
        
    } catch (error) {
        console.error("Error save security:", error);
        showToast('error', 'Error', 'Gagal menyimpan pengaturan keamanan');
    }
}

// ============================================
// PAKET 7: BACKUP & RESTORE
// ============================================

// Load backup settings
async function loadBackupSettings() {
    try {
        const doc = await db.collection('settings').doc('backup').get();
        if (doc.exists) {
            const data = doc.data();
            
            // Backup schedule
            if (data.backup_frequency) document.getElementById('backupFrequency').value = data.backup_frequency;
            if (data.backup_time) document.getElementById('backupTime').value = data.backup_time;
            if (data.backup_day) document.getElementById('backupDay').value = data.backup_day;
            if (data.backup_date) document.getElementById('backupDate').value = data.backup_date;
            document.getElementById('enableAutoBackup').checked = data.enable_auto_backup !== false;
            
            // Backup content
            document.getElementById('backupPelanggan').checked = data.backup_pelanggan !== false;
            document.getElementById('backupPaket').checked = data.backup_paket !== false;
            document.getElementById('backupTagihan').checked = data.backup_tagihan !== false;
            document.getElementById('backupTunggakan').checked = data.backup_tunggakan !== false;
            document.getElementById('backupSettings').checked = data.backup_settings !== false;
            
            // Backup format
            if (data.backup_format) document.getElementById('backupFormat').value = data.backup_format;
            if (data.backup_encryption) document.getElementById('backupEncryption').value = data.backup_encryption;
            
            // Load backup history
            await loadBackupHistory();
        }
    } catch (error) {
        console.error("Error load backup:", error);
    }
}

// Load backup history
async function loadBackupHistory() {
    try {
        const snapshot = await db.collection('backup_history')
            .orderBy('created_at', 'desc')
            .limit(10)
            .get();
        
        const table = document.getElementById('backupHistoryTable');
        if (!table) return;
        
        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">Belum ada backup</td>
                </tr>
            `;
            return;
        }
        
        table.innerHTML = snapshot.docs.map(doc => {
            const data = doc.data();
            return `
                <tr>
                    <td>${moment(data.created_at).format('DD/MM/YY HH:mm')}</td>
                    <td><span class="badge badge-primary">${data.type || 'manual'}</span></td>
                    <td>${formatFileSize(data.size || 0)}</td>
                    <td><span class="badge badge-success">Success</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="downloadBackup('${data.download_url || ''}')">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Update summary
        const lastBackup = snapshot.docs[0]?.data();
        if (lastBackup) {
            document.getElementById('lastBackupTime').textContent = 
                moment(lastBackup.created_at).format('DD/MM/YY HH:mm');
        }
        document.getElementById('totalBackupCount').textContent = snapshot.size;
        
    } catch (error) {
        console.error("Error load backup history:", error);
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Save backup settings
async function saveBackupSettings() {
    try {
        const data = {
            // Backup schedule
            backup_frequency: document.getElementById('backupFrequency').value,
            backup_time: document.getElementById('backupTime').value,
            backup_day: parseInt(document.getElementById('backupDay').value) || 2,
            backup_date: parseInt(document.getElementById('backupDate').value) || 1,
            enable_auto_backup: document.getElementById('enableAutoBackup').checked,
            
            // Backup content
            backup_pelanggan: document.getElementById('backupPelanggan').checked,
            backup_paket: document.getElementById('backupPaket').checked,
            backup_tagihan: document.getElementById('backupTagihan').checked,
            backup_tunggakan: document.getElementById('backupTunggakan').checked,
            backup_settings: document.getElementById('backupSettings').checked,
            
            // Backup format
            backup_format: document.getElementById('backupFormat').value,
            backup_encryption: document.getElementById('backupEncryption').value,
            
            updated_at: new Date().toISOString()
        };
        
        await db.collection('settings').doc('backup').set(data, { merge: true });
        
        // Setup auto backup scheduler
        setupAutoBackup(data);
        
        showToast('success', 'Berhasil', 'Pengaturan backup disimpan');
        hideModal('modalBackupSettings');
        
    } catch (error) {
        console.error("Error save backup:", error);
        showToast('error', 'Error', 'Gagal menyimpan pengaturan backup');
    }
}

// Setup auto backup scheduler
function setupAutoBackup(settings) {
    if (!settings.enable_auto_backup || settings.backup_frequency === 'disabled') {
        return;
    }
    
    // Hapus scheduler lama
    if (window.backupScheduler) {
        clearInterval(window.backupScheduler);
    }
    
    // Setup scheduler baru berdasarkan frequency
    let interval = 24 * 60 * 60 * 1000; // Default daily
    
    switch (settings.backup_frequency) {
        case 'weekly':
            interval = 7 * 24 * 60 * 60 * 1000;
            break;
        case 'monthly':
            interval = 30 * 24 * 60 * 60 * 1000;
            break;
    }
    
    window.backupScheduler = setInterval(() => {
        console.log(" Auto backup running...");
        createBackupNow();
    }, interval);
}

// Create backup now
async function createBackupNow() {
    try {
        showToast('info', 'Backup', 'Membuat backup...');
        
        // Kumpulkan semua data
        const collections = ['pelanggan', 'paket', 'tagihan', 'settings'];
        const backupData = {};
        
        for (const collection of collections) {
            const snapshot = await db.collection(collection).get();
            backupData[collection] = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        }
        
        // Buat blob untuk download
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Simpan ke backup_history
        await db.collection('backup_history').add({
            type: 'manual',
            size: blob.size,
            collections: collections,
            created_at: new Date().toISOString(),
            download_url: url,
            created_by: currentUser?.email || 'system'
        });
        
        // Download otomatis
        const link = document.createElement('a');
        link.href = url;
        link.download = `backup_xbill_${moment().format('YYYYMMDD_HHmmss')}.json`;
        link.click();
        
        // Refresh history
        await loadBackupHistory();
        
        showToast('success', 'Backup Selesai', `Backup ${formatFileSize(blob.size)} berhasil dibuat`);
        
    } catch (error) {
        console.error("Error create backup:", error);
        showToast('error', 'Error', 'Gagal membuat backup');
    }
}

// ============================================
// PAKET 8: SYSTEM SETTINGS
// ============================================

// Load system settings
async function loadSystemSettings() {
    try {
        const doc = await db.collection('settings').doc('system').get();
        if (doc.exists) {
            const data = doc.data();
            
            // Timezone & waktu
            if (data.timezone) document.getElementById('systemTimezone').value = data.timezone;
            if (data.time_format) document.getElementById('timeFormat').value = data.time_format;
            if (data.date_format) document.getElementById('dateFormat').value = data.date_format;
            if (data.language) document.getElementById('systemLanguage').value = data.language;
            
            // Performance
            if (data.auto_refresh_interval) document.getElementById('autoRefreshInterval').value = data.auto_refresh_interval;
            if (data.items_per_page) document.getElementById('itemsPerPage').value = data.items_per_page;
            if (data.cache_duration) document.getElementById('cacheDuration').value = data.cache_duration;
            if (data.max_upload_size) document.getElementById('maxUploadSize').value = data.max_upload_size;
            document.getElementById('enableLazyLoading').checked = data.enable_lazy_loading !== false;
            
            // Notifications
            document.getElementById('notifSuccess').checked = data.notif_success !== false;
            document.getElementById('notifError').checked = data.notif_error !== false;
            document.getElementById('notifWarning').checked = data.notif_warning !== false;
            document.getElementById('notifInfo').checked = data.notif_info === true;
            
            if (data.toast_duration) document.getElementById('toastDuration').value = data.toast_duration;
            if (data.toast_position) document.getElementById('toastPosition').value = data.toast_position;
            
            // Maintenance
            if (data.auto_backup_schedule) document.getElementById('autoBackupSchedule').value = data.auto_backup_schedule;
            if (data.backup_retention_days) document.getElementById('backupRetentionDays').value = data.backup_retention_days;
            if (data.log_cleanup_days) document.getElementById('logCleanupDays').value = data.log_cleanup_days;
            document.getElementById('enableMaintenanceMode').checked = data.enable_maintenance_mode === true;
        }
    } catch (error) {
        console.error("Error load system:", error);
    }
}

// Save system settings
async function saveSystemSettings() {
    try {
        const data = {
            // Timezone & waktu
            timezone: document.getElementById('systemTimezone').value,
            time_format: document.getElementById('timeFormat').value,
            date_format: document.getElementById('dateFormat').value,
            language: document.getElementById('systemLanguage').value,
            
            // Performance
            auto_refresh_interval: parseInt(document.getElementById('autoRefreshInterval').value) || 60,
            items_per_page: parseInt(document.getElementById('itemsPerPage').value) || 10,
            cache_duration: parseInt(document.getElementById('cacheDuration').value) || 5,
            max_upload_size: parseInt(document.getElementById('maxUploadSize').value) || 10,
            enable_lazy_loading: document.getElementById('enableLazyLoading').checked,
            
            // Notifications
            notif_success: document.getElementById('notifSuccess').checked,
            notif_error: document.getElementById('notifError').checked,
            notif_warning: document.getElementById('notifWarning').checked,
            notif_info: document.getElementById('notifInfo').checked,
            toast_duration: parseInt(document.getElementById('toastDuration').value) || 4,
            toast_position: document.getElementById('toastPosition').value,
            
            // Maintenance
            auto_backup_schedule: document.getElementById('autoBackupSchedule').value,
            backup_retention_days: parseInt(document.getElementById('backupRetentionDays').value) || 30,
            log_cleanup_days: parseInt(document.getElementById('logCleanupDays').value) || 90,
            enable_maintenance_mode: document.getElementById('enableMaintenanceMode').checked,
            
            updated_at: new Date().toISOString()
        };
        
        await db.collection('settings').doc('system').set(data, { merge: true });
        
        // Apply settings langsung
        applySystemSettings(data);
        
        showToast('success', 'Berhasil', 'Pengaturan sistem disimpan');
        hideModal('modalSystemSettings');
        
    } catch (error) {
        console.error("Error save system:", error);
        showToast('error', 'Error', 'Gagal menyimpan pengaturan sistem');
    }
}

// Apply system settings
function applySystemSettings(settings) {
    // Set timezone untuk moment.js
    moment.tz.setDefault(settings.timezone);
    
    // Set items per page global
    window.itemsPerPage = settings.items_per_page;
    
    // Update toast duration
    window.toastDuration = settings.toast_duration * 1000;
}

// Clear system cache
async function clearSystemCache() {
    try {
        // Clear localStorage cache
        const keys = Object.keys(localStorage).filter(key => 
            key.startsWith('cache_') || key.includes('temp_')
        );
        
        keys.forEach(key => localStorage.removeItem(key));
        
        // Clear session data
        sessionStorage.clear();
        
        showToast('success', 'Cache Dihapus', 'Semua cache telah dibersihkan');
        
    } catch (error) {
        console.error("Error clear cache:", error);
        showToast('error', 'Error', 'Gagal membersihkan cache');
    }
}

// ============================================
// PAKET 9: USER MANAGEMENT (MODAL BARU)
// ============================================

// Buat modal User Management baru
function createUserManagementModal() {
    const modalId = 'modalUserManagement';
    
    // Cek jika modal sudah ada
    if (document.getElementById(modalId)) return;
    
    const modalHTML = `
    <div class="modal-overlay hidden" id="${modalId}">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-users-cog"></i> User Management</h3>
                <button class="modal-close" onclick="hideModal('${modalId}')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-user-plus"></i> Tambah User
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>Email/Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Terakhir Login</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementTable">
                            <tr>
                                <td colspan="6" class="text-center">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    `;
    
    // Tambah modal ke body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Load user management data
async function loadUserManagement() {
    try {
        // Di production, buat collection 'users' di Firestore
        const snapshot = await db.collection('users').get();
        const table = document.getElementById('userManagementTable');
        
        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">Belum ada user</td>
                </tr>
            `;
            return;
        }
        
        table.innerHTML = snapshot.docs.map(doc => {
            const user = doc.data();
            return `
                <tr>
                    <td>${user.full_name || '-'}</td>
                    <td>${user.email || user.username || '-'}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'badge-danger' : 'badge-primary'}">${user.role || 'user'}</span></td>
                    <td><span class="badge ${user.status === 'active' ? 'badge-success' : 'badge-warning'}">${user.status || 'inactive'}</span></td>
                    <td>${user.last_login ? moment(user.last_login).format('DD/MM/YY HH:mm') : '-'}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline" onclick="editUser('${doc.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="resetUserPassword('${doc.id}')">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="toggleUserStatus('${doc.id}', '${user.status}')">
                                <i class="fas ${user.status === 'active' ? 'fa-ban' : 'fa-check'}"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error("Error load users:", error);
        document.getElementById('userManagementTable').innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger">Error: ${error.message}</td>
            </tr>
        `;
    }
}

// ============================================
// PAKET 10: API & INTEGRATION (MODAL BARU)
// ============================================

// Buat modal API & Integration
function createAPIIntegrationModal() {
    const modalId = 'modalAPIIntegration';
    
    if (document.getElementById(modalId)) return;
    
    const modalHTML = `
    <div class="modal-overlay hidden" id="${modalId}">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-code"></i> API & Integration</h3>
                <button class="modal-close" onclick="hideModal('${modalId}')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-key"></i> API Keys</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>API Key</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="apiKey" readonly value="xbill_${generateApiKey()}">
                                <button class="btn btn-outline" onclick="copyToClipboard('apiKey')">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-outline" onclick="generateNewApiKey()">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <small class="text-muted">Gunakan API key untuk integrasi dengan sistem lain</small>
                        </div>
                        
                        <div class="form-group">
                            <label>API Secret</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="apiSecret" readonly value="${generateApiKey(32)}">
                                <button class="btn btn-outline" onclick="toggleApiSecret()">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline" onclick="generateNewApiSecret()">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-plug"></i> Webhooks</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Webhook URL</label>
                            <input type="url" class="form-control" id="webhookUrl" placeholder="https://your-server.com/webhook">
                        </div>
                        
                        <div class="form-group">
                            <label>Webhook Events</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="webhookNewCustomer" checked>
                                <label class="form-check-label">New Customer</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="webhookNewInvoice" checked>
                                <label class="form-check-label">New Invoice</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="webhookPayment">
                                <label class="form-check-label">Payment Received</label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="testWebhook()">
                            <i class="fas fa-paper-plane"></i> Test Webhook
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-share-alt"></i> Third-Party Integrations</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Accounting Software</label>
                            <select class="form-control" id="accountingIntegration">
                                <option value="">-- Pilih Software --</option>
                                <option value="jurnal">Jurnal.id</option>
                                <option value="accurate">Accurate</option>
                                <option value="myob">MYOB</option>
                                <option value="excel">Excel Export</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Gateway</label>
                            <select class="form-control" id="paymentIntegration">
                                <option value="">-- Pilih Gateway --</option>
                                <option value="midtrans">Midtrans</option>
                                <option value="xendit">Xendit</option>
                                <option value="doku">DOKU</option>
                                <option value="ipaymu">iPaymu</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('${modalId}')">Batal</button>
                <button class="btn btn-primary" onclick="saveAPIIntegration()">
                    <i class="fas fa-save"></i> Simpan
                </button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Generate API key
function generateApiKey(length = 24) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// ============================================
// PAKET 11: LOGS & AUDIT (MODAL BARU)
// ============================================

// Buat modal Logs & Audit
function createLogsAuditModal() {
    const modalId = 'modalLogsAudit';
    
    if (document.getElementById(modalId)) return;
    
    const modalHTML = `
    <div class="modal-overlay hidden" id="${modalId}">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-clipboard-list"></i> Logs & Audit Trail</h3>
                <button class="modal-close" onclick="hideModal('${modalId}')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filters-card" style="margin-bottom: 20px;">
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Jenis Log</label>
                            <select class="form-control" id="logTypeFilter" onchange="filterLogs()">
                                <option value="all">Semua</option>
                                <option value="login">Login</option>
                                <option value="data">Data Changes</option>
                                <option value="system">System</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dari Tanggal</label>
                            <input type="date" class="form-control" id="logDateFrom" onchange="filterLogs()">
                        </div>
                        <div class="form-group">
                            <label>Sampai Tanggal</label>
                            <input type="date" class="form-control" id="logDateTo" onchange="filterLogs()">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-outline" style="margin-top: 25px;" onclick="exportLogs()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>User</th>
                                <th>Aktivitas</th>
                                <th>Tipe</th>
                                <th>IP Address</th>
                                <th>Detail</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsTable">
                            <tr>
                                <td colspan="6" class="text-center">Memuat log...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="logsPagination"></div>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Load audit logs
async function loadAuditLogs(page = 1) {
    try {
        let query = db.collection('audit_logs').orderBy('timestamp', 'desc');
        
        // Apply filters
        const typeFilter = document.getElementById('logTypeFilter')?.value;
        const dateFrom = document.getElementById('logDateFrom')?.value;
        const dateTo = document.getElementById('logDateTo')?.value;
        
        if (typeFilter && typeFilter !== 'all') {
            query = query.where('type', '==', typeFilter);
        }
        
        if (dateFrom) {
            query = query.where('timestamp', '>=', new Date(dateFrom));
        }
        
        if (dateTo) {
            const nextDay = new Date(dateTo);
            nextDay.setDate(nextDay.getDate() + 1);
            query = query.where('timestamp', '<=', nextDay);
        }
        
        const snapshot = await query.limit(50).get();
        const table = document.getElementById('auditLogsTable');
        
        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">Tidak ada log</td>
                </tr>
            `;
            return;
        }
        
        table.innerHTML = snapshot.docs.map(doc => {
            const log = doc.data();
            let typeBadge = 'badge-info';
            if (log.type === 'error') typeBadge = 'badge-danger';
            if (log.type === 'login') typeBadge = 'badge-success';
            if (log.type === 'data') typeBadge = 'badge-warning';
            
            return `
                <tr>
                    <td>${moment(log.timestamp).format('DD/MM/YY HH:mm:ss')}</td>
                    <td><strong>${log.user || 'system'}</strong></td>
                    <td>${log.activity}</td>
                    <td><span class="badge ${typeBadge}">${log.type || 'system'}</span></td>
                    <td>${log.ip_address || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewLogDetail('${doc.id}')">
                            <i class="fas fa-search"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error("Error load audit logs:", error);
    }
}

// ============================================
// PAKET 12: TENTANG APLIKASI (MODAL BARU)
// ============================================

// Buat modal Tentang Aplikasi
function createAboutAppModal() {
    const modalId = 'modalAboutApp';
    
    if (document.getElementById(modalId)) return;
    
    const modalHTML = `
    <div class="modal-overlay hidden" id="${modalId}">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-info-circle"></i> Tentang Aplikasi</h3>
                <button class="modal-close" onclick="hideModal('${modalId}')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; background: var(--gradient); border-radius: 15px; 
                          margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-file-invoice-dollar" style="font-size: 40px; color: white;"></i>
                    </div>
                    <h3>X-BILL ISP Billing System</h3>
                    <p class="text-muted">v2.1.0</p>
                </div>
                
                <div class="card" style="margin-bottom: 15px;">
                    <div class="card-body">
                        <h5><i class="fas fa-cube"></i> System Information</h5>
                        <table class="table" style="font-size: 14px;">
                            <tr><td><strong>Database</strong></td><td>Firestore</td></tr>
                            <tr><td><strong>Authentication</strong></td><td>Firebase Auth</td></tr>
                            <tr><td><strong>Storage</strong></td><td>Firebase Storage</td></tr>
                            <tr><td><strong>Frontend</strong></td><td>HTML5, CSS3, JavaScript</td></tr>
                            <tr><td><strong>Chart Library</strong></td><td>Chart.js</td></tr>
                            <tr><td><strong>Export Library</strong></td><td>SheetJS (XLSX)</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="card" style="margin-bottom: 15px;">
                    <div class="card-body">
                        <h5><i class="fas fa-code-branch"></i> Version History</h5>
                        <ul style="padding-left: 20px; font-size: 14px;">
                            <li><strong>v2.1.0</strong> - WhatsApp Integration, Backup System</li>
                            <li><strong>v2.0.0</strong> - Complete Rewrite, Firebase Integration</li>
                            <li><strong>v1.5.0</strong> - Export/Import Features</li>
                            <li><strong>v1.0.0</strong> - Initial Release</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5><i class="fas fa-users"></i> Credits & Support</h5>
                        <p style="font-size: 14px;">
                            <strong>Developer:</strong> X-BILL Team<br>
                            <strong>Support:</strong> support@xbill.com<br>
                            <strong>Website:</strong> https://xbill.com
                        </p>
                        <button class="btn btn-outline btn-sm" onclick="checkForUpdates()">
                            <i class="fas fa-sync-alt"></i> Cek Update
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('${modalId}')">Tutup</button>
                <button class="btn btn-primary" onclick="openDocumentation()">
                    <i class="fas fa-book"></i> Dokumentasi
                </button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// ============================================
// PAKET 13: PROFIL USER
// ============================================

// Upload user photo
function uploadUserPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('userPhotoImg');
            const initials = document.getElementById('userInitials');
            
            img.src = e.target.result;
            img.style.display = 'block';
            initials.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Load user profile
async function loadUserProfile() {
    try {
        const userId = currentUser?.uid || 'admin';
        const doc = await db.collection('users').doc(userId).get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Set user initial jika ada nama
            if (data.full_name) {
                const initials = data.full_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('userInitials').textContent = initials;
            }
            
            // Set form values
            document.getElementById('userFullName').value = data.full_name || '';
            document.getElementById('userUsername').value = data.username || currentUser?.email || '';
            document.getElementById('userEmail').value = data.email || '';
            document.getElementById('userPhone').value = data.phone || '';
            document.getElementById('userAddress').value = data.address || '';
            document.getElementById('userRoleInput').value = data.role || 'Administrator';
            document.getElementById('userJoinDate').value = data.join_date ? moment(data.join_date).format('DD/MM/YYYY') : '-';
            document.getElementById('userBio').value = data.bio || '';
            
            // Load photo jika ada
            if (data.photo_url) {
                const img = document.getElementById('userPhotoImg');
                img.src = data.photo_url;
                img.style.display = 'block';
                document.getElementById('userInitials').style.display = 'none';
            }
        }
    } catch (error) {
        console.error("Error load user profile:", error);
    }
}

// Save user profile
async function saveUserProfile() {
    try {
        const userId = currentUser?.uid || 'admin';
        const data = {
            full_name: document.getElementById('userFullName').value.trim(),
            email: document.getElementById('userEmail').value.trim(),
            phone: document.getElementById('userPhone').value.trim(),
            address: document.getElementById('userAddress').value.trim(),
            bio: document.getElementById('userBio').value.trim(),
            updated_at: new Date().toISOString()
        };
        
        await db.collection('users').doc(userId).set(data, { merge: true });
        
        // Update current user data
        if (currentUser) {
            currentUser.full_name = data.full_name;
            localStorage.setItem('userName', data.full_name);
        }
        
        showToast('success', 'Berhasil', 'Profil disimpan');
        hideModal('modalUserProfile');
        
    } catch (error) {
        console.error("Error save user profile:", error);
        showToast('error', 'Error', 'Gagal menyimpan profil');
    }
}

// ============================================
// PAKET 14: GANTI PASSWORD
// ============================================

// Check password strength
function checkPasswordStrength(password) {
    let strength = 0;
    const tips = [];
    
    // Check length
    if (password.length >= 8) strength += 25;
    else tips.push("Minimal 8 karakter");
    
    // Check lowercase
    if (/[a-z]/.test(password)) strength += 25;
    else tips.push("Tambahkan huruf kecil");
    
    // Check uppercase
    if (/[A-Z]/.test(password)) strength += 25;
    else tips.push("Tambahkan huruf besar");
    
    // Check numbers
    if (/\d/.test(password)) strength += 25;
    else tips.push("Tambahkan angka");
    
    // Update UI
    const strengthBar = document.getElementById('passwordStrength');
    const tipsEl = document.getElementById('passwordTips');
    
    strengthBar.style.width = `${strength}%`;
    
    if (strength < 50) {
        strengthBar.style.backgroundColor = '#ff6b6b';
        tipsEl.textContent = tips.join(', ');
        tipsEl.style.color = '#ff6b6b';
    } else if (strength < 75) {
        strengthBar.style.backgroundColor = '#fdcb6e';
        tipsEl.textContent = 'Kuat';
        tipsEl.style.color = '#fdcb6b';
    } else {
        strengthBar.style.backgroundColor = '#00b894';
        tipsEl.textContent = 'Sangat Kuat';
        tipsEl.style.color = '#00b894';
    }
}

// Check password match
function checkPasswordMatch() {
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;
    const matchEl = document.getElementById('passwordMatch');
    const mismatchEl = document.getElementById('passwordMismatch');
    
    if (!newPass || !confirmPass) {
        matchEl.style.display = 'none';
        mismatchEl.style.display = 'none';
        return;
    }
    
    if (newPass === confirmPass) {
        matchEl.style.display = 'block';
        mismatchEl.style.display = 'none';
    } else {
        matchEl.style.display = 'none';
        mismatchEl.style.display = 'block';
    }
}

// Change password
async function changePassword() {
    try {
        const currentPass = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmPassword').value;
        
        // Validasi
        if (!currentPass || !newPass || !confirmPass) {
            showToast('error', 'Error', 'Semua field harus diisi');
            return;
        }
        
        if (newPass !== confirmPass) {
            showToast('error', 'Error', 'Password tidak cocok');
            return;
        }
        
        if (newPass.length < 8) {
            showToast('error', 'Error', 'Password minimal 8 karakter');
            return;
        }
        
        // Di production, update password di Firebase Auth
        if (currentUser) {
            // Firebase Auth password update
            await firebase.auth().currentUser.updatePassword(newPass);
        }
        
        showToast('success', 'Berhasil', 'Password berhasil diubah');
        hideModal('modalChangePassword');
        
        // Reset form
        document.getElementById('formChangePassword').reset();
        document.getElementById('passwordStrength').style.width = '0%';
        
    } catch (error) {
        console.error("Error change password:", error);
        
        if (error.code === 'auth/requires-recent-login') {
            showToast('error', 'Error', 'Silakan login ulang untuk mengganti password');
        } else {
            showToast('error', 'Error', 'Gagal mengubah password: ' + error.message);
        }
    }
}

// ============================================
// INITIALIZE ALL SETTINGS
// ============================================

// Initialize all settings modals
function initializeAllSettings() {
    console.log(" Initializing all settings...");
    
    // Buat modal-modal baru yang belum ada
    createUserManagementModal();
    createAPIIntegrationModal();
    createLogsAuditModal();
    createAboutAppModal();
    
    // Setup event listeners untuk semua modal
    setupModalEventListeners();
    
    console.log(" All settings initialized");
}

// Setup event listeners untuk modal
function setupModalEventListeners() {
    // Load data saat modal dibuka
    document.addEventListener('modalOpened', async function(e) {
        const modalId = e.detail.modalId;
        
        switch(modalId) {
            case 'modalCompanyProfile':
                await loadCompanyProfile();
                break;
            case 'modalBranding':
                await loadBranding();
                break;
            case 'modalContactSettings':
                await loadContactSettings();
                break;
            case 'modalMessageTemplates':
                await loadMessageTemplates();
                break;
            case 'modalFinancialSettings':
                await loadFinancialSettings();
                break;
            case 'modalSecuritySettings':
                await loadSecuritySettings();
                break;
            case 'modalBackupSettings':
                await loadBackupSettings();
                break;
            case 'modalSystemSettings':
                await loadSystemSettings();
                break;
            case 'modalUserManagement':
                await loadUserManagement();
                break;
            case 'modalLogsAudit':
                await loadAuditLogs();
                break;
            case 'modalUserProfile':
                await loadUserProfile();
                break;
        }
    });
    
    // Password strength checker
    document.getElementById('newPassword')?.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });
    
    document.getElementById('confirmPassword')?.addEventListener('input', checkPasswordMatch);
}

// Custom event untuk modal opened
function showModal(modalId) {
    const modalEl = document.getElementById(modalId);
    if (!modalEl) return;
    
    modalEl.classList.remove('hidden');
    modalEl.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Dispatch custom event
    const event = new CustomEvent('modalOpened', { detail: { modalId } });
    document.dispatchEvent(event);
}

// ============================================
// SETTING PAGE TEMPLATE
// ============================================

async function getSettingHTML() {
    return `
        <div class="page setting-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-cog"></i> Pengaturan Sistem</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="backupAllSettings()">
                        <i class="fas fa-save"></i> Backup All Settings
                    </button>
                </div>
            </div>
            
            <!-- QUICK SETTINGS -->
            <div class="quick-actions">
                <h3><i class="fas fa-bolt"></i> Quick Settings</h3>
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="showModal('modalBranding')">
                        <i class="fas fa-palette"></i> Ganti Tema
                    </button>
                    <button class="btn btn-warning" onclick="showModal('modalChangePassword')">
                        <i class="fas fa-key"></i> Ganti Password
                    </button>
                    <button class="btn btn-success" onclick="showModal('modalBackupSettings')">
                        <i class="fas fa-database"></i> Backup
                    </button>
                </div>
            </div>
            
            <!-- SETTING CATEGORIES -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                
                <!-- PROFIL PERUSAHAAN -->
                <div class="setting-card" onclick="showModal('modalCompanyProfile')">
                    <div class="setting-icon" style="background: var(--primary);">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Profil Perusahaan</h3>
                        <p>Kelola data perusahaan, alamat, kontak, dan informasi bisnis</p>
                        <div class="setting-badge">Wajib</div>
                    </div>
                </div>
                
                <!-- LOGO & BRANDING -->
                <div class="setting-card" onclick="showModal('modalBranding')">
                    <div class="setting-icon" style="background: var(--secondary);">
                        <i class="fas fa-palette"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logo & Branding</h3>
                        <p>Custom logo, warna tema, font, dan tampilan aplikasi</p>
                        <div class="setting-badge">UI/UX</div>
                    </div>
                </div>
                
                <!-- KONTAK & NOTIFIKASI -->
                <div class="setting-card" onclick="showModal('modalContactSettings')">
                    <div class="setting-icon" style="background: #25D366;">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Kontak & Notifikasi</h3>
                        <p>WhatsApp, Email, SMS, dan pengaturan notifikasi</p>
                        <div class="setting-badge">Komunikasi</div>
                    </div>
                </div>
                
                <!-- TEMPLATE PESAN -->
                <div class="setting-card" onclick="showModal('modalMessageTemplates')">
                    <div class="setting-icon" style="background: #a29bfe;">
                        <i class="fas fa-comment-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Template Pesan</h3>
                        <p>Custom template untuk reminder, invoice, dan notifikasi</p>
                        <div class="setting-badge">Marketing</div>
                    </div>
                </div>
                
                <!-- KEUANGAN & PAJAK -->
                <div class="setting-card" onclick="showModal('modalFinancialSettings')">
                    <div class="setting-icon" style="background: #00b894;">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keuangan & Pajak</h3>
                        <p>PPN, denda, metode pembayaran, dan laporan keuangan</p>
                        <div class="setting-badge">Financial</div>
                    </div>
                </div>
                
                <!-- KEAMANAN & AKSES -->
                <div class="setting-card" onclick="showModal('modalSecuritySettings')">
                    <div class="setting-icon" style="background: #ff6b6b;">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keamanan & Akses</h3>
                        <p>Password, user roles, audit log, dan pengamanan data</p>
                        <div class="setting-badge">Security</div>
                    </div>
                </div>
                
                <!-- BACKUP & RESTORE -->
                <div class="setting-card" onclick="showModal('modalBackupSettings')">
                    <div class="setting-icon" style="background: #54a0ff;">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Backup & Restore</h3>
                        <p>Auto-backup, restore data, dan management database</p>
                        <div class="setting-badge">Data</div>
                    </div>
                </div>
                
                <!-- SYSTEM SETTINGS -->
                <div class="setting-card" onclick="showModal('modalSystemSettings')">
                    <div class="setting-icon" style="background: #fdcb6e;">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="setting-content">
                        <h3>System Settings</h3>
                        <p>Timezone, bahasa, format tanggal, dan pengaturan sistem</p>
                        <div class="setting-badge">System</div>
                    </div>
                </div>
                
                <!-- USER MANAGEMENT -->
                <div class="setting-card" onclick="showModal('modalUserManagement')">
                    <div class="setting-icon" style="background: #fd79a8;">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="setting-content">
                        <h3>User Management</h3>
                        <p>Kelola user, permissions, roles, dan akses aplikasi</p>
                        <div class="setting-badge">Admin</div>
                    </div>
                </div>
                
                <!-- API & INTEGRATION -->
                <div class="setting-card" onclick="showModal('modalAPIIntegration')">
                    <div class="setting-icon" style="background: #6c5ce7;">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="setting-content">
                        <h3>API & Integration</h3>
                        <p>API keys, webhooks, dan integrasi dengan sistem lain</p>
                        <div class="setting-badge">Developer</div>
                    </div>
                </div>
                
                <!-- LOGS & AUDIT -->
                <div class="setting-card" onclick="showModal('modalLogsAudit')">
                    <div class="setting-icon" style="background: #636e72;">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logs & Audit</h3>
                        <p>Activity logs, audit trail, dan monitoring sistem</p>
                        <div class="setting-badge">Monitoring</div>
                    </div>
                </div>
                
                <!-- TENTANG APLIKASI -->
                <div class="setting-card" onclick="showModal('modalAboutApp')">
                    <div class="setting-icon" style="background: #0984e3;">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Tentang Aplikasi</h3>
                        <p>Versi, update, credits, dan informasi sistem</p>
                        <div class="setting-badge">Info</div>
                    </div>
                </div>
                
                <!-- PROFIL USER -->
                <div class="setting-card" onclick="showModal('modalUserProfile')">
                    <div class="setting-icon" style="background: #e84393;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Profil Saya</h3>
                        <p>Data pribadi, foto profil, signature</p>
                        <div class="setting-badge">Personal</div>
                    </div>
                </div>
                
                <!-- GANTI PASSWORD -->
                <div class="setting-card" onclick="showModal('modalChangePassword')">
                    <div class="setting-icon" style="background: #e17055;">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Ganti Password</h3>
                        <p>Ubah password akun administrator</p>
                        <div class="setting-badge">Security</div>
                    </div>
                </div>
                
            </div>
            
            <!-- SYSTEM STATUS -->
            <div class="card" style="margin-top: 30px;">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> System Status</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="status-item">
                            <div class="status-label">Versi Aplikasi</div>
                            <div class="status-value">X-BILL v2.1.0</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Total Settings</div>
                            <div class="status-value" id="totalSettingsCount">0 tersimpan</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Backup Terakhir</div>
                            <div class="status-value" id="lastBackupStatus">-</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">System Uptime</div>
                            <div class="status-value" id="systemUptime">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Backup all settings
async function backupAllSettings() {
    try {
        showToast('info', 'Backup', 'Membackup semua pengaturan...');
        
        const collections = ['settings', 'users'];
        const backupData = {};
        
        for (const collection of collections) {
            const snapshot = await db.collection(collection).get();
            backupData[collection] = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        }
        
        // Buat file backup
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Download
        const link = document.createElement('a');
        link.href = url;
        link.download = `settings_backup_${moment().format('YYYYMMDD_HHmmss')}.json`;
        link.click();
        
        showToast('success', 'Backup Selesai', 'Semua pengaturan telah dibackup');
        
    } catch (error) {
        console.error("Error backup settings:", error);
        showToast('error', 'Error', 'Gagal membuat backup');
    }
}

// ============================================
// INITIALIZE ON APP START - FIXED VERSION
// ============================================

// Fungsi untuk initialize setelah DOM siap
function initializeApp() {
    console.log(" Initializing X-BILL Application...");
    
    // 1. Setup navigation event listeners
    setupNavigation();
    
    // 2. Initialize all settings features
    initializeAllSettings();
    
    // 3. Load default page (dashboard)
    loadDefaultPage();
    
    // 4. Setup auto-generate tagihan
    setupAutoGenerate();
    
    console.log(" Application initialized successfully");
}

// Setup navigation event listeners
function setupNavigation() {
    console.log(" Setting up navigation...");
    
    // Setup untuk semua nav items
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        const page = item.getAttribute('data-page');
        if (page) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                console.log(` Navigating to: ${page}`);
                loadPage(page);
            });
        }
    });
    
    // Khusus untuk setting nav (pastikan ada)
    const settingNav = document.querySelector('[data-page="setting"]');
    if (settingNav) {
        settingNav.addEventListener('click', function(e) {
            e.preventDefault();
            loadPage('setting');
           
        });
        console.log(" Setting navigation ready");
    }
}

// Load default page
function loadDefaultPage() {
    // Cek URL hash
    const hash = window.location.hash.replace('#', '');
    const validPages = ['dashboard', 'pelanggan', 'paket', 'tagihan', 'tunggakan', 'setting', 'laporan'];
    
    if (hash && validPages.includes(hash)) {
        console.log(` Loading from URL hash: ${hash}`);
        loadPage(hash);
    } else {
        console.log(" Loading default page: dashboard");
        loadPage('dashboard');
    }
}

// Setup auto-generate tagihan
function setupAutoGenerate() {
    // Cek auto-generate setiap hari jam 8 pagi
    const now = new Date();
    const next8AM = new Date();
    next8AM.setHours(8, 0, 0, 0);
    
    if (now > next8AM) {
        next8AM.setDate(next8AM.getDate() + 1);
    }
    
    const timeUntil8AM = next8AM.getTime() - now.getTime();
    
    setTimeout(() => {
        autoGenerateTagihanArrears();
        // Set interval harian
        setInterval(autoGenerateTagihanArrears, 24 * 60 * 60 * 1000);
    }, timeUntil8AM);
}

// Pastikan fungsi loadPage ada (fallback)
if (typeof loadPage === 'undefined') {
    async function loadPage(page) {
        console.log(` Loading page: ${page}`);
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-page') === page) {
                item.classList.add('active');
            }
        });
        
        // Set current page
        currentPage = page;
        
        // Load page content
        const mainContent = document.getElementById('mainContent');
        if (!mainContent) {
            console.error(" Main content element not found!");
            return;
        }
        
        // Show loading
        mainContent.innerHTML = `
            <div class="page">
                <div style="padding: 50px; text-align: center;">
                    <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
                    <h3>Memuat halaman...</h3>
                </div>
            </div>
        `;
        
        try {
            let html = '';
            
            switch(page) {
                case 'dashboard':
                    html = await getDashboardHTML();
                    break;
                case 'pelanggan':
                    html = await getPelangganHTML();
                    break;
                case 'paket':
                    html = await getPaketHTML();
                    break;
                case 'tagihan':
                    html = await getTagihanHTML();
                    break;
                case 'tunggakan':
                    html = await getTunggakanHTML();
                    break;
                case 'setting':
                    html = await getSettingHTML();
                    break;
                case 'laporan':
                    html = await getLaporanHTML();
                    break;
                default:
                    html = await getDashboardHTML();
            }
            
            mainContent.innerHTML = html;
            
            // Load data setelah halaman dirender
            setTimeout(() => {
                loadPageData(page);
            }, 100);
            
        } catch (error) {
            console.error(` Error loading page ${page}:`, error);
            showToast('error', 'Error', `Gagal memuat halaman ${page}`);
            
            mainContent.innerHTML = `
                <div class="page">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ff6b6b; margin-bottom: 20px;"></i>
                            <h3>Gagal Memuat Halaman</h3>
                            <p>${error.message}</p>
                            <button class="btn btn-primary mt-3" onclick="loadPage('dashboard')">
                                <i class="fas fa-home"></i> Kembali ke Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    }
}

// Load data untuk masing-masing halaman
function loadPageData(page) {
    switch(page) {
        case 'dashboard':
            renderDashboard();
            break;
        case 'pelanggan':
            loadPelangganData();
            break;
        case 'paket':
            loadPaketData();
            break;
        case 'tagihan':
            loadTagihanData();
            break;
        case 'tunggakan':
            loadTunggakanData();
            break;
        case 'setting':
            loadSystemStatus();
            break;
        case 'laporan':
            generateLaporan();
            break;
    }
}

// Load system status untuk halaman setting
async function loadSystemStatus() {
    try {
        // Tunggu element tersedia
        await waitForElement('#totalSettingsCount', 3000);
        
        // Hitung total settings
        const snapshot = await db.collection('settings').get();
        const countElement = document.getElementById('totalSettingsCount');
        if (countElement) {
            countElement.textContent = `${snapshot.size} tersimpan`;
        }
        
        // Load last backup status
        const backupSnapshot = await db.collection('backup_history')
            .orderBy('created_at', 'desc')
            .limit(1)
            .get();
        
        const lastBackupElement = document.getElementById('lastBackupStatus');
        if (lastBackupElement && !backupSnapshot.empty) {
            const lastBackup = backupSnapshot.docs[0].data();
            const timeAgo = moment(lastBackup.created_at).fromNow();
            lastBackupElement.textContent = timeAgo;
        }
        
        // System uptime
        const uptimeElement = document.getElementById('systemUptime');
        if (uptimeElement) {
            const uptime = moment.duration(15, 'days').humanize();
            uptimeElement.textContent = uptime;
        }
        
    } catch (error) {
        console.error("Error load system status:", error);
    }
}

// Helper: Tunggu element tersedia
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const startTime = Date.now();
        
        function check() {
            const element = document.querySelector(selector);
            if (element) {
                resolve(element);
            } else if (Date.now() - startTime >= timeout) {
                reject(new Error(`Element ${selector} not found after ${timeout}ms`));
            } else {
                setTimeout(check, 100);
            }
        }
        
        check();
    });
}



// ============================================
// FUNGSI PEMBAYARAN TAGIHAN (REVISI)
// ============================================

// Data global untuk pembayaran
let bayarData = {
    pelangganId: null,
    tagihanList: [],
    selectedTagihan: []
};

// Buka modal bayar tagihan
async function bayarTagihan(tagihanId) {
    try {
        // Reset data
        bayarData = {
            pelangganId: null,
            tagihanList: [],
            selectedTagihan: []
        };
        
        // Load data tagihan utama
        const tagihanDoc = await db.collection('tagihan').doc(tagihanId).get();
        if (!tagihanDoc.exists) {
            showToast('error', 'Error', 'Data tagihan tidak ditemukan');
            return;
        }
        
        const tagihanData = tagihanDoc.data();
        bayarData.pelangganId = tagihanData.pelanggan_id;
        
        // Load data pelanggan
        const pelangganDoc = await db.collection('pelanggan').doc(tagihanData.pelanggan_id).get();
        if (pelangganDoc.exists) {
            const pelanggan = pelangganDoc.data();
            document.getElementById('bayarPelangganNama').textContent = pelanggan.nama || '-';
            document.getElementById('bayarPelangganTelepon').textContent = pelanggan.telepon || '-';
            document.getElementById('bayarPelangganPaket').textContent = pelanggan.paket || '-';
            document.getElementById('bayarPelangganAlamat').textContent = pelanggan.alamat || '-';
        }
        
        // Load SEMUA tagihan pelanggan ini (termasuk tunggakan)
        await loadAllTagihanPelanggan(tagihanData.pelanggan_id);
        
        // Set modal tanggal ke hari ini
        document.getElementById('tanggalBayar').value = new Date().toISOString().split('T')[0];
        
        // Reset form
        document.getElementById('referensiBayar').value = '';
        document.getElementById('catatanBayar').value = '';
        document.getElementById('metodeBayar').value = '';
        document.getElementById('fileBuktiBayar').value = '';
        document.getElementById('previewBuktiBayar').innerHTML = '';
        document.getElementById('jumlahBayarSebagian').value = '';
        
        // Reset mode bayar
        document.getElementById('modePenuh').checked = true;
        document.getElementById('inputSebagian').style.display = 'none';
        
        // Tampilkan modal
        showModal('modalBayarTagihan');
        
    } catch (error) {
        console.error("Error opening payment modal:", error);
        showToast('error', 'Error', 'Gagal memuat data pembayaran');
    }
}

// Load semua tagihan pelanggan
async function loadAllTagihanPelanggan(pelangganId) {
    try {
        const snapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .where('status', 'in', ['belum', 'telat'])  // Hanya yang belum lunas
            .orderBy('bulan', 'desc')
            .get();
        
        bayarData.tagihanList = [];
        
        if (snapshot.empty) {
            document.getElementById('listTagihanBayar').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">Tidak ada tagihan tertunggak</td>
                </tr>
            `;
            return;
        }
        
        let totalTagihan = 0;
        let totalDenda = 0;
        let html = '';
        
        snapshot.docs.forEach((doc, index) => {
            const tagihan = doc.data();
            const tagihanId = doc.id;
            
            // Hitung denda jika telat
            let denda = 0;
            let hariTelat = 0;
            
            if (tagihan.status === 'telat' && tagihan.tanggal_jatuh_tempo) {
                const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
                hariTelat = moment().diff(jatuhTempo, 'days');
                denda = hitungDenda(tagihan.jumlah, hariTelat);
            }
            
            const total = Number(tagihan.jumlah) + denda;
            totalTagihan += Number(tagihan.jumlah);
            totalDenda += denda;
            
            // Simpan ke data list
            bayarData.tagihanList.push({
                id: tagihanId,
                invoice: tagihan.id || `INV-${index + 1}`,
                bulan: tagihan.bulan,
                jumlah: Number(tagihan.jumlah),
                status: tagihan.status,
                denda: denda,
                total: total,
                hari_telat: hariTelat
            });
            
            // Generate row HTML
            html += `
                <tr>
                    <td>
                        <input type="checkbox" class="tagihan-check" 
                               value="${tagihanId}" 
                               data-jumlah="${total}"
                               onchange="updateSelectedTagihan()"
                               ${index === 0 ? 'checked' : ''}>
                    </td>
                    <td><small>${tagihan.id || tagihanId.substring(0, 8)}</small></td>
                    <td>${tagihan.bulan}</td>
                    <td>${formatRupiah(tagihan.jumlah)}</td>
                    <td>
                        <span class="badge ${tagihan.status === 'telat' ? 'badge-danger' : 'badge-warning'}">
                            ${tagihan.status === 'telat' ? 'TELAT' : 'BELUM'}
                            ${hariTelat > 0 ? ` (${hariTelat}hr)` : ''}
                        </span>
                    </td>
                    <td>${denda > 0 ? formatRupiah(denda) : '-'}</td>
                    <td><strong>${formatRupiah(total)}</strong></td>
                </tr>
            `;
        });
        
        document.getElementById('listTagihanBayar').innerHTML = html;
        
        // Update summary
        document.getElementById('summaryTotalTagihan').textContent = formatRupiah(totalTagihan);
        document.getElementById('summaryTotalDenda').textContent = formatRupiah(totalDenda);
        
        // Auto select pertama
        updateSelectedTagihan();
        
    } catch (error) {
        console.error("Error loading customer invoices:", error);
        showToast('error', 'Error', 'Gagal memuat data tagihan');
    }
}

// Hitung denda
function hitungDenda(jumlah, hariTelat) {
    if (hariTelat <= 0) return 0;
    
    const dendaPerHari = 0.5; // 0.5% per hari
    const maxDenda = 10; // Maksimal 10%
    
    let dendaPersen = Math.min(hariTelat * dendaPerHari, maxDenda);
    return Math.round((jumlah * dendaPersen) / 100);
}

// Update tagihan yang dipilih
function updateSelectedTagihan() {
    const checkboxes = document.querySelectorAll('.tagihan-check:checked');
    bayarData.selectedTagihan = [];
    let total = 0;
    let count = 0;
    
    checkboxes.forEach(checkbox => {
        const tagihanId = checkbox.value;
        const jumlah = parseFloat(checkbox.getAttribute('data-jumlah'));
        
        // Cari data lengkap tagihan
        const tagihanData = bayarData.tagihanList.find(t => t.id === tagihanId);
        if (tagihanData) {
            bayarData.selectedTagihan.push(tagihanData);
            total += tagihanData.total;
            count++;
        }
    });
    
    // Update display
    document.getElementById('summaryJumlahTerpilih').textContent = `${count} tagihan`;
    document.getElementById('totalTerpilih').textContent = formatRupiah(total);
    document.getElementById('totalHarusBayar').textContent = formatRupiah(total);
    
    // Update input sebagian
    const inputSebagian = document.getElementById('jumlahBayarSebagian');
    if (inputSebagian.value) {
        updateSisaPembayaran();
    }
}

// Toggle check all
function toggleCheckAll() {
    const checkAll = document.getElementById('checkAll');
    const checkboxes = document.querySelectorAll('.tagihan-check');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = checkAll.checked;
    });
    
    updateSelectedTagihan();
}

// Pilih semua tagihan
function checkAllTagihan() {
    const checkboxes = document.querySelectorAll('.tagihan-check');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    
    document.getElementById('checkAll').checked = true;
    updateSelectedTagihan();
}

// Update mode bayar
function updateModeBayar() {
    const modePenuh = document.getElementById('modePenuh').checked;
    const inputSebagian = document.getElementById('inputSebagian');
    
    if (modePenuh) {
        inputSebagian.style.display = 'none';
    } else {
        inputSebagian.style.display = 'block';
        // Set default value = total terpilih
        const total = bayarData.selectedTagihan.reduce((sum, t) => sum + t.total, 0);
        document.getElementById('jumlahBayarSebagian').value = total;
        updateSisaPembayaran();
    }
}

// Update sisa pembayaran
function updateSisaPembayaran() {
    const jumlahBayar = parseFloat(document.getElementById('jumlahBayarSebagian').value) || 0;
    const totalHarusBayar = bayarData.selectedTagihan.reduce((sum, t) => sum + t.total, 0);
    
    const sisa = totalHarusBayar - jumlahBayar;
    const kekurangan = sisa > 0 ? sisa : 0;
    const kelebihan = sisa < 0 ? Math.abs(sisa) : 0;
    
    document.getElementById('sisaPembayaran').textContent = formatRupiah(Math.max(0, sisa));
    document.getElementById('kekuranganPembayaran').textContent = formatRupiah(kekurangan);
    
    // Update status
    const statusElement = document.getElementById('statusPembayaran');
    if (jumlahBayar >= totalHarusBayar) {
        statusElement.textContent = 'LUNAS';
        statusElement.style.color = '#00b894';
        statusElement.style.fontWeight = 'bold';
    } else if (jumlahBayar > 0) {
        statusElement.textContent = 'SEBAGIAN';
        statusElement.style.color = '#fdcb6e';
        statusElement.style.fontWeight = 'bold';
    } else {
        statusElement.textContent = 'BELUM BAYAR';
        statusElement.style.color = '#ff6b6b';
    }
}

// Toggle bukti transfer
function toggleBuktiTransfer() {
    const metode = document.getElementById('metodeBayar').value;
    const buktiSection = document.getElementById('buktiTransferSection');
    
    if (metode === 'transfer' || metode === 'qris' || metode === 'gopay' || metode === 'ovo' || metode === 'dana') {
        buktiSection.style.display = 'block';
    } else {
        buktiSection.style.display = 'none';
    }
}

// Preview bukti transfer
function previewBuktiBayar(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const preview = document.getElementById('previewBuktiBayar');
            
            if (file.type.startsWith('image/')) {
                preview.innerHTML = `
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 5px;">
                        <p style="margin-top: 5px; font-size: 12px;">
                            <i class="fas fa-file-image"></i> ${file.name} (${formatFileSize(file.size)})
                        </p>
                    </div>
                `;
            } else if (file.type === 'application/pdf') {
                preview.innerHTML = `
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <i class="fas fa-file-pdf" style="font-size: 48px; color: #ff6b6b;"></i>
                        <p style="margin-top: 5px; font-size: 12px;">
                            <i class="fas fa-file-pdf"></i> ${file.name} (${formatFileSize(file.size)})
                        </p>
                    </div>
                `;
            }
        };
        
        reader.readAsDataURL(file);
    }
}

// Proses pembayaran
async function prosesPembayaran(action) {
    try {
        // Validasi
        if (bayarData.selectedTagihan.length === 0) {
            showToast('error', 'Error', 'Pilih minimal 1 tagihan');
            return;
        }
        
        const metodeBayar = document.getElementById('metodeBayar').value;
        const tanggalBayar = document.getElementById('tanggalBayar').value;
        
        if (!metodeBayar) {
            showToast('error', 'Error', 'Pilih metode pembayaran');
            return;
        }
        
        if (!tanggalBayar) {
            showToast('error', 'Error', 'Pilih tanggal bayar');
            return;
        }
        
        // Hitung total
        const modePenuh = document.getElementById('modePenuh').checked;
        let jumlahBayar;
        
        if (modePenuh) {
            // Bayar penuh semua yang dipilih
            jumlahBayar = bayarData.selectedTagihan.reduce((sum, t) => sum + t.total, 0);
        } else {
            // Bayar sebagian
            jumlahBayar = parseFloat(document.getElementById('jumlahBayarSebagian').value) || 0;
            if (jumlahBayar <= 0) {
                showToast('error', 'Error', 'Masukkan jumlah pembayaran');
                return;
            }
        }
        
        // Upload bukti jika ada
        let buktiUrl = '';
        const fileInput = document.getElementById('fileBuktiBayar');
        
        if (fileInput.files.length > 0) {
            showToast('info', 'Upload', 'Mengupload bukti pembayaran...');
            
            // Di production, upload ke Firebase Storage
            const file = fileInput.files[0];
            const fileName = `bukti_${Date.now()}_${file.name}`;
            
            // Simpan sebagai data URL untuk sementara
            const reader = new FileReader();
            reader.onload = function(e) {
                buktiUrl = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Data pembayaran
        const pembayaranData = {
            pelanggan_id: bayarData.pelangganId,
            tagihan_ids: bayarData.selectedTagihan.map(t => t.id),
            jumlah_bayar: jumlahBayar,
            metode_bayar: metodeBayar,
            tanggal_bayar: tanggalBayar,
            referensi: document.getElementById('referensiBayar').value.trim(),
            catatan: document.getElementById('catatanBayar').value.trim(),
            bukti_url: buktiUrl,
            status: 'pending',
            created_at: new Date().toISOString(),
            created_by: currentUser?.email || 'admin'
        };
        
        // Simpan ke database
        const paymentRef = await db.collection('pembayaran').add(pembayaranData);
        
        // Update status tagihan
        const batch = db.batch();
        
        bayarData.selectedTagihan.forEach(tagihan => {
            const tagihanRef = db.collection('tagihan').doc(tagihan.id);
            
            // Jika bayar penuh, update jadi lunas
            if (modePenuh) {
                batch.update(tagihanRef, {
                    status: 'lunas',
                    tanggal_bayar: tanggalBayar,
                    pembayaran_id: paymentRef.id,
                    updated_at: new Date().toISOString()
                });
            } else {
                // Jika bayar sebagian, hitung sisa
                // (Implementasi lebih kompleks untuk bagi pembayaran)
                batch.update(tagihanRef, {
                    status: 'sebagian',
                    tanggal_bayar: tanggalBayar,
                    pembayaran_id: paymentRef.id,
                    updated_at: new Date().toISOString()
                });
            }
        });
        
        await batch.commit();
        
        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Pembayaran tagihan: ${bayarData.selectedTagihan.length} tagihan, Rp ${formatRupiah(jumlahBayar)}`,
            user: currentUser?.email || 'admin',
            timestamp: new Date().toISOString()
        });
        
        // Tampilkan konfirmasi
        showToast('success', 'Berhasil', `Pembayaran ${formatRupiah(jumlahBayar)} berhasil`);
        
        // Tutup modal
        hideModal('modalBayarTagihan');
        
        // Refresh data tagihan
        if (currentPage === 'tagihan') {
            loadTagihanData();
        }
        
        // Jika pilih cetak
        if (action === 'cetak') {
            setTimeout(() => {
                cetakKwitansi(paymentRef.id);
            }, 500);
        }
        
    } catch (error) {
        console.error("Error proses pembayaran:", error);
        showToast('error', 'Error', 'Gagal memproses pembayaran: ' + error.message);
    }
}

// Cetak kwitansi
async function cetakKwitansi(paymentId) {
    try {
        const paymentDoc = await db.collection('pembayaran').doc(paymentId).get();
        if (!paymentDoc.exists) {
            showToast('error', 'Error', 'Data pembayaran tidak ditemukan');
            return;
        }
        
        const payment = paymentDoc.data();
        
        // Load data pelanggan
        const pelangganDoc = await db.collection('pelanggan').doc(payment.pelanggan_id).get();
        const pelanggan = pelangganDoc.exists ? pelangganDoc.data() : {};
        
        // Load data tagihan
        const tagihanDocs = await Promise.all(
            payment.tagihan_ids.map(id => db.collection('tagihan').doc(id).get())
        );
        
        const tagihanList = tagihanDocs
            .filter(doc => doc.exists)
            .map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Buat window untuk cetak
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Kwitansi Pembayaran</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .company-name { font-size: 24px; font-weight: bold; }
                    .receipt-title { font-size: 20px; margin: 20px 0; text-align: center; }
                    .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .info-table td { padding: 8px; border-bottom: 1px solid #ddd; }
                    .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .items-table th, .items-table td { 
                        padding: 10px; 
                        border: 1px solid #ddd;
                        text-align: left;
                    }
                    .items-table th { background: #f5f5f5; }
                    .total-section { 
                        margin-top: 30px; 
                        padding: 20px; 
                        background: #f8f9fa; 
                        border-radius: 5px;
                    }
                    .footer { 
                        margin-top: 50px; 
                        text-align: center; 
                        color: #666;
                        font-size: 12px;
                    }
                    @media print {
                        body { margin: 0; }
                        .no-print { display: none; }
                        button { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="company-name">X-BILL ISP</div>
                    <div>Kwitansi Pembayaran Tagihan Internet</div>
                </div>
                
                <table class="info-table">
                    <tr>
                        <td width="30%"><strong>No. Kwitansi</strong></td>
                        <td>${paymentId.substring(0, 12).toUpperCase()}</td>
                    </tr>
                    <tr>
                        <td><strong>Tanggal</strong></td>
                        <td>${moment(payment.tanggal_bayar).format('DD/MM/YYYY')}</td>
                    </tr>
                    <tr>
                        <td><strong>Pelanggan</strong></td>
                        <td>${pelanggan.nama || '-'}</td>
                    </tr>
                    <tr>
                        <td><strong>Telepon</strong></td>
                        <td>${pelanggan.telepon || '-'}</td>
                    </tr>
                    <tr>
                        <td><strong>Metode Bayar</strong></td>
                        <td>${payment.metode_bayar.toUpperCase()}</td>
                    </tr>
                    <tr>
                        <td><strong>No. Referensi</strong></td>
                        <td>${payment.referensi || '-'}</td>
                    </tr>
                </table>
                
                <div class="receipt-title">RINCIAN TAGIHAN</div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Bulan</th>
                            <th>Invoice</th>
                            <th>Jumlah</th>
                            <th>Denda</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tagihanList.map(tagihan => `
                            <tr>
                                <td>${tagihan.bulan || '-'}</td>
                                <td>${tagihan.id || '-'}</td>
                                <td>${formatRupiah(tagihan.jumlah)}</td>
                                <td>${tagihan.denda ? formatRupiah(tagihan.denda) : '-'}</td>
                                <td>${formatRupiah(Number(tagihan.jumlah) + (tagihan.denda || 0))}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="total-section">
                    <div style="font-size: 18px; font-weight: bold; text-align: right;">
                        TOTAL PEMBAYARAN: ${formatRupiah(payment.jumlah_bayar)}
                    </div>
                    <div style="margin-top: 10px; color: #666; text-align: right;">
                        Terbilang: ${terbilang(payment.jumlah_bayar)} rupiah
                    </div>
                </div>
                
                <div class="footer">
                    <p>Kwitansi ini sah sebagai bukti pembayaran yang telah dilakukan</p>
                    <p>Terima kasih telah melakukan pembayaran tepat waktu</p>
                    <p style="margin-top: 40px;">
                        <strong>TTD</strong><br>
                        _________________<br>
                        Admin X-BILL
                    </p>
                </div>
                
                <div class="no-print" style="margin-top: 30px; text-align: center;">
                    <button onclick="window.print()" style="padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-print"></i> Cetak Kwitansi
                    </button>
                    <button onclick="window.close()" style="padding: 10px 20px; margin-left: 10px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Tutup
                    </button>
                </div>
                
                <script>
                    function formatRupiah(angka) {
                        return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    }
                    
                    function terbilang(angka) {
                        // Fungsi terbilang sederhana
                        const bilangan = ['', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan', 'Sepuluh', 'Sebelas'];
                        if (angka < 12) return bilangan[angka];
                        if (angka < 20) return terbilang(angka - 10) + ' Belas';
                        if (angka < 100) return terbilang(Math.floor(angka / 10)) + ' Puluh ' + terbilang(angka % 10);
                        if (angka < 200) return 'Seratus ' + terbilang(angka - 100);
                        if (angka < 1000) return terbilang(Math.floor(angka / 100)) + ' Ratus ' + terbilang(angka % 100);
                        if (angka < 2000) return 'Seribu ' + terbilang(angka - 1000);
                        if (angka < 1000000) return terbilang(Math.floor(angka / 1000)) + ' Ribu ' + terbilang(angka % 1000);
                        return 'Jumlah terlalu besar';
                    }
                
        `);
        
        printWindow.document.close();
        
    } catch (error) {
        console.error("Error cetak kwitansi:", error);
        showToast('error', 'Error', 'Gagal mencetak kwitansi');
    }
}

// ============================================
// FUNGSI DETAIL TAGIHAN
// ============================================

// Tampilkan detail tagihan
async function showTagihanDetail(tagihanId) {
    try {
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data tagihan tidak ditemukan');
            return;
        }
        
        const tagihan = doc.data();
        
        // Load data pelanggan
        const pelangganDoc = await db.collection('pelanggan').doc(tagihan.pelanggan_id).get();
        const pelanggan = pelangganDoc.exists ? pelangganDoc.data() : {};
        
        // Buat modal detail
        const modalId = 'modalDetailTagihan';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            // Buat modal baru
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal-overlay hidden';
            modal.innerHTML = `
                <div class="modal modal-lg">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-receipt"></i> Detail Tagihan</h3>
                        <button class="modal-close" onclick="hideModal('${modalId}')">&times;</button>
                    </div>
                    <div class="modal-body" id="detailTagihanContent">
                        <!-- Content akan diisi -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="hideModal('${modalId}')">Tutup</button>
                        <button class="btn btn-primary" onclick="cetakInvoiceDetail('${tagihanId}')">
                            <i class="fas fa-print"></i> Cetak Invoice
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Isi content
        const content = document.getElementById('detailTagihanContent');
        content.innerHTML = `
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-user"></i> Data Pelanggan</h5>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>Nama:</strong> ${pelanggan.nama || '-'}</p>
                            <p><strong>Telepon:</strong> ${pelanggan.telepon || '-'}</p>
                            <p><strong>Email:</strong> ${pelanggan.email || '-'}</p>
                        </div>
                        <div>
                            <p><strong>Paket:</strong> ${pelanggan.paket || '-'}</p>
                            <p><strong>Alamat:</strong> ${pelanggan.alamat || '-'}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge ${pelanggan.status === 'aktif' ? 'badge-success' : 'badge-warning'}">
                                    ${pelanggan.status || 'nonaktif'}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-file-invoice"></i> Detail Tagihan</h5>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>Invoice:</strong> ${tagihan.id || tagihanId.substring(0, 12)}</p>
                            <p><strong>Bulan:</strong> ${tagihan.bulan || '-'}</p>
                            <p><strong>Jumlah Tagihan:</strong> ${formatRupiah(tagihan.jumlah)}</p>
                            <p><strong>Denda:</strong> ${tagihan.denda ? formatRupiah(tagihan.denda) : 'Rp 0'}</p>
                        </div>
                        <div>
                            <p><strong>Tanggal Invoice:</strong> ${tagihan.tanggal_invoice ? moment(tagihan.tanggal_invoice).format('DD/MM/YYYY') : '-'}</p>
                            <p><strong>Jatuh Tempo:</strong> ${tagihan.tanggal_jatuh_tempo ? moment(tagihan.tanggal_jatuh_tempo).format('DD/MM/YYYY') : '-'}</p>
                            <p><strong>Tanggal Bayar:</strong> ${tagihan.tanggal_bayar ? moment(tagihan.tanggal_bayar).format('DD/MM/YYYY') : 'Belum bayar'}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge ${tagihan.status === 'lunas' ? 'badge-success' : tagihan.status === 'telat' ? 'badge-danger' : 'badge-warning'}">
                                    ${tagihan.status === 'lunas' ? 'LUNAS' : tagihan.status === 'telat' ? 'TELAT BAYAR' : 'BELUM BAYAR'}
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    ${tagihan.catatan ? `
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>Catatan:</strong> ${tagihan.catatan}
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Riwayat Pembayaran</h5>
                </div>
                <div class="card-body">
                    <div id="riwayatPembayaran">
                        Memuat riwayat pembayaran...
                    </div>
                </div>
            </div>
        `;
        
        // Load riwayat pembayaran
        await loadRiwayatPembayaran(tagihanId);
        
        // Tampilkan modal
        showModal(modalId);
        
    } catch (error) {
        console.error("Error show tagihan detail:", error);
        showToast('error', 'Error', 'Gagal memuat detail tagihan');
    }
}

// Load riwayat pembayaran (VERSION FIX - tanpa composite index)
async function loadRiwayatPembayaran(tagihanId) {
    try {
        // Query alternatif tanpa composite index
        const snapshot = await db.collection('pembayaran')
            .where('tagihan_ids', 'array-contains', tagihanId)
            .get();
        
        const container = document.getElementById('riwayatPembayaran');
        
        if (snapshot.empty) {
            container.innerHTML = '<p class="text-muted">Belum ada riwayat pembayaran</p>';
            return;
        }
        
        // Sort manual di client side
        const payments = [];
        snapshot.forEach(doc => {
            payments.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        // Sort by tanggal bayar descending
        payments.sort((a, b) => 
            new Date(b.tanggal_bayar) - new Date(a.tanggal_bayar)
        );
        
        let html = '<table class="table" style="font-size: 14px;">';
        html += `
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Jumlah</th>
                    <th>Metode</th>
                    <th>Referensi</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        payments.forEach(payment => {
            html += `
                <tr>
                    <td>${moment(payment.tanggal_bayar).format('DD/MM/YY')}</td>
                    <td>${formatRupiah(payment.jumlah_bayar)}</td>
                    <td><span class="badge badge-primary">${payment.metode_bayar}</span></td>
                    <td>${payment.referensi || '-'}</td>
                    <td><span class="badge badge-success">SUCCESS</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error("Error load riwayat pembayaran:", error);
        document.getElementById('riwayatPembayaran').innerHTML = 
            '<p class="text-danger">Error memuat riwayat: ' + error.message + '</p>';
        
        // Fallback: Tampilkan pesan tanpa table
        if (error.message.includes('index')) {
            document.getElementById('riwayatPembayaran').innerHTML = 
                '<p class="text-warning"><i class="fas fa-info-circle"></i> Riwayat pembayaran tidak dapat ditampilkan. Silakan buat index di Firebase Console.</p>';
        }
    }
}

// ============================================
// FUNGSI WHATSAPP REMINDER
// ============================================

// Kirim reminder via WhatsApp
async function sendWhatsAppReminder(tagihanId) {
    try {
        showToast('info', 'Reminder', 'Menyiapkan pesan WhatsApp...');
        
        // Load data tagihan
        const tagihanDoc = await db.collection('tagihan').doc(tagihanId).get();
        if (!tagihanDoc.exists) {
            showToast('error', 'Error', 'Data tagihan tidak ditemukan');
            return;
        }
        
        const tagihan = tagihanDoc.data();
        
        // Load data pelanggan
        const pelangganDoc = await db.collection('pelanggan').doc(tagihan.pelanggan_id).get();
        if (!pelangganDoc.exists) {
            showToast('error', 'Error', 'Data pelanggan tidak ditemukan');
            return;
        }
        
        const pelanggan = pelangganDoc.data();
        
        // Cek apakah ada nomor WhatsApp
        if (!pelanggan.telepon) {
            showToast('error', 'Error', 'Pelanggan tidak memiliki nomor telepon');
            return;
        }
        
        // Load template pesan dari settings
        const templateDoc = await db.collection('settings').doc('templates').get();
        const templates = templateDoc.exists ? templateDoc.data() : {};
        
        // Pilih template berdasarkan status
        let template = '';
        if (tagihan.status === 'telat') {
            template = templates.reminder_overdue || templates.templateOverdue || '';
        } else {
            // Hitung hari menuju jatuh tempo
            const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
            const hariMenuju = jatuhTempo.diff(moment(), 'days');
            
            if (hariMenuju <= 1) {
                template = templates.reminder_1day || templates.templateReminder1Day || '';
            } else if (hariMenuju <= 3) {
                template = templates.reminder_3days || templates.templateReminder3Days || '';
            } else {
                template = templates.templateNewInvoice || '';
            }
        }
        
        // Jika tidak ada template, buat default
        if (!template) {
            template = `Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] jatuh tempo pada [jatuh_tempo].

Silakan lakukan pembayaran sebelum jatuh tempo.

Terima kasih.
[nama_perusahaan]`;
        }
        
        // Replace variables
        let message = template
            .replace(/\[nama_pelanggan\]/g, pelanggan.nama || 'Pelanggan')
            .replace(/\[bulan_tagihan\]/g, tagihan.bulan || '-')
            .replace(/\[jumlah_tagihan\]/g, formatRupiah(tagihan.jumlah))
            .replace(/\[jatuh_tempo\]/g, tagihan.tanggal_jatuh_tempo ? moment(tagihan.tanggal_jatuh_tempo).format('DD/MM/YYYY') : '-')
            .replace(/\[invoice_number\]/g, tagihan.id || tagihanId.substring(0, 12))
            .replace(/\[nama_perusahaan\]/g, 'X-BILL ISP');
        
        // Tambahkan info tunggakan jika ada
        if (tagihan.status === 'telat') {
            const hariTelat = tagihan.tanggal_jatuh_tempo ? 
                moment().diff(moment(tagihan.tanggal_jatuh_tempo), 'days') : 0;
            
            message += `\n\n*Status:* TELAT BAYAR (${hariTelat} hari)`;
            
            // Cek tunggakan lainnya
            const tunggakanSnapshot = await db.collection('tagihan')
                .where('pelanggan_id', '==', tagihan.pelanggan_id)
                .where('status', 'in', ['telat', 'belum'])
                .get();
            
            if (tunggakanSnapshot.size > 1) {
                message += `\n*Total Tunggakan:* ${tunggakanSnapshot.size} bulan`;
            }
        }
        
        // Encode untuk URL
        const encodedMessage = encodeURIComponent(message);
        const phoneNumber = pelanggan.telepon.replace(/[^0-9]/g, '');
        
        // Buka WhatsApp
        window.open(`https://wa.me/${phoneNumber}?text=${encodedMessage}`, '_blank');
        
        // Log pengiriman
        await db.collection('aktivitas').add({
            aktivitas: `Kirim WhatsApp reminder ke ${pelanggan.nama} untuk tagihan ${tagihan.bulan}`,
            user: currentUser?.email || 'admin',
            timestamp: new Date().toISOString()
        });
        
        showToast('success', 'WhatsApp', 'Pesan siap dikirim');
        
    } catch (error) {
        console.error("Error send WhatsApp reminder:", error);
        showToast('error', 'Error', 'Gagal menyiapkan pesan WhatsApp');
    }
}






// ============================================
// START THE APPLICATION
// ============================================

// Tunggu sampai DOM sepenuhnya dimuat
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    // DOM sudah dimuat
    setTimeout(initializeApp, 100);
}

// Handle hash changes
window.addEventListener('hashchange', function() {
    const hash = window.location.hash.replace('#', '');
    const validPages = ['dashboard', 'pelanggan', 'paket', 'tagihan', 'tunggakan', 'setting', 'laporan'];
    
    if (hash && validPages.includes(hash)) {
        loadPage(hash);
    }
});








// FUNGSI CEK PERMISSION
function cekAkses(requiredRole, actionType) {
  const userRole = localStorage.getItem('userRole');
  
  // Admin bisa semua
  if (userRole === 'admin') return true;
  
  // Karyawan hanya bisa:
  if (userRole === 'karyawan') {
    // Baca semua data
    if (actionType === 'read') return true;
    
    // Hanya tagihan yang boleh create/update
    if (actionType === 'write_tagihan') return true;
    
    // Tidak boleh hapus apapun
    if (actionType === 'delete') return false;
    
    // Tidak boleh CRUD pelanggan & paket
    if (actionType === 'write_pelanggan') return false;
    if (actionType === 'write_paket') return false;
  }
  
  return false;
}

// ALIAS FUNGSI UNTUK MUDAH
function hanyaAdmin() {
  return localStorage.getItem('userRole') === 'admin';
}

function adminAtauKaryawan() {
  const role = localStorage.getItem('userRole');
  return role === 'admin' || role === 'karyawan';
}

        // Initialize modal date fields
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = moment().format('YYYY-MM-DD');
            const nextMonth = moment().add(1, 'month').format('YYYY-MM');
            
            // Set default values for modals
            const dateFields = ['prorataMulai', 'prorataAkhir', 'tanggalBayar'];
            dateFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = today;
            });
            
            const monthFields = ['generateBulan'];
            monthFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = nextMonth;
            });
            
            // Check if user is logged in
            const savedUser = localStorage.getItem('xbill_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
                
                // Load initial page
                loadPage('dashboard');
            }
        });
        
        // Encrypt data checkbox handler
        document.getElementById('encryptData')?.addEventListener('change', function() {
            const passwordSection = document.getElementById('passwordSection');
            if (this.checked) {
                passwordSection.style.display = 'block';
            } else {
                passwordSection.style.display = 'none';
            }
        });
        
        // Reminder schedule handler
        document.getElementById('reminderSchedule')?.addEventListener('change', function() {
            const customSchedule = document.getElementById('customSchedule');
            if (this.value === 'custom') {
                customSchedule.style.display = 'block';
            } else {
                customSchedule.style.display = 'none';
            }
        });
        
        console.log("X-BILL System Loaded Successfully!");
    </script>
</body>
</html>
